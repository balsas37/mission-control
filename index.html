<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Mission Control</title>
  <script>
    // Apply saved theme before paint to prevent flash
    (function(){var t=localStorage.getItem('mc-theme')||'dark';document.documentElement.setAttribute('data-theme',t);})();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ========================================
       DESIGN TOKENS
       ======================================== */
    :root {
      --bg:            #181818;
      --bg-raised:     #1e1e1e;
      --bg-card:       #232323;
      --bg-hover:      #2a2a2a;
      --border:        rgba(255,255,255,0.06);
      --border-hover:  rgba(255,255,255,0.12);
      --accent:        #ffffff;
      --accent-muted:  #aaaaaa;
      --text-1:        #e8ecf0;
      --text-2:        #888888;
      --text-3:        #555555;

      /* Status pills - soft pastel palette */
      --pill-done-bg:      rgba(100,190,100,0.14);    --pill-done-text:      #6BBF6B;
      --pill-active-bg:    rgba(100,165,215,0.14);    --pill-active-text:    #6BA8DA;
      --pill-progress-bg:  rgba(165,105,195,0.14);    --pill-progress-text:  #A86DBF;
      --pill-waiting-bg:   rgba(218,178,85,0.14);     --pill-waiting-text:   #DAB255;
      --pill-urgent-bg:    rgba(217,83,79,0.10);      --pill-urgent-text:    #D9534F;
      --pill-high-bg:      rgba(218,178,85,0.14);     --pill-high-text:      #DAB255;
      --pill-medium-bg:    rgba(100,165,215,0.14);    --pill-medium-text:    #6BA8DA;
      --pill-low-bg:       rgba(255,255,255,0.04);    --pill-low-text:       #666666;
      --pill-backlog-bg:   rgba(255,255,255,0.03);    --pill-backlog-text:   #555555;

      /* Sidebar tokens */
      --sidebar-width: 220px;
      --sidebar-collapsed: 48px;
      --sidebar-bg: #1a1a1a;
      --sidebar-transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========================================
       LIGHT MODE — OpenClaw Mission Control palette
       ======================================== */
    [data-theme="light"] {
      --bg:            #F0F2F5;
      --bg-raised:     #F5F7FA;
      --bg-card:       #FFFFFF;
      --bg-hover:      #E8E8E8;
      --border:        #E8E8E8;
      --border-hover:  #D0D0D0;
      --accent:        #3B7BF6;
      --accent-muted:  #8C8C8C;
      --text-1:        #1A1A1A;
      --text-2:        #8C8C8C;
      --text-3:        #BFBFBF;

      /* Status pills — richer on light backgrounds */
      --pill-done-bg:      rgba(82,196,26,0.12);     --pill-done-text:      #389E0D;
      --pill-active-bg:    rgba(59,123,246,0.10);    --pill-active-text:    #1D4ED8;
      --pill-progress-bg:  rgba(245,166,35,0.14);    --pill-progress-text:  #D46B08;
      --pill-waiting-bg:   rgba(212,136,6,0.12);     --pill-waiting-text:   #B45309;
      --pill-urgent-bg:    rgba(207,19,34,0.10);     --pill-urgent-text:    #CF1322;
      --pill-high-bg:      rgba(255,169,64,0.15);    --pill-high-text:      #D46B08;
      --pill-medium-bg:    rgba(89,126,247,0.12);    --pill-medium-text:    #2563EB;
      --pill-low-bg:       rgba(0,0,0,0.05);         --pill-low-text:       #6B7280;
      --pill-backlog-bg:   rgba(0,0,0,0.03);         --pill-backlog-text:   #9CA3AF;

      --sidebar-bg: #FFFFFF;
    }

    [data-theme="light"] ::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.15);
    }
    [data-theme="light"] ::-webkit-scrollbar-thumb:hover {
      background: rgba(0,0,0,0.28);
    }

    /* Kanban columns sit on page bg — give them a distinct surface */
    [data-theme="light"] .kb-column {
      background: #EBEBEE;
    }
    /* Active nav item in light mode */
    [data-theme="light"] .sidebar-nav-item.active {
      background: #3B7BF6 !important;
      color: #ffffff !important;
    }
    [data-theme="light"] .sidebar-nav-item.active svg {
      stroke: #ffffff !important;
    }
    /* Nav section labels in light mode */
    [data-theme="light"] .sidebar-section-label {
      color: #BFBFBF;
    }

    /* ========================================
       RESET & BASE
       ======================================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 16px;
      line-height: 1.3;
      font-weight: 400;
      letter-spacing: -0.015em;
      color: var(--text-1);
      background-color: var(--bg);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========================================
       SCROLLBARS
       ======================================== */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.12);
      border-radius: 999px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.25);
    }

    /* ========================================
       LAYOUT SKELETON
       ======================================== */
    .top-bar {
      position: fixed;
      top: 0;
      left: var(--sidebar-width);
      right: 0;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px 0 14px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      z-index: 100;
      transition: left var(--sidebar-transition);
    }

    body.sidebar-collapsed .top-bar {
      left: var(--sidebar-collapsed);
    }

    .content {
      margin-top: 48px;
      margin-left: var(--sidebar-width);
      padding: 24px;
      min-height: calc(100vh - 48px);
      overflow-y: auto;
      transition: margin-left var(--sidebar-transition);
    }

    body.sidebar-collapsed .content {
      margin-left: var(--sidebar-collapsed);
    }

    /* ========================================
       HEADER
       ======================================== */
    .logo {
      font-size: 18px;
      font-weight: 400;
      letter-spacing: -0.02em;
      text-transform: none;
      color: var(--text-1);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .clock {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-2);
      font-variant-numeric: tabular-nums;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .clock-time {
      color: var(--text-1);
      font-weight: 400;
    }

    .clock-date {
      color: var(--text-3);
    }

    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 999px;
      padding: 3px 10px 3px 8px;
      font-size: 12px;
      font-weight: 400;
      color: var(--text-2);
      letter-spacing: 0.04em;
    }

    .live-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--pill-done-text);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* ========================================
       LEFT SIDEBAR
       ======================================== */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: var(--sidebar-width);
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      z-index: 101;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: width var(--sidebar-transition);
    }

    body.sidebar-collapsed .sidebar {
      width: var(--sidebar-collapsed);
    }

    .sidebar-header {
      height: 48px;
      display: flex;
      align-items: center;
      padding: 0 10px 0 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      gap: 10px;
      overflow: hidden;
    }

    .sidebar-logo-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-logo-icon svg {
      width: 20px;
      height: 20px;
      fill: none;
      stroke: var(--text-1);
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .sidebar-logo-text {
      font-size: 16px;
      font-weight: 400;
      letter-spacing: -0.02em;
      color: var(--text-1);
      white-space: nowrap;
      opacity: 1;
      transition: opacity 0.15s ease;
    }

    body.sidebar-collapsed .sidebar-logo-text {
      opacity: 0;
      pointer-events: none;
    }

    .sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 8px 0;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .sidebar-nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 12px;
      height: 40px;
      margin: 1px 8px;
      cursor: pointer;
      color: var(--text-3);
      font-size: 15px;
      font-weight: 500;
      border: none;
      background: none;
      font-family: inherit;
      width: calc(100% - 16px);
      text-align: left;
      position: relative;
      border-radius: 8px;
      transition: color 0.15s ease, background 0.15s ease;
      white-space: nowrap;
      overflow: hidden;
      flex-shrink: 0;
    }

    .sidebar-nav-item:hover {
      color: var(--text-2);
      background: rgba(255,255,255,0.05);
      margin: 1px 0;
      width: 100%;
      border-radius: 0;
      padding-left: 20px;
    }

    .sidebar-nav-item.active {
      color: #fff;
      background: rgba(255,255,255,0.08);
      margin: 1px 0;
      width: 100%;
      border-radius: 0;
      padding-left: 20px;
    }

    .sidebar-nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #4A90D9;
      border-radius: 0;
    }

    .sidebar-nav-icon {
      width: 22px;
      height: 22px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 2px;
    }

    .sidebar-nav-icon svg {
      width: 20px;
      height: 20px;
      fill: none;
      stroke: currentColor;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .sidebar-nav-label {
      opacity: 1;
      transition: opacity 0.15s ease;
      flex: 1;
      overflow: hidden;
    }

    body.sidebar-collapsed .sidebar-nav-label {
      opacity: 0;
      pointer-events: none;
      width: 0;
      flex: 0;
    }

    /* Collapsed nav item: centre the icon, remove padding clipping */
    body.sidebar-collapsed .sidebar-nav-item {
      padding: 0;
      margin: 1px 4px;
      width: calc(100% - 8px);
      justify-content: center;
      gap: 0;
    }

    /* Collapsed active + hover: keep edge-to-edge */
    body.sidebar-collapsed .sidebar-nav-item.active,
    body.sidebar-collapsed .sidebar-nav-item:hover {
      margin: 1px 0;
      width: 100%;
      padding-left: 0;
      border-radius: 0;
    }

    body.sidebar-collapsed .sidebar-nav-icon {
      margin-left: 0;
    }

    body.sidebar-collapsed .sidebar-header {
      padding: 0;
      justify-content: center;
    }

    .sidebar-badge {
      background: rgba(255,255,255,0.15);
      color: #fff;
      border-radius: 999px;
      padding: 0 6px;
      font-size: 12px;
      font-weight: 400;
      min-width: 18px;
      text-align: center;
      line-height: 16px;
      flex-shrink: 0;
      transition: opacity 0.15s ease;
    }

    .sidebar-nav-item.active .sidebar-badge {
      background: rgba(255,255,255,0.3);
    }

    body.sidebar-collapsed .sidebar-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      min-width: 14px;
      font-size: 10px;
      padding: 0 4px;
      line-height: 14px;
    }

    .sidebar-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      cursor: pointer;
      color: var(--text-2);
      border-radius: 6px;
      transition: color 0.15s ease, background 0.15s ease;
      padding: 0;
      flex-shrink: 0;
    }

    .sidebar-toggle:hover {
      color: var(--text-1);
      background: rgba(255,255,255,0.06);
    }

    .sidebar-toggle svg {
      width: 18px;
      height: 18px;
      fill: none;
      stroke: currentColor;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .sidebar-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: var(--sidebar-collapsed);
        z-index: 200;
      }
      body:not(.sidebar-collapsed) .sidebar {
        width: var(--sidebar-width);
        box-shadow: 8px 0 24px rgba(0,0,0,0.5);
      }
      body:not(.sidebar-collapsed) .sidebar-logo-text,
      body:not(.sidebar-collapsed) .sidebar-nav-label,
      body:not(.sidebar-collapsed) .sidebar-badge {
        opacity: 1;
        pointer-events: auto;
      }
      .content {
        margin-left: var(--sidebar-collapsed) !important;
      }
      .top-bar {
        left: var(--sidebar-collapsed) !important;
      }
      body:not(.sidebar-collapsed) .sidebar-backdrop {
        display: block;
      }
    }

    /* ========================================
       CONTENT PANELS
       ======================================== */
    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .panel-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 48px - 48px);
      gap: 12px;
    }

    .panel-placeholder-icon {
      font-size: 40px;
      opacity: 0.3;
    }

    .panel-placeholder-title {
      font-size: 18px;
      font-weight: 400;
      color: var(--text-2);
    }

    .panel-placeholder-sub {
      font-size: 14px;
      color: var(--text-3);
    }

    /* ========================================
       REUSABLE COMPONENTS
       ======================================== */

    /* Status pills */
    .pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 400;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
      letter-spacing: 0.02em;
    }

    .pill-done     { background: var(--pill-done-bg);     color: var(--pill-done-text); }
    .pill-active   { background: var(--pill-active-bg);   color: var(--pill-active-text); }
    .pill-progress { background: var(--pill-progress-bg); color: var(--pill-progress-text); }
    .pill-waiting  { background: var(--pill-waiting-bg);  color: var(--pill-waiting-text); }
    .pill-urgent   { background: var(--pill-urgent-bg);   color: var(--pill-urgent-text); }
    .pill-high     { background: var(--pill-high-bg);     color: var(--pill-high-text); }
    .pill-medium   { background: var(--pill-medium-bg);   color: var(--pill-medium-text); }
    .pill-low      { background: var(--pill-low-bg);      color: var(--pill-low-text); }
    .pill-backlog  { background: var(--pill-backlog-bg);  color: var(--pill-backlog-text); }

    /* Count badges */
    .badge {
      background: rgba(255,255,255,0.15);
      color: #fff;
      border-radius: 999px;
      padding: 1px 7px;
      font-size: 12px;
      font-weight: 400;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
    }

    /* CTA buttons */
    .btn-cta {
      background: transparent;
      border-radius: 999px;
      padding: 10px 28px;
      font-weight: 400;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.25);
      cursor: pointer;
      font-family: inherit;
      font-size: 15px;
      transition: all 0.25s ease;
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
    }

    .btn-cta:hover {
      background: #fff;
      color: #181818;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Cards */
    .card {
      background: var(--bg-raised);
      border-radius: 14px;
      padding: 20px;
      border: 1px solid var(--border);
      transition: border-color 0.2s ease;
    }

    /* Section titles */
    .section-title {
      font-size: 20px;
      font-weight: 400;
      color: var(--text-1);
      margin-bottom: 24px;
      line-height: 1.2;
      letter-spacing: -0.02em;
    }

    .section-rule {
      border: none;
      border-top: 1px solid var(--border);
      margin-bottom: 24px;
    }

    /* Legacy section header kept for compatibility */
    .section-header {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-2);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    /* Data rows */
    .row {
      height: 40px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid var(--border);
      transition: background 0.1s;
      padding: 0 12px;
    }

    .row:hover {
      background: var(--bg-hover);
    }

    /* Active/selected state (sidebar style) */
    .selected {
      background: rgba(255,255,255,0.04);
      border-left: 3px solid #fff;
      color: var(--text-1);
    }

    /* ========================================
       COMPONENT SHOWCASE (for verification)
       ======================================== */
    .showcase {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
    }

    /* ========================================
       OFFICE TAB
       ======================================== */

    /* Stats Bar */
    .office-stats {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: nowrap;
      width: 100%;
    }
    .projects-toolbar {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .projects-toolbar .office-stats { margin-bottom: 0; flex: 0 1 auto; width: auto; }
    .projects-toolbar .view-toggle { margin-left: auto; }

    .stat-chip {
      background: var(--bg-raised);
      border-radius: 0 14px 14px 0;
      padding: 12px 16px 12px 18px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-width: 0;
      flex: 1;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .stat-chip::before {
      content: '';
      position: absolute;
      left: 0; top: 8px; bottom: 8px;
      width: 3px;
      border-radius: 0 2px 2px 0;
      background: var(--chip-accent, var(--text-3));
      opacity: 0.7;
    }
    #panel-office .stat-chip,
    #panel-projects .stat-chip {
      border-radius: 14px;
      padding: 12px 16px;
      flex: 0 0 82px;
      width: 82px;
    }
    #panel-office .stat-chip::before,
    #panel-projects .stat-chip::before { display: none; }
    #panel-office .office-stats,
    #panel-projects .office-stats { width: auto; display: inline-flex; }
    #panel-inbox .kb-metric {
      border-radius: 14px;
      padding: 12px 16px;
    }
    #panel-inbox .kb-metric::before { display: none; }

    .stat-chip-value {
      font-size: 20px;
      font-weight: 400;
      line-height: 1.2;
    }

    .stat-chip-label {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Workstation Grid */
    .office-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    @media (max-width: 960px) {
      .office-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 600px) {
      .office-grid { grid-template-columns: 1fr; }
    }

    /* Workstation Card */
    .workstation {
      background: var(--bg-raised);
      border-radius: 14px;
      padding: 20px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Terminal Monitor */
    .terminal {
      background: #111111;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 10px;
      padding: 10px;
      min-height: 80px;
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      font-size: 12px;
      line-height: 1.6;
      overflow: hidden;
    }

    .terminal.active {
      color: var(--pill-done-text);
    }

    .terminal.idle {
      color: var(--text-3);
    }

    /* Monitor Stand */
    .monitor-stand {
      width: 30px;
      height: 5px;
      background: var(--bg-raised);
      border-radius: 2px;
      margin: 0 auto;
    }

    /* Agent Info Row */
    .agent-info {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }

    /* ---- Agent Avatar System ---- */
    .agent-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 400;
      color: #fff;
      flex-shrink: 0;
      letter-spacing: 0.01em;
      line-height: 1;
      text-transform: uppercase;
      position: relative;
    }
    .agent-avatar-sm {
      width: 20px;
      height: 20px;
      font-size: 10px;
    }
    .agent-avatar-md {
      width: 24px;
      height: 24px;
      font-size: 11px;
    }
    .agent-avatar-lg {
      width: 40px;
      height: 40px;
      font-size: 15px;
      font-weight: 400;
    }
    .agent-avatar .avatar-status {
      position: absolute;
      bottom: -1px;
      right: -1px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      border: 2px solid var(--bg-raised);
    }
    .agent-avatar .avatar-status.online  { background: var(--pill-done-text); }
    .agent-avatar .avatar-status.offline { background: var(--text-3); }

    .agent-details {
      display: flex;
      flex-direction: column;
    }

    .agent-name {
      font-size: 15px;
      font-weight: 400;
      color: var(--text-1);
      margin-bottom: 3px;
    }

    .agent-role {
      font-size: 11px;
      color: var(--text-2);
      letter-spacing: 0.01em;
    }

    /* Task Bar */
    .task-bar {
      width: 100%;
      font-size: 13px;
      font-weight: 500;
      border-radius: 999px;
      padding: 4px 12px;
      text-align: center;
    }

    .task-bar.active {
      background: rgba(255,255,255,0.06);
      color: var(--text-1);
    }

    .task-bar.idle {
      background: var(--bg-raised);
      color: var(--text-3);
    }

    /* Status Footer */
    .agent-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-3);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }

    .status-dot.online {
      background: var(--pill-done-text);
    }

    .status-dot.offline {
      background: var(--text-3);
    }

    /* Animations */
    @keyframes bob {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    .workstation.active .agent-avatar {
      animation: bob 2s ease-in-out infinite;
    }

    @keyframes typewriter-cursor {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .terminal-cursor {
      display: inline-block;
      width: 7px;
      height: 13px;
      background: var(--pill-done-text);
      vertical-align: middle;
      animation: typewriter-cursor 1s step-end infinite;
    }

    /* ========================================
       TEAM TAB
       ======================================== */

    /* Idle pill variant */
    .pill-idle { background: var(--bg-raised); color: var(--text-3); }

    /* Department / section label */
    .dept-label {
      font-size: 11px;
      font-weight: 400;
      color: var(--text-1);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding-bottom: 10px;
      padding-left: 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }

    /* Team grid */
    .team-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }

    @media (max-width: 960px) {
      .team-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 600px) {
      .team-grid { grid-template-columns: 1fr; }
    }

    /* Team card */
    .team-card {
      background: var(--bg-raised);
      border-radius: 14px;
      padding: 20px;
      border: 1px solid var(--border);
      transition: border-color 0.2s ease;
    }

    .team-card:hover {
      border-color: var(--border-hover);
    }

    /* Department accent - removed colored borders, uniform style */
    .team-card.dept-command,
    .team-card.dept-ops,
    .team-card.dept-build,
    .team-card.dept-intel { border-color: var(--border); }

    .team-card.dept-command:hover,
    .team-card.dept-ops:hover,
    .team-card.dept-build:hover,
    .team-card.dept-intel:hover { border-color: var(--border-hover); }

    /* Card header */
    .team-card-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 14px;
    }

    .team-card-emoji {
      flex-shrink: 0;
    }

    .team-card-meta {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .team-card-name {
      font-size: 16px;
      font-weight: 400;
      color: var(--text-1);
      margin-bottom: 4px;
    }

    .team-card-title {
      font-size: 11px;
      color: var(--text-2);
      letter-spacing: 0.01em;
    }

    .team-card-header .pill {
      margin-left: auto;
      flex-shrink: 0;
      align-self: flex-start;
    }

    /* Responsibilities list */
    .team-card-resp {
      list-style: none;
      padding: 0;
    }

    .team-card-resp li {
      font-size: 14px;
      color: var(--text-2);
      line-height: 1.6;
    }

    .team-card-resp li::before {
      content: '\203A';
      margin-right: 7px;
      font-weight: 400;
      color: #4A90D9;
      font-size: 15px;
      line-height: 1;
    }

    /* ========================================
       PROJECTS TAB
       ======================================== */

    .projects-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    @media (max-width: 600px) {
      .projects-grid { grid-template-columns: 1fr; }
    }

    .project-card {
      background: var(--bg-raised);
      border-radius: 14px;
      padding: 20px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .project-top {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .project-priority {
      background: transparent;
      color: #fff;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 400;
      flex-shrink: 0;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .project-name {
      font-size: 16px;
      font-weight: 400;
      color: var(--text-1);
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .project-top .pill {
      margin-left: auto;
      flex-shrink: 0;
    }

    .project-desc {
      font-size: 14px;
      color: var(--text-2);
      line-height: 1.6;
    }

    .project-agents {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .agent-chip {
      background: var(--bg-raised);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 2px 10px 2px 2px;
      font-size: 13px;
      color: var(--text-2);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .project-threads {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .project-threads li {
      font-size: 14px;
      color: var(--text-2);
      line-height: 1.8;
    }

    .project-threads li::before {
      content: '\203A';
      color: #4A90D9;
      margin-right: 7px;
      font-size: 15px;
      font-weight: 400;
    }

    /* ========================================
       INBOX TAB
       ======================================== */

    /* Filter pill row */
    .inbox-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .inbox-filter {
      padding: 7px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-2);
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .inbox-filter:hover {
      color: var(--text-1);
      background: rgba(255,255,255,0.06);
      border-color: var(--border-hover);
    }

    .inbox-filter.active {
      background: rgba(255,255,255,0.1);
      color: var(--text-1);
      border: 1px solid rgba(255,255,255,0.22);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.22);
    }

    /* Two-column layout */
    .inbox-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 700px) {
      .inbox-columns { grid-template-columns: 1fr; }
    }

    .inbox-col-header {
      font-size: 15px;
      font-weight: 400;
      color: var(--text-1);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }

    /* Task row */
    .inbox-task {
      background: var(--bg-raised);
      border-radius: 0 14px 14px 0;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-left: 4px solid rgba(255,255,255,0.08);
      margin-bottom: 8px;
      cursor: pointer;
      transition: opacity 0.2s, border-color 0.2s;
    }

    .inbox-task:hover {
      border-color: var(--border-hover);
    }

    /* List card left border = STATUS colour */
    .inbox-task.status-todo       { border-left: 4px solid #6b7280; }
    .inbox-task.status-inprogress { border-left: 4px solid #6BA8DA; }
    .inbox-task.status-review     { border-left: 4px solid #A86DBF; }
    .inbox-task.status-backlog    { border-left: 4px solid #C49A35; }
    .inbox-task.status-recurring  { border-left: 4px solid #5AB8B0; }
    .inbox-task.status-completed  { border-left: 4px solid #6BBF6B; }

    .inbox-task-title {
      font-size: 15px;
      font-weight: 400;
      color: var(--text-1);
      margin-bottom: 6px;
      transition: color 0.2s;
    }

    .inbox-task-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .inbox-task-project {
      font-size: 12px;
      background: var(--bg-raised);
      border-radius: 999px;
      padding: 1px 8px;
      color: var(--text-2);
      white-space: nowrap;
      line-height: 1;
    }

    .inbox-task-desc {
      font-size: 13px;
      color: var(--text-2);
      line-height: 1.5;
      margin-bottom: 6px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .inbox-task-assignee {
      font-size: 12px;
      color: var(--text-3);
      white-space: nowrap;
      line-height: 1;
    }

    .inbox-task-meta .pill {
      flex-shrink: 0;
    }
    .task-status-select {
      margin-left: auto;
      background: var(--bg-raised);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-2);
      font-family: inherit;
      font-size: 11px;
      padding: 2px 6px;
      cursor: pointer;
      flex-shrink: 0;
      outline: none;
      transition: border-color 0.15s;
    }
    .task-status-select:hover { border-color: var(--border-hover); }
    .task-status-select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(109,74,255,0.2); }

    /* Done state */
    .inbox-task.done {
      opacity: 0.3;
    }

    .inbox-task.done .inbox-task-title {
      text-decoration: line-through;
      color: var(--text-3);
    }

    .inbox-task.done:hover { border-color: var(--border-hover); opacity: 0.5; }
    /* In Done filter - show at full opacity, already know they are done */
    #kb-list-view.filter-done .inbox-task.done { opacity: 1; }
    #kb-list-view.filter-done .inbox-task.done .inbox-task-title { text-decoration: none; color: var(--text-1); }
    #kb-list-view.filter-done .inbox-task.done:hover { opacity: 1; }

    /* ========================================
       KANBAN BOARD (inside Inbox tab)
       ======================================== */
    .kb-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .kb-view-toggle {
      display: inline-flex;
      gap: 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .kb-view-btn {
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      color: var(--text-3);
      background: transparent;
      border: none;
      border-right: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .kb-view-btn:last-child { border-right: none; }
    .kb-view-btn:hover { color: var(--text-2); }
    .kb-view-btn.active {
      background: rgba(255,255,255,0.09);
      color: var(--text-1);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.22);
    }
    .kb-view-btn:first-child.active { border-radius: 9px 0 0 9px; }
    .kb-view-btn:last-child.active  { border-radius: 0 9px 9px 0; }
    .kb-metrics {
      display: flex;
      gap: 12px;
      flex-wrap: nowrap;
      flex: 0 1 auto;
    }
    .kb-metric {
      background: var(--bg-raised);
      border-radius: 14px;
      padding: 10px 16px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex: 0 0 82px;
      width: 82px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .kb-metric::before {
      content: '';
      position: absolute;
      left: 0; top: 8px; bottom: 8px;
      width: 3px;
      border-radius: 0 2px 2px 0;
      background: var(--chip-accent, var(--text-3));
      opacity: 0.7;
    }
    .kb-metric-value {
      font-size: 20px;
      font-weight: 400;
      line-height: 1.2;
      color: var(--text-1);
    }
    .kb-metric-label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 10px;
      font-weight: 500;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-top: 2px;
    }
    .kb-board {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding-bottom: 24px;
      min-height: calc(100vh - 48px - 180px);
      align-items: flex-start;
    }
    .kb-column {
      flex: 0 0 260px;
      min-width: 260px;
      max-width: 260px;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      border-radius: 14px;
    }
    .kb-col-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }
    .kb-col-title {
      font-size: 13px;
      font-weight: 400;
      color: var(--text-2);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .kb-col-count {
      background: rgba(255,255,255,0.08);
      color: var(--text-3);
      border-radius: 999px;
      padding: 1px 7px;
      font-size: 12px;
      font-weight: 400;
      min-width: 18px;
      text-align: center;
    }
    .kb-col-add {
      background: none;
      border: none;
      color: var(--text-3);
      font-size: 18px;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
      font-family: inherit;
      transition: color 0.2s;
      margin-left: auto;
    }
    .kb-col-add:hover { color: var(--text-1); }
    .kb-card-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 60px;
      padding: 4px 4px 12px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .kb-card-list.drag-over {
      background: rgba(255,255,255,0.03);
      outline: 1px dashed rgba(255,255,255,0.12);
      outline-offset: -1px;
      border-radius: 8px;
    }
    .kb-card {
      background: var(--bg-raised);
      border-radius: 0 14px 14px 0;
      padding: 16px 18px;
      border: 1px solid var(--border);
      border-left: none;
      cursor: grab;
      transition: border-color 0.2s, opacity 0.2s, transform 0.15s;
      user-select: none;
    }
    .kb-card:hover { border-color: var(--border-hover); }
    .kb-card:active { cursor: grabbing; }
    .kb-card.dragging { opacity: 0.4; transform: scale(0.97); }
    @keyframes kbCardDrop {
      from { opacity: 0; transform: translateY(-8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .kb-card.just-dropped { animation: kbCardDrop 200ms ease-out; }
    .kb-card-title {
      font-size: 15px;
      font-weight: 400;
      color: var(--text-1);
      line-height: 1.35;
      margin-bottom: 6px;
    }
    .kb-card-desc {
      font-size: 12px;
      color: var(--text-3);
      line-height: 1.4;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .kb-card-footer {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .kb-card-project {
      font-size: 11px;
      background: var(--bg-card);
      border-radius: 999px;
      padding: 2px 8px;
      color: var(--text-2);
      white-space: nowrap;
      cursor: pointer;
      border: 1px solid transparent;
      transition: border-color 0.2s;
      position: relative;
    }
    .kb-card-project:hover { border-color: var(--border-hover); }
    .kb-card-project-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 4px 0;
      z-index: 50;
      min-width: 160px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }
    .kb-card-project-dropdown-item {
      padding: 6px 12px;
      font-size: 13px;
      color: var(--text-2);
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    .kb-card-project-dropdown-item:hover {
      background: rgba(255,255,255,0.06);
      color: var(--text-1);
    }
    .kb-card-project-dropdown-item.selected {
      color: var(--text-1);
      font-weight: 400;
    }
    .kb-card-agent {
      font-size: 12px;
      color: var(--text-3);
      white-space: nowrap;
    }
    /* Card left border = STATUS colour */
    .kb-card[data-status="todo"]       { border-left: 4px solid #6b7280; border-top-left-radius: 0; border-bottom-left-radius: 0; }
    .kb-card[data-status="inprogress"] { border-left: 4px solid #6BA8DA; border-top-left-radius: 0; border-bottom-left-radius: 0; }
    .kb-card[data-status="review"]     { border-left: 4px solid #A86DBF; border-top-left-radius: 0; border-bottom-left-radius: 0; }
    .kb-card[data-status="backlog"]    { border-left: 4px solid #C49A35; border-top-left-radius: 0; border-bottom-left-radius: 0; }
    .kb-card[data-status="recurring"]  { border-left: 4px solid #5AB8B0; border-top-left-radius: 0; border-bottom-left-radius: 0; }
    .kb-card[data-status="completed"]  { border-left: 4px solid #6BBF6B; border-top-left-radius: 0; border-bottom-left-radius: 0; }
    .kb-form {
      background: var(--bg-card);
      border: 1px solid var(--border-hover);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .kb-form-input,
    .kb-form-textarea,
    .kb-form-select {
      appearance: none;
      -webkit-appearance: none;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      color: var(--text-1);
      width: 100%;
      transition: border-color 0.2s;
    }
    .kb-form-input:focus,
    .kb-form-textarea:focus,
    .kb-form-select:focus {
      outline: none;
      border-color: rgba(255,255,255,0.3);
    }
    .kb-form-input::placeholder,
    .kb-form-textarea::placeholder { color: var(--text-3); }
    .kb-form-textarea {
      resize: vertical;
      min-height: 48px;
      max-height: 100px;
    }
    .kb-form-select {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888888' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 28px;
    }
    .kb-form-select option { background: var(--bg-card); color: var(--text-1); }
    .kb-form-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }
    .kb-form-save, .kb-form-cancel {
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 400;
      font-family: inherit;
      cursor: pointer;
      border: none;
      transition: background 0.2s, color 0.2s;
    }
    .kb-form-save { background: #fff; color: #181818; }
    .kb-form-save:hover { background: #e0e0e0; }
    .kb-form-cancel { background: transparent; color: var(--text-3); border: 1px solid var(--border); }
    .kb-form-cancel:hover { color: var(--text-2); border-color: var(--border-hover); }
    .kb-list-hidden { display: none !important; }
    @media (max-width: 960px) {
      .kb-column { flex: 0 0 220px; min-width: 220px; max-width: 220px; }
    }
    @media (max-width: 600px) {
      .kb-board { gap: 12px; }
      .kb-column { flex: 0 0 85vw; min-width: 85vw; max-width: 85vw; }
    }

    /* ========================================
       ANALYTICS TAB
       ======================================== */

    /* Date range filter */
    .analytics-filters {
      display: inline-flex;
      gap: 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .analytics-filter {
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      color: var(--text-3);
      background: transparent;
      border: none;
      border-right: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }

    .analytics-filter:last-child {
      border-right: none;
    }

    .analytics-filter:hover { color: var(--text-2); }

    .analytics-filter.active {
      background: rgba(255,255,255,0.09);
      color: var(--text-1);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.22);
    }
    .analytics-filter:first-child.active { border-radius: 9px 0 0 9px; }
    .analytics-filter:last-child.active { border-radius: 0 9px 9px 0; }

    /* Airtable-style Analytics Tables */
    .analytics-section { margin-bottom: 40px; }
    .analytics-section-header {
      display: flex; align-items: center; gap: 10px;
      cursor: pointer; user-select: none;
      padding-bottom: 12px; margin-bottom: 0;
    }
    .analytics-chevron {
      width: 16px; height: 16px;
      transition: transform 0.2s ease; color: var(--text-3);
    }
    .analytics-section-header.collapsed .analytics-chevron { transform: rotate(-90deg); }
    .analytics-section-title {
      font-size: 11px; font-weight: 400; color: var(--text-1);
      text-transform: uppercase; letter-spacing: 0.08em;
      padding-left: 0; position: relative;
    }
    .analytics-table-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--bg-raised);
    }

    /* Model usage bars */
    .usage-provider { margin-bottom: 22px; }
    .usage-provider:last-child { margin-bottom: 0; }
    .usage-provider-header {
      display: flex; align-items: baseline; gap: 10px; margin-bottom: 12px;
    }
    .usage-provider-name { font-size: 14px; font-weight: 500; color: var(--text-1); }
    .usage-provider-plan { font-size: 12px; color: var(--text-3); }
    .usage-row { margin-bottom: 10px; }
    .usage-row-label {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 12px; color: var(--text-3); margin-bottom: 4px;
    }
    .usage-row-label-left { font-weight: 500; color: var(--text-2); }
    .usage-row-label-right { font-variant-numeric: tabular-nums; }
    .usage-bar-track {
      height: 6px; border-radius: 999px; background: rgba(255,255,255,0.07);
      overflow: hidden;
    }
    .usage-bar-fill {
      height: 100%; border-radius: 999px;
      transition: width 0.6s ease;
    }
    .usage-bar-fill.anthropic { background: linear-gradient(90deg, #6BA8DA, #A78BFA); }
    .usage-bar-fill.kimi      { background: linear-gradient(90deg, #F59E0B, #F97316); }
    .usage-reset-row {
      display: flex; gap: 20px; margin-top: 6px;
      font-size: 11px; color: var(--text-3);
    }
    .usage-divider {
      height: 1px; background: var(--border); margin: 16px 0;
    }
    .usage-cost-badge {
      display: inline-block; padding: 2px 8px; border-radius: 999px;
      background: rgba(249,115,22,0.12); color: #F97316;
      font-size: 11px; font-weight: 500; margin-left: 6px;
    }
    .analytics-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .analytics-th {
      position: sticky; top: 0;
      background: var(--bg-card);
      font-size: 12px; font-weight: 400; color: var(--text-3);
      text-transform: uppercase; letter-spacing: 0.04em;
      text-align: left; padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer; user-select: none; white-space: nowrap;
    }
    .analytics-th:hover { color: var(--text-2); }
    .analytics-th .sort-arrow {
      display: inline-block; margin-left: 4px; font-size: 11px; opacity: 0.3;
    }
    .analytics-th.sorted .sort-arrow { opacity: 1; }
    .analytics-row { transition: background 0.15s ease; }
    .analytics-row:nth-child(even) { background: rgba(255,255,255,0.015); }
    .analytics-row:hover { background: rgba(255,255,255,0.04); }
    .analytics-td {
      padding: 12px 16px; border-bottom: 1px solid var(--border);
      color: var(--text-2); vertical-align: middle; font-size: 14px;
    }
    .analytics-td:first-child { font-weight: 400; color: var(--text-1); }
    .analytics-td-value { font-size: 14px; font-weight: 400; font-variant-numeric: tabular-nums; color: var(--text-2); }
    .analytics-td-change { font-size: 14px; font-weight: 400; display: inline-flex; align-items: center; gap: 4px; }
    .analytics-td-change.positive { color: var(--pill-done-text); }
    .analytics-td-change.negative { color: var(--pill-urgent-text); }
    .analytics-td-change.neutral  { color: var(--text-3); }
    .analytics-status-dot {
      width: 8px; height: 8px; border-radius: 50%; display: inline-block;
    }
    .analytics-status-dot.green  { background: var(--pill-done-text); }
    .analytics-status-dot.amber  { background: var(--pill-waiting-text); }
    .analytics-status-dot.red    { background: var(--pill-urgent-text); }
    .analytics-sparkline-cell { width: 80px; height: 24px; }
    .analytics-sparkline-cell svg {
      width: 80px; height: 24px;
    }
    .analytics-sparkline-cell svg polyline {
      fill: none; stroke: rgba(255,255,255,0.3); stroke-width: 1.5;
      stroke-linecap: round; stroke-linejoin: round;
    }
    .analytics-inline-progress {
      width: 60px; height: 4px; background: rgba(255,255,255,0.06);
      border-radius: 4px; overflow: hidden; display: inline-block;
      vertical-align: middle; margin-left: 8px;
    }
    .analytics-inline-progress-fill { height: 100%; border-radius: 4px; background: rgba(255,255,255,0.4); }
    .analytics-summary-row { background: rgba(255,255,255,0.03); border-top: 2px solid var(--border); }
    .analytics-summary-row .analytics-td { font-weight: 400; color: var(--text-1); font-size: 14px; border-bottom: none; }

    /* ========================================
       REUSABLE DATA TABLE + VIEW TOGGLE
       ======================================== */
    .view-toggle-toolbar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 16px;
    }
    .view-toggle {
      display: inline-flex;
      gap: 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .view-toggle-btn {
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      color: var(--text-3);
      background: transparent;
      border: none;
      border-right: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .view-toggle-btn:last-child { border-right: none; }
    .view-toggle-btn:hover { color: var(--text-2); }
    .view-toggle-btn.active {
      background: rgba(255,255,255,0.09);
      color: var(--text-1);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.22);
    }
    .view-toggle-btn:first-child.active { border-radius: 9px 0 0 9px; }
    .view-toggle-btn:last-child.active { border-radius: 0 9px 9px 0; }

    .data-table-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--bg-raised);
    }
    .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .data-th {
      background: var(--bg-card);
      font-size: 12px; font-weight: 400; color: var(--text-3);
      text-transform: uppercase; letter-spacing: 0.04em;
      text-align: left; padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    .data-row { transition: background 0.15s ease; }
    .data-row:nth-child(even) { background: rgba(255,255,255,0.015); }
    .data-row:hover { background: rgba(255,255,255,0.04); }
    .data-td {
      padding: 12px 16px; border-bottom: 1px solid var(--border);
      color: var(--text-1); vertical-align: middle;
    }
    .data-td:first-child { font-weight: 400; }
    .data-row:last-child .data-td { border-bottom: none; }

    /* Workstation actions */
    .workstation-actions {
      display: flex; gap: 8px; margin-top: 4px;
    }
    .workstation-action {
      flex: 1;
      padding: 6px 0;
      font-size: 12px;
      font-weight: 500;
      font-family: inherit;
      color: var(--text-3);
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }
    .workstation-action:hover {
      background: rgba(255,255,255,0.04);
      color: var(--text-2);
      border-color: var(--border-hover);
    }

    /* Active workstation glow */
    .workstation.active {
      border-color: rgba(92,184,92,0.25);
      box-shadow: 0 0 0 1px rgba(92,184,92,0.08);
    }

    /* ========================================
       CALENDAR TAB
       ======================================== */

    /* Milestone Timeline Strip */
    .milestone-strip {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 16px 0;
      position: relative;
      align-items: center;
      margin-bottom: 32px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.12) transparent;
    }

    .milestone-strip::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      border-top: 1px dashed rgba(255,255,255,0.08);
      z-index: 0;
    }

    /* Milestone Card */
    .milestone-card {
      background: var(--bg-raised);
      border: 1px solid var(--border);
      border-left: 5px solid var(--text-3);
      border-radius: 0 14px 14px 0;
      padding: 18px 20px;
      min-width: 200px;
      flex-shrink: 0;
      position: relative;
      z-index: 1;
      transition: border-color 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .milestone-card:hover {
      border-top-color: var(--border-hover);
      border-right-color: var(--border-hover);
      border-bottom-color: var(--border-hover);
    }

    .milestone-card.cat-life     { border-left-color: #5BC0DE; }
    .milestone-card.cat-personal { border-left-color: #9B59B6; }
    .milestone-card.cat-business { border-left-color: #5B9BD5; }
    .milestone-card.cat-property { border-left-color: #D4A843; }
    .milestone-card.cat-farm     { border-left-color: #5CB85C; }

    .milestone-cat-label {
      font-size: 11px;
      font-weight: 400;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-3);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .milestone-cat-icon {
      font-size: 13px;
      line-height: 1;
    }

    .milestone-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
      vertical-align: middle;
    }

    .milestone-dot.cat-personal { background: var(--text-2); }
    .milestone-dot.cat-business { background: var(--text-1); }
    .milestone-dot.cat-property { background: var(--text-2); }
    .milestone-dot.cat-farm     { background: var(--text-3); }

    .milestone-name {
      font-size: 16px;
      font-weight: 400;
      color: var(--text-1);
      margin-top: 0;
      line-height: 1.3;
      letter-spacing: -0.01em;
    }

    .milestone-date {
      font-size: 13px;
      color: var(--text-2);
      margin-top: 0;
      font-weight: 500;
    }

    /* Calendar Toolbar */
    .cal-toolbar {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px; flex-wrap: wrap; gap: 12px;
    }
    .cal-toolbar-left { display: flex; align-items: center; gap: 14px; }
    .cal-toolbar-right { display: flex; align-items: center; gap: 10px; }
    .cal-title {
      font-size: 11px; font-weight: 400; color: var(--text-1);
      text-transform: uppercase; letter-spacing: 0.08em;
      margin: 0; min-width: 160px;
    }
    .cal-nav-arrows {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .cal-nav-btn {
      padding: 6px 10px; font-size: 18px; font-family: inherit; line-height: 1;
      color: var(--text-3); background: transparent;
      border: none; border-right: 1px solid var(--border);
      cursor: pointer; transition: background 0.2s, color 0.2s;
    }
    .cal-nav-btn:last-child { border-right: none; }
    .cal-nav-btn:hover { color: var(--text-2); background: var(--bg-hover); }
    .cal-today-btn { font-size: 13px; font-weight: 400; padding: 6px 14px; }
    .cal-view-toggle {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .cal-view-btn {
      padding: 6px 14px; font-size: 13px; font-weight: 500;
      font-family: inherit; color: var(--text-3);
      background: transparent; border: none;
      cursor: pointer; transition: background 0.2s, color 0.2s;
    }
    .cal-view-btn:hover { color: var(--text-2); }
    .cal-view-btn.active { background: rgba(255,255,255,0.09); color: var(--text-1); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.22); }
    .cal-view-btn:first-child.active { border-radius: 9px 0 0 9px; }
    .cal-view-btn:last-child.active { border-radius: 0 9px 9px 0; }
    .cal-view-btn:not(:last-child) { border-right: 1px solid var(--border); }

    /* Month view: week-row structure for spanning booking bars */
    .cal-month-wrap { display: flex; flex-direction: column; }
    .cal-month-headers { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .cal-week-row { display: flex; flex-direction: column; margin-bottom: 8px; }
    .cal-week-cells { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .cal-week-bars { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; min-height: 0; }
    .cal-week-bar-item {
      height: 20px; border-radius: 4px; font-size: 10px; font-weight: 500;
      padding: 0 6px; display: flex; align-items: center; overflow: hidden;
      white-space: nowrap; cursor: pointer; transition: opacity 0.15s;
    }
    .cal-week-bar-item:hover { opacity: 0.75; }
    /* Week view: all-day bar band */
    .cal-week-allday-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; min-height: 0; margin-bottom: 8px; }
    /* Booking detail popup */
    .cal-booking-popup {
      position: fixed; z-index: 1000; background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 12px; padding: 14px 16px; min-width: 200px; max-width: 260px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25); font-size: 13px;
    }
    .cal-booking-popup-title { font-weight: 600; color: var(--text-1); margin-bottom: 8px; font-size: 14px; }
    .cal-booking-popup-row { display: flex; gap: 6px; color: var(--text-2); padding: 3px 0; font-size: 12px; }
    .cal-booking-popup-close {
      position: absolute; top: 10px; right: 12px; background: none; border: none;
      color: var(--text-3); cursor: pointer; font-size: 16px; padding: 2px; line-height: 1;
    }

    /* Month View Grid */
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .cal-header {
      font-size: 13px; font-weight: 400; color: var(--text-3);
      text-transform: uppercase; letter-spacing: 0.05em; text-align: center; padding: 10px 0;
    }
    .cal-day {
      min-height: 96px; border: 1px solid var(--border); border-radius: 12px;
      padding: 8px; font-size: 14px; color: var(--text-2);
      position: relative; cursor: pointer; transition: border-color 0.2s, background 0.2s;
      display: flex; flex-direction: column; gap: 4px;
      overflow: hidden; min-width: 0;
    }
    .cal-day:hover { border-color: var(--border-hover); background: var(--bg-hover); }
    .cal-day.today { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.15); }
    .cal-day.today .cal-day-num {
      background: #fff; color: #181818; width: 26px; height: 26px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 400;
    }
    .cal-day.other-month { opacity: 0.3; }
    .cal-day.empty { border-color: transparent; min-height: 0; cursor: default; pointer-events: none; }
    .cal-day-num { font-size: 15px; font-weight: 400; line-height: 1; }
    .cal-event-chip {
      font-size: 12px; font-weight: 500; padding: 2px 6px; border-radius: 4px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      cursor: pointer; transition: opacity 0.2s; line-height: 1.4;
    }
    .cal-event-chip:hover { opacity: 0.7; }
    .cal-day-overflow { font-size: 11px; color: var(--text-3); font-weight: 500; padding-top: 2px; }
    /* Lagoon booking chip — event-chip style inside day cell */
    .cal-lagoon-day-chip {
      font-size: 12px; font-weight: 500; padding: 2px 6px; border-radius: 0 4px 4px 0;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      cursor: pointer; transition: opacity 0.2s; line-height: 1.4;
      background: rgba(255,179,71,0.18); color: #D46B08;
      border-left: 3px solid #D46B08;
    }
    .cal-lagoon-day-chip:hover { opacity: 0.7; }
    /* Lagoon chip inside week view day column */
    .cal-lagoon-week-chip {
      background: rgba(255,179,71,0.18) !important;
      color: #D46B08 !important;
      border-left-color: #D46B08 !important;
    }
    .cal-milestone-marker {
      width: 8px; height: 8px; position: absolute; top: 8px; right: 8px;
      transform: rotate(45deg); border-radius: 2px;
    }

    /* Week View */
    .cal-week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .cal-week-col {
      border: 1px solid var(--border); border-radius: 12px; padding: 10px;
      display: flex; flex-direction: column; gap: 6px; min-height: 200px;
      cursor: pointer; transition: border-color 0.2s, background 0.2s;
    }
    .cal-week-col:hover { border-color: var(--border-hover); background: var(--bg-hover); }
    .cal-week-col.today { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.15); }
    .cal-week-col-header {
      text-align: center; padding-bottom: 8px; border-bottom: 1px solid var(--border); margin-bottom: 6px;
      min-height: 64px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
    }
    .cal-week-day-name {
      font-size: 12px; font-weight: 400; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.05em;
    }
    .cal-week-day-num { font-size: 22px; font-weight: 300; color: var(--text-2); margin-top: 4px; }
    .cal-week-col.today .cal-week-day-num {
      background: #fff; color: #181818; width: 34px; height: 34px;
      border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: 500; margin: 0 auto;
    }
    .cal-week-event {
      background: rgba(255,255,255,0.05); border-left: 3px solid var(--text-3);
      border-radius: 0 8px 8px 0; padding: 7px 10px; font-size: 12px; font-weight: 500;
      color: var(--text-1); cursor: pointer; transition: opacity 0.2s; line-height: 1.3;
    }
    .cal-week-event:hover { opacity: 0.7; }
    .cal-week-event-time { font-size: 11px; color: var(--text-3); margin-top: 2px; }

    /* Add-Event Modal */
    .cal-modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
      display: flex; align-items: center; justify-content: center;
      animation: calModalFadeIn 150ms ease;
    }
    @keyframes calModalFadeIn { from { opacity: 0; } to { opacity: 1; } }
    .cal-modal {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px;
      width: 340px; max-width: 90vw; box-shadow: 0 16px 48px rgba(0,0,0,0.4);
      animation: calModalSlideUp 200ms ease;
    }
    @keyframes calModalSlideUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    .cal-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px 12px; border-bottom: 1px solid var(--border);
    }
    .cal-modal-title { font-size: 16px; font-weight: 400; color: var(--text-1); }
    .cal-modal-close {
      background: none; border: none; color: var(--text-3); font-size: 20px;
      cursor: pointer; padding: 0; line-height: 1; transition: color 0.2s;
    }
    .cal-modal-close:hover { color: var(--text-1); }
    .cal-modal-body { padding: 16px 20px; display: flex; flex-direction: column; gap: 10px; }
    .cal-form-input {
      appearance: none; -webkit-appearance: none;
      background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
      padding: 10px 12px; font-size: 14px; font-family: 'Inter', sans-serif;
      color: var(--text-1); width: 100%; transition: border-color 0.2s;
    }
    .cal-form-input:focus { outline: none; border-color: rgba(255,255,255,0.3); }
    .cal-form-input::placeholder { color: var(--text-3); }
    .cal-color-picker { display: flex; gap: 8px; padding: 4px 0; }
    .cal-color-swatch {
      width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
      border: 2px solid transparent; transition: border-color 0.2s, transform 0.15s;
    }
    .cal-color-swatch:hover { transform: scale(1.15); }
    .cal-color-swatch.selected { border-color: #fff; transform: scale(1.1); }
    .cal-modal-footer {
      display: flex; gap: 8px; justify-content: flex-end;
      padding: 12px 20px 16px; border-top: 1px solid var(--border);
    }
    .cal-form-save, .cal-form-cancel {
      padding: 8px 18px; border-radius: 8px; font-size: 14px; font-weight: 400;
      font-family: inherit; cursor: pointer; border: none; transition: background 0.2s, color 0.2s;
    }
    .cal-form-save { background: #fff; color: #181818; }
    .cal-form-save:hover { background: #e0e0e0; }
    .cal-form-cancel { background: transparent; color: var(--text-3); border: 1px solid var(--border); }
    .cal-form-cancel:hover { color: var(--text-2); border-color: var(--border-hover); }

    @media (max-width: 768px) {
      .cal-toolbar { flex-direction: column; align-items: flex-start; }
      .cal-toolbar-right { align-self: flex-end; }
      .cal-grid { gap: 4px; }
      .cal-day { min-height: 64px; padding: 5px; }
      .cal-day-num { font-size: 13px; }
      .cal-event-chip, .cal-lagoon-day-chip {
        white-space: normal; word-break: break-word; font-size: 10px;
        text-overflow: clip;
      }
      .cal-week-grid { grid-template-columns: repeat(7, minmax(90px, 1fr)); overflow-x: auto; gap: 6px; }
      .cal-week-col { min-height: 140px; padding: 8px; }

      /* Inbox toolbar: centered pills, toggle pinned top-right */
      .kb-toolbar { position: relative; align-items: flex-start; }
      .kb-metrics { width: 100%; justify-content: center; padding-right: 90px; }
      .inbox-filters { width: 100%; justify-content: center; }
      .kb-view-toggle { position: absolute; top: 0; right: 0; }
    }

    /* ========================================
       FOCUS TAB
       ======================================== */

    .focus-wrap {
      max-width: 640px;
    }

    /* Project selector dropdown */
    .focus-select {
      appearance: none;
      -webkit-appearance: none;
      background: var(--bg-card) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888888' stroke-width='1.5' fill='none'/%3E%3C/svg%3E") no-repeat right 14px center;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 40px 10px 14px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      color: var(--text-1);
      cursor: pointer;
      margin-bottom: 28px;
      min-width: 240px;
    }

    .focus-select:focus {
      outline: none;
      border-color: #fff;
    }

    .focus-select option {
      background: var(--bg-card);
      color: var(--text-1);
    }

    /* Project header */
    .focus-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .focus-title {
      font-size: 22px;
      font-weight: 400;
      color: var(--text-1);
    }

    /* Agent chips row */
    .focus-agents {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 24px;
    }

    /* Priority callout */
    .focus-priority {
      background: rgba(255,255,255,0.03);
      border-left: 4px solid rgba(255,255,255,0.3);
      border-radius: 0 14px 14px 0;
      padding: 14px 16px;
      margin-bottom: 24px;
      font-size: 15px;
      font-weight: 400;
      color: var(--text-1);
      line-height: 1.5;
    }

    /* Task checklist */
    .focus-tasks {
      list-style: none;
      padding: 0;
      margin-bottom: 24px;
    }

    .focus-task {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      cursor: pointer;
      user-select: none;
    }

    .focus-check {
      display: none;
    }

    .focus-checkmark {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, border-color 0.2s;
    }

    .focus-checkmark::after {
      content: '';
      display: none;
      width: 8px;
      height: 5px;
      border-left: 2px solid #181818;
      border-bottom: 2px solid #181818;
      transform: rotate(-45deg);
      margin-top: -2px;
    }

    .focus-check:checked + .focus-checkmark {
      background: #fff;
      border-color: #fff;
    }

    .focus-check:checked + .focus-checkmark::after {
      display: block;
    }

    .focus-task-text {
      font-size: 15px;
      color: var(--text-1);
      transition: color 0.2s;
    }

    .focus-check:checked ~ .focus-task-text {
      text-decoration: line-through;
      color: var(--text-3);
    }

    /* Context block */
    .focus-context {
      font-size: 14px;
      color: var(--text-2);
      line-height: 1.6;
      padding-left: 14px;
      border-left: 1px solid var(--border);
      margin-bottom: 28px;
    }

    /* Focus milestones strip */
    .focus-milestones {
      display: flex;
      gap: 0;
      flex-wrap: wrap;
    }

    .focus-milestone {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px 8px 0;
      border-right: 1px solid var(--border);
      margin-right: 16px;
    }

    .focus-milestone:last-child {
      border-right: none;
      margin-right: 0;
      padding-right: 0;
    }

    .focus-ms-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .focus-ms-label {
      font-size: 14px;
      color: var(--text-2);
    }

    /* ── Memory tab ── */
    .mem-wrap {
      max-width: 720px;
    }
    .mem-search-wrap {
      position: relative;
      margin-bottom: 28px;
    }
    .mem-search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      pointer-events: none;
      opacity: 0.4;
    }
    .mem-search {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 14px 14px 40px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      color: var(--text-1);
      box-sizing: border-box;
    }
    .mem-search::placeholder {
      color: var(--text-3);
    }
    .mem-search:focus {
      outline: none;
      border-color: #fff;
    }
    .mem-section {
      margin-bottom: 16px;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    .mem-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      background: var(--bg-raised);
      cursor: pointer;
      user-select: none;
    }
    .mem-section-header:hover {
      background: var(--bg-card);
    }
    .mem-section-title {
      font-size: 15px;
      font-weight: 400;
      text-transform: none;
      letter-spacing: -0.01em;
      color: var(--text-1);
    }
    .mem-chevron {
      width: 16px;
      height: 16px;
      transition: transform 0.25s ease;
      opacity: 0.5;
    }
    .mem-section.open .mem-chevron {
      transform: rotate(180deg);
    }
    .mem-section-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.35s ease;
    }
    .mem-section.open .mem-section-body {
      max-height: 2000px;
    }
    .mem-section-inner {
      padding: 16px;
    }
    .mem-people-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 600px) {
      .mem-people-grid { grid-template-columns: 1fr; }
    }
    .mem-person {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      transition: opacity 0.2s, border-color 0.2s;
    }
    .mem-person-name {
      font-size: 15px;
      font-weight: 400;
      color: var(--text-1);
      margin-bottom: 4px;
    }
    .mem-person-role {
      font-size: 13px;
      font-style: italic;
      color: var(--text-2);
      margin-bottom: 8px;
    }
    .mem-person-detail {
      font-size: 14px;
      color: var(--text-2);
      line-height: 1.5;
    }
    .mem-facts {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .mem-fact {
      display: flex;
      align-items: baseline;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      transition: opacity 0.2s, border-color 0.2s;
    }
    .mem-fact-label {
      font-size: 14px;
      font-weight: 400;
      color: var(--text-1);
      white-space: nowrap;
      min-width: 140px;
    }
    .mem-fact-value {
      font-size: 14px;
      color: var(--text-2);
      line-height: 1.5;
    }
    .mem-decisions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .mem-decision {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      transition: opacity 0.2s, border-color 0.2s;
    }
    .mem-decision-title {
      font-size: 15px;
      font-weight: 400;
      color: var(--text-1);
      margin-bottom: 6px;
    }
    .mem-decision-text {
      font-size: 14px;
      color: var(--text-2);
      line-height: 1.6;
    }
    .mem-contacts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 600px) {
      .mem-contacts-grid { grid-template-columns: 1fr; }
    }
    .mem-contact-empty {
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 24px 14px;
      text-align: center;
      transition: opacity 0.2s, border-color 0.2s;
    }
    .mem-contact-plus {
      font-size: 22px;
      color: var(--text-3);
      margin-bottom: 6px;
    }
    .mem-contact-label {
      font-size: 13px;
      color: var(--text-3);
    }
    .mem-card-dim {
      opacity: 0.15 !important;
    }

    /* ── Polish: Tab transitions ── */
    @keyframes tabExit {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(4px); }
    }
    @keyframes tabEnter {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .tab-panel.tab-exit {
      animation: tabExit 180ms ease-out forwards;
    }
    .tab-panel.tab-enter {
      animation: tabEnter 180ms ease-out;
    }

    /* ── Polish: Keyboard shortcut tooltip ── */
    .shortcut-hint {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 16px;
      font-size: 13px;
      color: var(--text-3);
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 200;
      pointer-events: none;
    }
    .shortcut-hint.visible {
      opacity: 1;
    }

    /* ── Polish: Badge pop animation ── */
    @keyframes badgePop {
      0% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .sidebar-badge.pop {
      animation: badgePop 150ms ease-out;
    }

    /* ── Polish: Global interactive transitions ── */
    .project-card,
    .milestone-card,
    .mem-person,
    .mem-fact,
    .mem-decision,
    .mem-contact-empty,
    .workstation,
    .team-card,
    .inbox-task,
    .kb-card {
      transition: border-color 0.2s ease, transform 0.2s ease, background 0.2s ease;
    }

    /* ── Polish: Card hover states - subtle lift + brightness ── */
    .project-card:hover,
    .mem-person:hover,
    .mem-fact:hover,
    .mem-decision:hover,
    .workstation:hover,
    .team-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-1px);
      background: color-mix(in srgb, var(--bg-raised), #fff 2%);
    }
    .inbox-task:hover {
      transform: translateY(-1px);
    }
    .mem-contact-empty:hover {
      border-color: var(--border-hover);
    }

    /* ── Scroll reveal animations ── */
    .reveal {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }
    .revealed {
      opacity: 1;
      transform: translateY(0);
    }

    /* ── Polish: Focus states (accessibility) ── */
    .sidebar-nav-item:focus-visible,
    .sidebar-toggle:focus-visible,
    .btn-cta:focus-visible,
    .inbox-filter:focus-visible,
    .analytics-filter:focus-visible,
    .inbox-task:focus-visible,
    .project-card:focus-visible,
    .team-card:focus-visible,
    /* ========================================
       TASK DETAIL MODAL
       ======================================== */
    .task-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 8000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(2px);
      animation: tmFadeIn 0.15s ease;
    }
    @keyframes tmFadeIn { from { opacity:0; } to { opacity:1; } }
    .task-modal {
      background: var(--bg-card);
      border: 1px solid var(--border-hover);
      border-radius: 16px;
      width: 100%;
      max-width: 560px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 24px 64px rgba(0,0,0,0.6);
      animation: tmSlideUp 0.18s cubic-bezier(0.4,0,0.2,1);
      overflow: hidden;
    }
    @keyframes tmSlideUp { from { transform:translateY(16px);opacity:0; } to { transform:translateY(0);opacity:1; } }
    .task-modal-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 20px 20px 16px;
      border-bottom: 1px solid var(--border);
    }
    .task-modal-status-bar {
      width: 4px;
      border-radius: 4px;
      flex-shrink: 0;
      align-self: stretch;
      min-height: 24px;
    }
    .task-modal-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-1);
      line-height: 1.4;
      flex: 1;
    }
    .task-modal-close {
      background: transparent;
      border: none;
      color: var(--text-3);
      font-size: 20px;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
      flex-shrink: 0;
      transition: color 0.15s;
    }
    .task-modal-close:hover { color: var(--text-1); }
    .task-modal-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
    }
    .task-modal-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
      color: var(--text-2);
      background: var(--bg-hover);
      border-radius: 6px;
      padding: 4px 10px;
    }
    .task-modal-meta-label {
      color: var(--text-3);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .task-modal-body {
      padding: 16px 20px 20px;
      overflow-y: auto;
      flex: 1;
    }
    .task-modal-desc-label {
      font-size: 10px;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 8px;
    }
    .task-modal-desc {
      font-size: 14px;
      color: var(--text-2);
      line-height: 1.7;
      white-space: pre-wrap;
    }
    .task-modal-dates {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .task-modal-date-chip {
      font-size: 12px;
      color: var(--text-2);
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
    }
    .task-modal-date-chip span { color: var(--text-3); font-size: 10px; text-transform: uppercase; margin-right: 4px; }
    @media (max-width: 600px) {
      .task-modal { max-height: 90vh; border-radius: 12px; }
    }
    .milestone-card:focus-visible,
    .workstation:focus-visible,
    .mem-section-header:focus-visible,
    .focus-task:focus-visible,
    .focus-select:focus-visible,
    .mem-search:focus-visible,
    .cal-day:focus-visible {
      outline: 1px solid rgba(255,255,255,0.4);
      outline-offset: 2px;
    }

    /* ========================================
       TIMELINE VIEW
       ======================================== */
    #cal-timeline {
      padding: 0 0 40px 0;
      touch-action: pan-y; /* allow JS to handle pinch/horizontal gestures */
    }
    .tl-wrap {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.12) transparent;
    }
    .tl-inner {
      min-width: 700px;
      padding-bottom: 16px;
    }
    .tl-row {
      display: flex;
      align-items: center;
      min-height: 36px;
      border-bottom: 1px solid var(--border);
    }
    .tl-row:hover { background: var(--bg-hover); }
    .tl-row-label {
      flex: 0 0 220px;
      max-width: 220px;
      padding: 6px 12px 6px 0;
      font-size: 12px;
      color: var(--text-2);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tl-ms-row .tl-row-label {
      font-size: 11px;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .tl-axis {
      flex: 1;
      position: relative;
      height: 36px;
    }
    .tl-header-row {
      display: flex;
      align-items: flex-end;
      min-height: 28px;
      border-bottom: 1px solid var(--border-hover);
      margin-bottom: 4px;
    }
    .tl-header-row .tl-row-label {
      font-size: 11px;
      color: var(--text-3);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .tl-month-label {
      position: absolute;
      font-size: 11px;
      color: var(--text-3);
      transform: translateX(-50%);
      bottom: 4px;
      white-space: nowrap;
    }
    .tl-gridline {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 1px;
      background: var(--border);
      pointer-events: none;
    }
    .tl-today-line {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 1.5px;
      background: rgba(100,165,215,0.5);
      pointer-events: none;
      z-index: 2;
    }
    .tl-diamond {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%) rotate(45deg);
      width: 10px;
      height: 10px;
      border-radius: 2px;
      cursor: default;
      z-index: 3;
    }
    .tl-diamond-label {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: var(--text-3);
      white-space: nowrap;
      left: 14px;
      pointer-events: none;
    }
    .tl-task-dot {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      cursor: grab;
      z-index: 3;
      transition: transform 0.15s;
    }
    .tl-task-dot:hover {
      transform: translate(-50%, -50%) scale(1.5);
    }
    .tl-task-dot.tl-dragging {
      cursor: ew-resize !important;
      transform: translate(-50%, -50%) scale(1.8) !important;
      box-shadow: 0 0 0 4px rgba(255,255,255,0.15);
      transition: none;
      z-index: 10;
    }
    .tl-drag-preview {
      position: fixed;
      z-index: 10000;
      background: var(--bg-card);
      border: 1px solid var(--border-hover);
      border-radius: 6px;
      padding: 4px 12px;
      font-size: 12px;
      color: var(--text-1);
      pointer-events: none;
      display: none;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      white-space: nowrap;
    }
    .tl-date-label {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      white-space: nowrap;
      color: var(--text-3);
      pointer-events: none;
    }
    .tl-task-bar {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      height: 16px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 3;
      opacity: 0.85;
      transition: opacity 0.15s, height 0.15s;
      overflow: visible;
      min-width: 6px;
    }
    .tl-task-bar:hover { opacity: 1; height: 18px; }
    .tl-bar-label {
      position: absolute;
      top: -18px;
      left: 6px;
      font-size: 10px;
      white-space: nowrap;
      color: var(--text-3);
      pointer-events: none;
    }
    .tl-bar-handle {
      position: absolute;
      right: -4px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.6);
      cursor: ew-resize;
    }
    /* Bar handle: 8x8 dot, no mobile size override */
    /* Lagoon bookings toggle in calendar toolbar */
    .cal-lagoon-toggle {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 5px 12px; border: 1px solid var(--border); border-radius: 8px;
      font-size: 12px; font-weight: 500; font-family: inherit;
      color: var(--text-3); background: transparent; cursor: pointer;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }
    .cal-lagoon-toggle.on {
      background: rgba(255,179,71,0.15);
      border-color: rgba(255,170,50,0.55);
      color: #D46B08;
    }
    .tl-proj-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .tl-section-label {
      font-size: 11px;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 16px 0 6px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
    }
    .tl-section-label::before {
      content: '';
      display: inline-block;
      width: 220px;
      flex-shrink: 0;
    }
    .tl-add-date-btn {
      background: transparent;
      border: 1px dashed var(--border-hover);
      color: var(--text-3);
      border-radius: 6px;
      padding: 3px 10px;
      font-size: 11px;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
    }
    .tl-add-date-btn:hover { color: var(--text-2); border-color: var(--text-3); }
    .tl-unsched-axis {
      display: flex;
      align-items: center;
    }
    #tl-date-popup {
      position: fixed;
      z-index: 9999;
      background: var(--bg-card);
      border: 1px solid var(--border-hover);
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      min-width: 190px;
    }
    #tl-date-popup .tl-popup-title {
      font-size: 11px;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 10px;
    }
    #tl-date-input {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text-1);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 13px;
      width: 100%;
      font-family: inherit;
    }
    .tl-popup-btns {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }
    .tl-popup-save {
      flex: 1;
      background: rgba(255,255,255,0.08);
      border: none;
      color: var(--text-1);
      border-radius: 6px;
      padding: 6px;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
    }
    .tl-popup-save:hover { background: rgba(255,255,255,0.14); }
    .tl-popup-clear, .tl-popup-cancel {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-2);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
    }
    .tl-popup-clear:hover, .tl-popup-cancel:hover { border-color: var(--text-3); color: var(--text-1); }
    @media (max-width: 600px) {
      .tl-row-label { flex: 0 0 140px; max-width: 140px; font-size: 11px; }
      .tl-section-label::before { width: 140px; }
    }
  </style>
</head>
<body>

  <div class="shortcut-hint" id="shortcut-hint">Press 1&ndash;8 to switch tabs &middot; [ to toggle sidebar</div>

  <!-- ======== LEFT SIDEBAR ======== -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo-icon">
        <svg viewBox="0 0 24 24"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>
      </div>
      <span class="sidebar-logo-text">Mission Control</span>
    </div>
    <nav class="sidebar-nav">
      <button class="sidebar-nav-item active" data-tab="office">
        <span class="sidebar-nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg></span>
        <span class="sidebar-nav-label">Office</span>
      </button>
      <button class="sidebar-nav-item" data-tab="inbox">
        <span class="sidebar-nav-icon"><svg viewBox="0 0 24 24"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg></span>
        <span class="sidebar-nav-label">Inbox</span>
        <span class="sidebar-badge" id="inbox-badge">8</span>
      </button>
      <button class="sidebar-nav-item" data-tab="projects">
        <span class="sidebar-nav-icon"><svg viewBox="0 0 24 24"><path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2z"/></svg></span>
        <span class="sidebar-nav-label">Projects</span>
      </button>
      <button class="sidebar-nav-item" data-tab="team">
        <span class="sidebar-nav-icon"><svg viewBox="0 0 24 24"><circle cx="9" cy="7" r="4"/><path d="M2 21v-2a4 4 0 0 1 4-4h6a4 4 0 0 1 4 4v2"/><circle cx="19" cy="9" r="3"/><path d="M22 21v-1a3 3 0 0 0-3-3h-.5"/></svg></span>
        <span class="sidebar-nav-label">Team</span>
      </button>
      <button class="sidebar-nav-item" data-tab="calendar">
        <span class="sidebar-nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span>
        <span class="sidebar-nav-label">Calendar</span>
      </button>
      <button class="sidebar-nav-item" data-tab="analytics">
        <span class="sidebar-nav-icon"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span>
        <span class="sidebar-nav-label">Analytics</span>
      </button>
      <button class="sidebar-nav-item" data-tab="focus">
        <span class="sidebar-nav-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></span>
        <span class="sidebar-nav-label">Focus</span>
      </button>
      <button class="sidebar-nav-item" data-tab="memory">
        <span class="sidebar-nav-icon"><svg viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-4.6 12.3c.5.4.6.5.6 1.2V18h8v-2.5c0-.7.1-.8.6-1.2A7 7 0 0 0 12 2z"/><line x1="9" y1="18" x2="9" y2="22"/><line x1="15" y1="18" x2="15" y2="22"/><line x1="9" y1="22" x2="15" y2="22"/></svg></span>
        <span class="sidebar-nav-label">Memory</span>
      </button>
    </nav>
  </aside>

  <!-- ======== SIDEBAR BACKDROP (mobile) ======== -->
  <div class="sidebar-backdrop" id="sidebar-backdrop"></div>

  <!-- ======== TOP BAR ======== -->
  <header class="top-bar">
    <div style="display:flex;align-items:center;">
      <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
        <svg viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 3v18"/></svg>
      </button>
    </div>
    <div class="header-right">
      <div class="clock">
        <span class="clock-date" id="clock-date"></span>
        <span class="clock-time" id="clock-time"></span>
      </div>
      <div class="live-badge">
        <span class="live-dot"></span>
        LIVE
      </div>
      <button id="theme-toggle" aria-label="Toggle light/dark mode" style="background:none;border:none;cursor:pointer;padding:6px;border-radius:8px;color:var(--text-2);display:flex;align-items:center;transition:background 0.15s;" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='none'">
        <svg id="theme-icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        <svg id="theme-icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
    </div>
  </header>

  <!-- ======== CONTENT ======== -->
  <main class="content">

    <!-- Office -->
    <section class="tab-panel active" id="panel-office">

      <!-- Stats Bar -->
      <div class="office-stats reveal">
        <div class="stat-chip"><div class="stat-chip-value" style="color:var(--text-1)">1</div><div class="stat-chip-label">Active</div></div>
        <div class="stat-chip"><div class="stat-chip-value" style="color:var(--text-2)">6</div><div class="stat-chip-label">Idle</div></div>
        <div class="stat-chip"><div class="stat-chip-value" style="color:var(--text-2)">0</div><div class="stat-chip-label">Busy</div></div>
        <div class="stat-chip"><div class="stat-chip-value" style="color:var(--text-1)">7</div><div class="stat-chip-label">Total</div></div>
      </div>

      <!-- Workstation Grid -->
      <div class="office-grid">

        <!-- Piia (Active) -->
        <div class="workstation active reveal" style="transition-delay:0ms">
          <div class="terminal active" id="piia-terminal"><span class="terminal-cursor"></span></div>
          <div class="monitor-stand"></div>
          <div class="agent-info">
            <div class="agent-avatar" style="background:#7C9EF5">Pi<span class="avatar-status online"></span></div>
            <div class="agent-details">
              <div class="agent-name">Piia</div>
              <div class="agent-role">Chief Strategist</div>
            </div>
          </div>
          <div class="task-bar active">Processing requests</div>
          <div class="agent-footer">
            <span><span class="status-dot online"></span>Active</span>
            <span>uptime 4h 23m</span>
          </div>
          <div class="workstation-actions">
            <button class="workstation-action">Message</button>
            <button class="workstation-action">Assign Task</button>
          </div>
        </div>

        <!-- Kat (Idle) -->
        <div class="workstation reveal" style="transition-delay:80ms">
          <div class="terminal idle">&gt; standby</div>
          <div class="monitor-stand"></div>
          <div class="agent-info">
            <div class="agent-avatar" style="background:#B07CE8">Ka<span class="avatar-status offline"></span></div>
            <div class="agent-details">
              <div class="agent-name">Kat</div>
              <div class="agent-role">OFM Operations</div>
            </div>
          </div>
          <div class="task-bar idle">No active task</div>
          <div class="agent-footer">
            <span><span class="status-dot offline"></span>Idle</span>
            <span>last active 2h ago</span>
          </div>
          <div class="workstation-actions">
            <button class="workstation-action">Message</button>
            <button class="workstation-action">Assign Task</button>
          </div>
        </div>

        <!-- Rex (Idle) -->
        <div class="workstation reveal" style="transition-delay:160ms">
          <div class="terminal idle">&gt; standby</div>
          <div class="monitor-stand"></div>
          <div class="agent-info">
            <div class="agent-avatar" style="background:#5CB85C">Re<span class="avatar-status offline"></span></div>
            <div class="agent-details">
              <div class="agent-name">Rex</div>
              <div class="agent-role">Marketing &amp; Growth</div>
            </div>
          </div>
          <div class="task-bar idle">No active task</div>
          <div class="agent-footer">
            <span><span class="status-dot offline"></span>Idle</span>
            <span>last active 5h ago</span>
          </div>
          <div class="workstation-actions">
            <button class="workstation-action">Message</button>
            <button class="workstation-action">Assign Task</button>
          </div>
        </div>

        <!-- Zara (Idle) -->
        <div class="workstation reveal" style="transition-delay:240ms">
          <div class="terminal idle">&gt; standby</div>
          <div class="monitor-stand"></div>
          <div class="agent-info">
            <div class="agent-avatar" style="background:#E8A87C">Za<span class="avatar-status offline"></span></div>
            <div class="agent-details">
              <div class="agent-name">Zara</div>
              <div class="agent-role">Dev &amp; Automation</div>
            </div>
          </div>
          <div class="task-bar idle">No active task</div>
          <div class="agent-footer">
            <span><span class="status-dot offline"></span>Idle</span>
            <span>last active 1h ago</span>
          </div>
          <div class="workstation-actions">
            <button class="workstation-action">Message</button>
            <button class="workstation-action">Assign Task</button>
          </div>
        </div>

        <!-- Mara (Idle) -->
        <div class="workstation reveal" style="transition-delay:320ms">
          <div class="terminal idle">&gt; task complete: product-stack-build</div>
          <div class="monitor-stand"></div>
          <div class="agent-info">
            <div class="agent-avatar" style="background:#E87CA8">Ma<span class="avatar-status offline"></span></div>
            <div class="agent-details">
              <div class="agent-name">Mara</div>
              <div class="agent-role">Content &amp; Copy</div>
            </div>
          </div>
          <div class="task-bar idle">Last: Power Independence product stack - 24 worksheets, 5,832 lines</div>
          <div class="agent-footer">
            <span><span class="status-dot offline"></span>Idle</span>
            <span>last active just now</span>
          </div>
          <div class="workstation-actions">
            <button class="workstation-action">Message</button>
            <button class="workstation-action">Assign Task</button>
          </div>
        </div>

        <!-- Nile (Idle) -->
        <div class="workstation reveal" style="transition-delay:400ms">
          <div class="terminal idle">&gt; task complete: ready-life-extraction</div>
          <div class="monitor-stand"></div>
          <div class="agent-info">
            <div class="agent-avatar" style="background:#7CD4E8">Ni<span class="avatar-status offline"></span></div>
            <div class="agent-details">
              <div class="agent-name">Nile</div>
              <div class="agent-role">Research &amp; Intel</div>
            </div>
          </div>
          <div class="task-bar idle">Last: Ready Life Academy extraction - Nick Meissner source material</div>
          <div class="agent-footer">
            <span><span class="status-dot offline"></span>Idle</span>
            <span>last active 1h ago</span>
          </div>
          <div class="workstation-actions">
            <button class="workstation-action">Message</button>
            <button class="workstation-action">Assign Task</button>
          </div>
        </div>

        <!-- Nova (Idle) -->
        <div class="workstation reveal" style="transition-delay:480ms">
          <div class="terminal idle">&gt; standby</div>
          <div class="monitor-stand"></div>
          <div class="agent-info">
            <div class="agent-avatar" style="background:#F5A623">No<span class="avatar-status offline"></span></div>
            <div class="agent-details">
              <div class="agent-name">Nova</div>
              <div class="agent-role">Product Development</div>
            </div>
          </div>
          <div class="task-bar idle">Digital products pipeline - brief to launch</div>
          <div class="agent-footer">
            <span><span class="status-dot offline"></span>Idle</span>
            <span>added today</span>
          </div>
          <div class="workstation-actions">
            <button class="workstation-action">Message</button>
            <button class="workstation-action">Assign Task</button>
          </div>
        </div>

      </div>
    </section>

    <!-- Team -->
    <section class="tab-panel" id="panel-team">

      <div class="view-toggle-toolbar">
        <div class="view-toggle" id="team-view-toggle">
          <button class="view-toggle-btn active" data-view="cards">Cards</button>
          <button class="view-toggle-btn" data-view="table">Table</button>
        </div>
      </div>

      <!-- Card View -->
      <div id="team-card-view">

      <!-- COMMAND -->
      <div class="dept-command">
        <h2 class="dept-label reveal" style="--dept-accent:var(--pill-active-text)">Command</h2>
        <div class="team-grid">
          <div class="team-card dept-command reveal" style="transition-delay:0ms">
            <div class="team-card-header">
              <div class="team-card-emoji"><div class="agent-avatar agent-avatar-lg" style="background:#7C9EF5">Pi</div></div>
              <div class="team-card-meta">
                <div class="team-card-name">Piia</div>
                <div class="team-card-title">Chief Strategist</div>
              </div>
              <span class="pill pill-done">Active</span>
            </div>
            <ul class="team-card-resp">
              <li>Session orchestration &amp; routing</li>
              <li>Cross-agent task coordination</li>
              <li>User intent parsing &amp; prioritisation</li>
              <li>Strategic planning &amp; goal tracking</li>
              <li>Escalation &amp; conflict resolution</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- OPERATIONS -->
      <div class="dept-ops">
        <h2 class="dept-label reveal" style="--dept-accent:var(--pill-done-text)">Operations</h2>
        <div class="team-grid">
          <div class="team-card dept-ops reveal" style="transition-delay:0ms">
            <div class="team-card-header">
              <div class="team-card-emoji"><div class="agent-avatar agent-avatar-lg" style="background:#B07CE8">Ka</div></div>
              <div class="team-card-meta">
                <div class="team-card-name">Kat</div>
                <div class="team-card-title">OFM Operations</div>
              </div>
              <span class="pill pill-idle">Idle</span>
            </div>
            <ul class="team-card-resp">
              <li>Content scheduling &amp; publishing</li>
              <li>Fan engagement &amp; messaging</li>
              <li>Revenue tracking &amp; reporting</li>
              <li>PPV campaign management</li>
              <li>Platform compliance monitoring</li>
            </ul>
          </div>
          <div class="team-card dept-ops reveal" style="transition-delay:80ms">
            <div class="team-card-header">
              <div class="team-card-emoji"><div class="agent-avatar agent-avatar-lg" style="background:#5CB85C">Re</div></div>
              <div class="team-card-meta">
                <div class="team-card-name">Rex</div>
                <div class="team-card-title">Marketing &amp; Growth</div>
              </div>
              <span class="pill pill-idle">Idle</span>
            </div>
            <ul class="team-card-resp">
              <li>Social media strategy &amp; posting</li>
              <li>Audience growth &amp; retention</li>
              <li>Campaign planning &amp; execution</li>
              <li>Trend capitalisation &amp; virality</li>
              <li>Cross-platform optimisation</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- BUILD -->
      <div class="dept-build">
        <h2 class="dept-label reveal" style="--dept-accent:var(--pill-progress-text)">Build</h2>
        <div class="team-grid">
          <div class="team-card dept-build reveal" style="transition-delay:0ms">
            <div class="team-card-header">
              <div class="team-card-emoji"><div class="agent-avatar agent-avatar-lg" style="background:#E8A87C">Za</div></div>
              <div class="team-card-meta">
                <div class="team-card-name">Zara</div>
                <div class="team-card-title">Dev &amp; Automation</div>
              </div>
              <span class="pill pill-idle">Idle</span>
            </div>
            <ul class="team-card-resp">
              <li>Tool &amp; skill development</li>
              <li>Workflow automation scripts</li>
              <li>Infrastructure &amp; deployment ops</li>
              <li>API integrations &amp; webhooks</li>
              <li>System monitoring &amp; alerts</li>
            </ul>
          </div>
          <div class="team-card dept-build reveal" style="transition-delay:80ms">
            <div class="team-card-header">
              <div class="team-card-emoji"><div class="agent-avatar agent-avatar-lg" style="background:#E87CA8">Ma</div></div>
              <div class="team-card-meta">
                <div class="team-card-name">Mara</div>
                <div class="team-card-title">Content &amp; Copy</div>
              </div>
              <span class="pill pill-idle">Idle</span>
            </div>
            <ul class="team-card-resp">
              <li>Caption &amp; bio writing</li>
              <li>Script drafting &amp; storyboarding</li>
              <li>Brand voice &amp; tone consistency</li>
              <li>Content calendar planning</li>
              <li>Copy editing &amp; proofreading</li>
            </ul>
          </div>
          <div class="team-card dept-build reveal" style="transition-delay:160ms">
            <div class="team-card-header">
              <div class="team-card-emoji"><div class="agent-avatar agent-avatar-lg" style="background:#F5A623">No</div></div>
              <div class="team-card-meta">
                <div class="team-card-name">Nova</div>
                <div class="team-card-title">Product Development</div>
              </div>
              <span class="pill pill-idle">Idle</span>
            </div>
            <ul class="team-card-resp">
              <li>Digital product pipeline (brief to launch)</li>
              <li>6-Pillar framework builds</li>
              <li>Worksheets, checklists &amp; printables</li>
              <li>Product stack assembly</li>
              <li>Bonus &amp; upsell creation</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- INTELLIGENCE -->
      <div class="dept-intel">
        <h2 class="dept-label reveal" style="--dept-accent:var(--pill-waiting-text)">Intelligence</h2>
        <div class="team-grid">
          <div class="team-card dept-intel reveal" style="transition-delay:0ms">
            <div class="team-card-header">
              <div class="team-card-emoji"><div class="agent-avatar agent-avatar-lg" style="background:#7CD4E8">Ni</div></div>
              <div class="team-card-meta">
                <div class="team-card-name">Nile</div>
                <div class="team-card-title">Research &amp; Intel</div>
              </div>
              <span class="pill pill-idle">Idle</span>
            </div>
            <ul class="team-card-resp">
              <li>Market research &amp; benchmarking</li>
              <li>Competitor analysis &amp; tracking</li>
              <li>Trend forecasting &amp; signals</li>
              <li>Audience insight reports</li>
              <li>Platform policy &amp; algorithm intel</li>
            </ul>
          </div>
        </div>
      </div>

      </div><!-- /team-card-view -->

      <!-- Table View -->
      <div id="team-table-view" style="display:none">
        <div class="data-table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th class="data-th">Agent</th>
                <th class="data-th">Role</th>
                <th class="data-th">Department</th>
                <th class="data-th">Status</th>
                <th class="data-th">Key Responsibilities</th>
              </tr>
            </thead>
            <tbody>
              <tr class="data-row">
                <td class="data-td"><span style="display:inline-flex;align-items:center;gap:8px"><span class="agent-avatar agent-avatar-sm" style="background:#7C9EF5">Pi</span> Piia</span></td>
                <td class="data-td">Chief Strategist</td>
                <td class="data-td">Command</td>
                <td class="data-td"><span class="pill pill-done">Active</span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">Session orchestration, cross-agent coordination, strategic planning</td>
              </tr>
              <tr class="data-row">
                <td class="data-td"><span style="display:inline-flex;align-items:center;gap:8px"><span class="agent-avatar agent-avatar-sm" style="background:#B07CE8">Ka</span> Kat</span></td>
                <td class="data-td">OFM Operations</td>
                <td class="data-td">Operations</td>
                <td class="data-td"><span class="pill pill-idle">Idle</span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">Content scheduling, fan engagement, revenue tracking</td>
              </tr>
              <tr class="data-row">
                <td class="data-td"><span style="display:inline-flex;align-items:center;gap:8px"><span class="agent-avatar agent-avatar-sm" style="background:#5CB85C">Re</span> Rex</span></td>
                <td class="data-td">Marketing &amp; Growth</td>
                <td class="data-td">Operations</td>
                <td class="data-td"><span class="pill pill-idle">Idle</span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">Social media strategy, audience growth, campaign execution</td>
              </tr>
              <tr class="data-row">
                <td class="data-td"><span style="display:inline-flex;align-items:center;gap:8px"><span class="agent-avatar agent-avatar-sm" style="background:#E8A87C">Za</span> Zara</span></td>
                <td class="data-td">Dev &amp; Automation</td>
                <td class="data-td">Build</td>
                <td class="data-td"><span class="pill pill-idle">Idle</span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">Tool development, workflow automation, infrastructure ops</td>
              </tr>
              <tr class="data-row">
                <td class="data-td"><span style="display:inline-flex;align-items:center;gap:8px"><span class="agent-avatar agent-avatar-sm" style="background:#E87CA8">Ma</span> Mara</span></td>
                <td class="data-td">Content &amp; Copy</td>
                <td class="data-td">Build</td>
                <td class="data-td"><span class="pill pill-idle">Idle</span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">Caption writing, script drafting, brand voice consistency</td>
              </tr>
              <tr class="data-row">
                <td class="data-td"><span style="display:inline-flex;align-items:center;gap:8px"><span class="agent-avatar agent-avatar-sm" style="background:#7CD4E8">Ni</span> Nile</span></td>
                <td class="data-td">Research &amp; Intel</td>
                <td class="data-td">Intelligence</td>
                <td class="data-td"><span class="pill pill-idle">Idle</span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">Market research, competitor analysis, trend forecasting</td>
              </tr>
              <tr class="data-row">
                <td class="data-td"><span style="display:inline-flex;align-items:center;gap:8px"><span class="agent-avatar agent-avatar-sm" style="background:#F5A623">No</span> Nova</span></td>
                <td class="data-td">Product Development</td>
                <td class="data-td">Build</td>
                <td class="data-td"><span class="pill pill-idle">Idle</span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">Digital products pipeline - brief to launch, worksheets, frameworks, bonus stack</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </section>

    <!-- Projects -->
    <section class="tab-panel" id="panel-projects">

      <!-- Stats + Toggle Row -->
      <div class="projects-toolbar reveal">
        <div class="office-stats">
          <div class="stat-chip"><div class="stat-chip-value">5</div><div class="stat-chip-label">Total</div></div>
          <div class="stat-chip"><div class="stat-chip-value">2</div><div class="stat-chip-label">Active</div></div>
          <div class="stat-chip"><div class="stat-chip-value">2</div><div class="stat-chip-label">Planning</div></div>
          <div class="stat-chip"><div class="stat-chip-value">1</div><div class="stat-chip-label">Idea</div></div>
        </div>
        <div class="view-toggle" id="projects-view-toggle">
          <button class="view-toggle-btn active" data-view="cards">Cards</button>
          <button class="view-toggle-btn" data-view="table">Table</button>
        </div>
      </div>

      <!-- Card View -->
      <div id="projects-card-view">
      <div class="projects-grid">

        <!-- P1: OFM Agency -->
        <div class="project-card reveal" style="transition-delay:0ms">
          <div class="project-top">
            <span class="project-priority">P1</span>
            <span class="project-name">OFM Agency</span>
            <span class="pill pill-done">Active</span>
          </div>
          <div class="project-desc">Building creator management agency with content workflows, fan messaging systems, scaling playbooks.</div>
          <div class="project-agents">
            <span class="agent-chip"><span class="agent-avatar agent-avatar-sm" style="background:#B07CE8">Ka</span> Kat</span>
            <span class="agent-chip"><span class="agent-avatar agent-avatar-sm" style="background:#E87CA8">Ma</span> Mara</span>
            <span class="agent-chip"><span class="agent-avatar agent-avatar-sm" style="background:#5CB85C">Re</span> Rex</span>
          </div>
          <ul class="project-threads">
            <li>Recruit first 2 creators</li>
            <li>Create Fanvue AI model account</li>
            <li>ComfyUI setup on vast.ai (today)</li>
            <li>Build fan messaging SOP</li>
            <li>&#10003; Kevin deal closed (30% his models only)</li>
            <li>5 Filipino chatters on standby</li>
          </ul>
        </div>

        <!-- P2: Digital Products -->
        <div class="project-card reveal" style="transition-delay:80ms">
          <div class="project-top">
            <span class="project-priority" style="background:#5AB8B0;color:#fff">P2</span>
            <span class="project-name">Digital Products</span>
            <span class="pill pill-progress">Sprint</span>
          </div>
          <div class="project-desc">Low-ticket AI-built products using Paid Creators 6-Pillar framework. Product 1: Off-Grid Power Independence ($27). Faceless brand, paid ads.</div>
          <div class="project-agents">
            <span class="agent-chip"><span class="agent-avatar agent-avatar-sm" style="background:#7C9EF5">Pi</span> Piia</span>
          </div>
          <ul class="project-threads">
            <li>&#10003; Brief done (2,482 lines)</li>
            <li>&#10003; Product stack done (24 worksheets, 311 KB)</li>
            <li>&#10003; Bonus stack done (Battery Guide, Calculator, Emergency Protocols)</li>
            <li>Funnel: $27 core / $47 calculator / $97 DFY design / $17 membership</li>
            <li>Platform: Systeme.io (free launch)</li>
            <li>Step 6: Sales page copy + funnel build</li>
          </ul>
        </div>

        <!-- P3: Lagoon Company -->
        <div class="project-card reveal" style="transition-delay:160ms">
          <div class="project-top">
            <span class="project-priority">P3</span>
            <span class="project-name">Lagoon Company</span>
            <span class="pill pill-active">Active</span>
          </div>
          <div class="project-desc">ATV, UTV &amp; yacht rental company Tulum, main income since 2021.</div>
          <div class="project-agents">
            <span class="agent-chip"><span class="agent-avatar agent-avatar-sm" style="background:#5CB85C">Re</span> Rex</span>
          </div>
          <ul class="project-threads">
            <li>Eco-yacht Facebook ad (live)</li>
            <li>Google Ads optimisation</li>
            <li>Instagram growth</li>
            <li>Add Piia to company WhatsApp</li>
            <li>Set up Aitable.ai booking tracking</li>
            <li>Fleet maintenance schedule</li>
          </ul>
        </div>

        <!-- P4: Hilltop Villa - Oaxaca -->
        <div class="project-card reveal" style="transition-delay:240ms">
          <div class="project-top">
            <span class="project-priority">P4</span>
            <span class="project-name">Hilltop Villa - Oaxaca</span>
            <span class="pill pill-waiting">Planning</span>
          </div>
          <div class="project-desc">Ocean-view Oaxaca land, rammed-earth construction (Sirewall).</div>
          <div class="project-agents">
            <span class="agent-chip"><span class="agent-avatar agent-avatar-sm" style="background:#7CD4E8">Ni</span> Nile</span>
            <span class="agent-chip"><span class="agent-avatar agent-avatar-sm" style="background:#E8A87C">Za</span> Zara</span>
          </div>
          <ul class="project-threads">
            <li>&#10003; Ocean-view land purchased (Oaxaca coast)</li>
            <li>&#10003; Sirewall rammed-earth training complete</li>
            <li>Site survey + permit research</li>
            <li>Construction cost estimate</li>
            <li>Architect / builder sourcing</li>
          </ul>
        </div>

        <!-- P5: Farm / Off-Grid -->
        <div class="project-card reveal" style="transition-delay:320ms">
          <div class="project-top">
            <span class="project-priority">P5</span>
            <span class="project-name">Farm / Off-Grid</span>
            <span class="pill pill-waiting">Planning</span>
          </div>
          <div class="project-desc">Off-grid Oaxaca farm: livestock, poultry, solar, LiFePO4 batteries.</div>
          <div class="project-agents">
            <span class="agent-chip"><span class="agent-avatar agent-avatar-sm" style="background:#7CD4E8">Ni</span> Nile</span>
          </div>
          <ul class="project-threads">
            <li>&#10003; Ranch land acquired (Oaxaca)</li>
            <li>Poultry setup - Cornish Cross breed</li>
            <li>Solar sizing + LiFePO4 battery bank</li>
            <li>Water system + generator selection</li>
            <li>Off-grid infrastructure plan</li>
          </ul>
        </div>

        <!-- P6: App Development -->
        <div class="project-card reveal" style="transition-delay:400ms">
          <div class="project-top">
            <span class="project-priority">P6</span>
            <span class="project-name">App Development</span>
            <span class="pill pill-backlog">Idea</span>
          </div>
          <div class="project-desc">Farmers direct-to-customer app Puerto Escondido.</div>
          <div class="project-agents">
            <span class="agent-chip"><span class="agent-avatar agent-avatar-sm" style="background:#E8A87C">Za</span> Zara</span>
          </div>
          <ul class="project-threads">
            <li>Market validation</li>
            <li>Tech stack decision</li>
            <li>MVP scope</li>
          </ul>
        </div>

      </div>
      </div><!-- /projects-card-view -->

      <!-- Table View -->
      <div id="projects-table-view" style="display:none">
        <div class="data-table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th class="data-th">Project</th>
                <th class="data-th">Status</th>
                <th class="data-th">Priority</th>
                <th class="data-th">Agent(s)</th>
                <th class="data-th">Description</th>
              </tr>
            </thead>
            <tbody>
              <tr class="data-row">
                <td class="data-td">OFM Agency</td>
                <td class="data-td"><span class="pill pill-done">Active</span></td>
                <td class="data-td">P1</td>
                <td class="data-td"><span style="display:inline-flex;gap:4px"><span class="agent-avatar agent-avatar-sm" style="background:#B07CE8">Ka</span><span class="agent-avatar agent-avatar-sm" style="background:#E87CA8">Ma</span><span class="agent-avatar agent-avatar-sm" style="background:#5CB85C">Re</span></span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">Creator management agency with content workflows &amp; scaling playbooks</td>
              </tr>
              <tr class="data-row">
                <td class="data-td">Digital Products</td>
                <td class="data-td"><span class="pill pill-progress">Sprint</span></td>
                <td class="data-td">P2</td>
                <td class="data-td"><span style="display:inline-flex;gap:4px"><span class="agent-avatar agent-avatar-sm" style="background:#7C9EF5">Pi</span></span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">AI-built low-ticket products. Product 1: Off-Grid Power Independence. Paid ads, faceless brand.</td>
              </tr>
              <tr class="data-row">
                <td class="data-td">Lagoon Company</td>
                <td class="data-td"><span class="pill pill-active">Active</span></td>
                <td class="data-td">P3</td>
                <td class="data-td"><span style="display:inline-flex;gap:4px"><span class="agent-avatar agent-avatar-sm" style="background:#5CB85C">Re</span></span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">ATV, UTV &amp; yacht rental company Tulum, main income since 2021</td>
              </tr>
              <tr class="data-row">
                <td class="data-td">Hilltop Villa - Oaxaca</td>
                <td class="data-td"><span class="pill pill-waiting">Planning</span></td>
                <td class="data-td">P4</td>
                <td class="data-td"><span style="display:inline-flex;gap:4px"><span class="agent-avatar agent-avatar-sm" style="background:#7CD4E8">Ni</span><span class="agent-avatar agent-avatar-sm" style="background:#E8A87C">Za</span></span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">Ocean-view Oaxaca land, rammed-earth construction (Sirewall)</td>
              </tr>
              <tr class="data-row">
                <td class="data-td">Farm / Off-Grid</td>
                <td class="data-td"><span class="pill pill-waiting">Planning</span></td>
                <td class="data-td">P5</td>
                <td class="data-td"><span style="display:inline-flex;gap:4px"><span class="agent-avatar agent-avatar-sm" style="background:#7CD4E8">Ni</span></span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">Off-grid Oaxaca farm: livestock, poultry, solar, LiFePO4 batteries</td>
              </tr>
              <tr class="data-row">
                <td class="data-td">App Development</td>
                <td class="data-td"><span class="pill pill-backlog">Idea</span></td>
                <td class="data-td">P6</td>
                <td class="data-td"><span style="display:inline-flex;gap:4px"><span class="agent-avatar agent-avatar-sm" style="background:#E8A87C">Za</span></span></td>
                <td class="data-td" style="color:var(--text-2);font-size:14px">Farmers direct-to-customer app Puerto Escondido</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </section>

    <!-- Inbox / Kanban -->
    <section class="tab-panel" id="panel-inbox">

      <!-- Toolbar: metrics (left) | filters (center) | view toggle (right) -->
      <div class="kb-toolbar">
        <div class="kb-metrics" id="kb-metrics">
          <div class="kb-metric">
            <div class="kb-metric-value" id="kb-metric-week">0</div>
            <div class="kb-metric-label">This Week</div>
          </div>
          <div class="kb-metric">
            <div class="kb-metric-value" id="kb-metric-progress">0</div>
            <div class="kb-metric-label">In Progress</div>
          </div>
          <div class="kb-metric">
            <div class="kb-metric-value" id="kb-metric-total">0</div>
            <div class="kb-metric-label">Total</div>
          </div>
          <div class="kb-metric">
            <div class="kb-metric-value" id="kb-metric-pct">0%</div>
            <div class="kb-metric-label">Done</div>
          </div>
        </div>
        <div class="inbox-filters" id="kb-filters" style="display:none">
          <button class="inbox-filter active" data-filter="all">All</button>
          <button class="inbox-filter" data-filter="active">Active</button>
          <button class="inbox-filter" data-filter="mine">Mine</button>
          <button class="inbox-filter" data-filter="agent">Agent</button>
          <button class="inbox-filter" data-filter="done">Done</button>
        </div>
        <div class="kb-view-toggle">
          <button class="kb-view-btn active" data-view="kanban">Kanban</button>
          <button class="kb-view-btn" data-view="list">List</button>
        </div>
      </div>

      <!-- Kanban Board (rendered by JS) -->
      <div class="kb-board" id="kb-board"></div>

      <!-- Legacy List View (hidden by default, populated by JS) -->
      <div class="inbox-columns kb-list-hidden" id="kb-list-view">
        <div class="inbox-col" data-col="mine">
          <div class="inbox-col-header">My Actions</div>
        </div>
        <div class="inbox-col" data-col="agent">
          <div class="inbox-col-header">Agent Queue</div>
        </div>
      </div>

    </section>

    <!-- Analytics -->
    <section class="tab-panel" id="panel-analytics">

      <!-- Date Range — right-aligned -->
      <div style="display:flex;justify-content:flex-end;margin-bottom:20px">
        <div class="analytics-filters">
          <button class="analytics-filter active" data-range="month">This Month</button>
          <button class="analytics-filter" data-range="last">Last Month</button>
          <button class="analytics-filter" data-range="quarter">Last 3 Months</button>
          <button class="analytics-filter" data-range="ytd">Year to Date</button>
        </div>
      </div>

      <!-- MODEL USAGE (OpenClaw Infrastructure) -->
      <div class="analytics-section reveal">
        <div class="analytics-section-header" data-collapse="model-analytics">
          <svg class="analytics-chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4,6 8,10 12,6"/></svg>
          <span class="analytics-section-title" style="--dept-accent:var(--pill-medium-text)">OpenClaw · Model Usage</span>
          <span id="usage-sync-time" style="font-size:11px;color:var(--text-3);margin-left:10px;font-weight:400;vertical-align:middle"></span>
          <button id="usage-sync-btn" onclick="triggerUsageSync()" style="margin-left:auto;padding:4px 12px;font-size:11px;border-radius:6px;border:1px solid var(--border);background:var(--surface-2);color:var(--text-2);cursor:pointer;font-weight:500;transition:all .15s;" title="Sync now via local API">⟳ Sync</button>
        </div>
        <div class="analytics-table-wrap" id="model-analytics">
          <!-- Usage bars rendered by JS from data/usage.json -->
          <div id="usage-bars" style="padding:20px 16px 8px;">
            <div style="color:var(--text-3);font-size:13px;">Loading usage data…</div>
          </div>
          <div style="font-size:12px;color:var(--text-3);padding:4px 16px 14px;line-height:1.6;">
            <span style="color:var(--text-2);font-weight:400">Routing:</span> Haiku → trivial · Kimi → medium · Sonnet → complex · syncs 4×/day
          </div>
        </div>
      </div>

      <!-- OFM AGENCY -->
      <div class="analytics-section reveal">
        <div class="analytics-section-header" data-collapse="ofm-analytics">
          <svg class="analytics-chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4,6 8,10 12,6"/></svg>
          <span class="analytics-section-title" style="--dept-accent:var(--pill-progress-text)">OFM Agency</span><span style="font-size:11px;color:var(--text-3);margin-left:10px;font-weight:400;vertical-align:middle"> figures are estimates, update with real data</span>
        </div>
        <div class="analytics-table-wrap" id="ofm-analytics">
          <table class="analytics-table">
            <thead><tr>
              <th class="analytics-th" data-sort="metric">Metric <span class="sort-arrow">&#x25B2;</span></th>
              <th class="analytics-th" data-sort="value">Current <span class="sort-arrow">&#x25B2;</span></th>
              <th class="analytics-th" data-sort="change">Change <span class="sort-arrow">&#x25B2;</span></th>
              <th class="analytics-th">Trend</th>
              <th class="analytics-th" data-sort="status">Status <span class="sort-arrow">&#x25B2;</span></th>
            </tr></thead>
            <tbody id="ofm-analytics-body"></tbody>
          </table>
        </div>
      </div>

      <!-- THE LAGOON COMPANY -->
      <div class="analytics-section reveal">
        <div class="analytics-section-header" data-collapse="lagoon-analytics-content">
          <svg class="analytics-chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4,6 8,10 12,6"/></svg>
          <span class="analytics-section-title" style="--dept-accent:var(--pill-done-text)">Lagoon Company</span>
          <span id="lagoon-data-badge" style="font-size:11px;color:var(--text-3);margin-left:10px;font-weight:400;vertical-align:middle"> loading live data…</span>
        </div>
        <div id="lagoon-analytics-content">
        <div class="analytics-table-wrap" id="lagoon-analytics">
          <table class="analytics-table">
            <thead><tr>
              <th class="analytics-th" data-sort="metric">Metric <span class="sort-arrow">&#x25B2;</span></th>
              <th class="analytics-th" data-sort="value">Current <span class="sort-arrow">&#x25B2;</span></th>
              <th class="analytics-th" data-sort="change">Change <span class="sort-arrow">&#x25B2;</span></th>
              <th class="analytics-th">Trend</th>
              <th class="analytics-th" data-sort="prev">Prev Period <span class="sort-arrow">&#x25B2;</span></th>
            </tr></thead>
            <tbody id="lagoon-analytics-body"></tbody>
          </table>
        </div>
        <!-- Active Bookings (in progress right now) -->
        <div id="lagoon-active-wrap" style="margin-top:20px;display:none">
          <div style="font-size:12px;font-weight:600;color:var(--text-2);margin-bottom:8px;letter-spacing:0.04em;text-transform:uppercase;display:flex;align-items:center;gap:8px">
            <span style="width:8px;height:8px;border-radius:50%;background:#52C41A;display:inline-block"></span>
            Active Now
          </div>
          <div class="analytics-table-wrap">
            <table class="analytics-table">
              <thead><tr>
                <th class="analytics-th">Customer</th>
                <th class="analytics-th">Vehicle</th>
                <th class="analytics-th">Location</th>
                <th class="analytics-th">Period</th>
                <th class="analytics-th">Days</th>
                <th class="analytics-th">Gross</th>
                <th class="analytics-th">Source</th>
              </tr></thead>
              <tbody id="lagoon-active-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Upcoming Bookings (next 30 days) -->
        <div id="lagoon-upcoming-wrap" style="margin-top:16px;display:none">
          <div style="font-size:12px;font-weight:600;color:var(--text-2);margin-bottom:8px;letter-spacing:0.04em;text-transform:uppercase;display:flex;align-items:center;gap:8px">
            <span style="width:8px;height:8px;border-radius:50%;background:#3B7BF6;display:inline-block"></span>
            Upcoming — Next 30 Days
          </div>
          <div class="analytics-table-wrap">
            <table class="analytics-table">
              <thead><tr>
                <th class="analytics-th">Customer</th>
                <th class="analytics-th">Vehicle</th>
                <th class="analytics-th">Location</th>
                <th class="analytics-th">Starts</th>
                <th class="analytics-th">Ends</th>
                <th class="analytics-th">Days</th>
                <th class="analytics-th">Gross</th>
              </tr></thead>
              <tbody id="lagoon-upcoming-body"></tbody>
            </table>
          </div>
          <div id="lagoon-sync-time" style="font-size:11px;color:var(--text-3);margin-top:8px;text-align:right"></div>
        </div>

        <!-- Empty state -->
        <div id="lagoon-bookings-empty" style="display:none;padding:16px 0;color:var(--text-3);font-size:13px">No active or upcoming bookings in the next 30 days.</div>
        </div><!-- /lagoon-analytics-content -->
      </div>

    </section>

    <!-- Calendar -->
    <section class="tab-panel" id="panel-calendar">

      <!-- Calendar Toolbar -->
      <div class="cal-toolbar reveal">
        <div class="cal-toolbar-left">
          <h2 class="cal-title" id="cal-title">February 2026</h2>
          <div class="cal-nav-arrows">
            <button class="cal-nav-btn" id="cal-prev" aria-label="Previous">&#8249;</button>
            <button class="cal-nav-btn cal-today-btn" id="cal-today">Today</button>
            <button class="cal-nav-btn" id="cal-next" aria-label="Next">&#8250;</button>
          </div>
        </div>
        <div class="cal-toolbar-right" style="display:flex;align-items:center;gap:10px">
          <button class="cal-lagoon-toggle on" id="cal-lagoon-toggle" title="Toggle Lagoon bookings">Lagoon</button>
          <div class="cal-view-toggle">
            <button class="cal-view-btn active" data-view="month">Month</button>
            <button class="cal-view-btn" data-view="week">Week</button>
            <button class="cal-view-btn" data-view="timeline">Timeline</button>
          </div>
        </div>
      </div>

      <!-- Calendar Grid (rendered by JS) -->
      <div id="cal-container" class="reveal"></div>

      <!-- Timeline View (rendered by JS) -->
      <div id="cal-timeline" style="display:none"></div>
      <!-- Timeline date-picker popup (rendered into cal-timeline by JS) -->

      <!-- Add Event Modal -->
      <div class="cal-modal-backdrop" id="cal-modal-backdrop" style="display:none">
        <div class="cal-modal">
          <div class="cal-modal-header">
            <span class="cal-modal-title">Add Event</span>
            <button class="cal-modal-close" id="cal-modal-close">&times;</button>
          </div>
          <div class="cal-modal-body">
            <input class="cal-form-input" id="cal-event-title" type="text" placeholder="Event title..." autocomplete="off">
            <input class="cal-form-input" id="cal-event-time" type="time">
            <div class="cal-color-picker" id="cal-color-picker"></div>
            <input type="hidden" id="cal-event-date">
            <input type="hidden" id="cal-event-color" value="#6BA8DA">
          </div>
          <div class="cal-modal-footer">
            <button class="cal-form-cancel" id="cal-modal-cancel">Cancel</button>
            <button class="cal-form-save" id="cal-modal-save">Add Event</button>
          </div>
        </div>
      </div>

      <!-- Milestones -->
      <h2 class="dept-label reveal" style="margin-top:32px">Upcoming Milestones</h2>
      <div class="milestone-strip">
        <div class="milestone-card reveal" style="transition-delay:0ms;border-left-color:#F5A623">
          <div class="milestone-cat-label" style="color:#F5A623"><span class="milestone-cat-icon">&#x26A1;</span> Digital Products</div>
          <div class="milestone-name">Power Independence Academy - funnel live</div>
          <div class="milestone-date">Mar 2026</div>
        </div>
        <div class="milestone-card reveal" style="transition-delay:80ms;border-left-color:#F5A623">
          <div class="milestone-cat-label" style="color:#F5A623"><span class="milestone-cat-icon">&#x26A1;</span> Digital Products</div>
          <div class="milestone-name">Power Independence - first sale</div>
          <div class="milestone-date">Mar 2026</div>
        </div>
        <div class="milestone-card reveal" style="transition-delay:160ms;border-left-color:#B07CE8">
          <div class="milestone-cat-label" style="color:#B07CE8"><span class="milestone-cat-icon">&#x1F48E;</span> OFM Agency</div>
          <div class="milestone-name">OFM - first creator live</div>
          <div class="milestone-date">Mar 2026</div>
        </div>
        <div class="milestone-card reveal" style="transition-delay:240ms;border-left-color:#5BC0DE">
          <div class="milestone-cat-label" style="color:#5BC0DE"><span class="milestone-cat-icon">&#x2708;</span> Life</div>
          <div class="milestone-name">Move to Puerto Escondido</div>
          <div class="milestone-date">May 2026</div>
        </div>
        <div class="milestone-card reveal" style="transition-delay:320ms;border-left-color:#9B59B6">
          <div class="milestone-cat-label" style="color:#9B59B6"><span class="milestone-cat-icon">&#x1F476;</span> Personal</div>
          <div class="milestone-name">Baby due - Bianca</div>
          <div class="milestone-date">Aug 15, 2026</div>
        </div>
        <div class="milestone-card reveal" style="transition-delay:400ms;border-left-color:#5BC0DE">
          <div class="milestone-cat-label" style="color:#5BC0DE"><span class="milestone-cat-icon">&#x26F5;</span> Lagoon Company</div>
          <div class="milestone-name">Lagoon high season</div>
          <div class="milestone-date">Dec 2026</div>
        </div>
        <div class="milestone-card reveal" style="transition-delay:480ms;border-left-color:#D4A843">
          <div class="milestone-cat-label" style="color:#D4A843"><span class="milestone-cat-icon">&#x1F3E0;</span> Hilltop Villa</div>
          <div class="milestone-name">Hilltop Villa survey</div>
          <div class="milestone-date">TBD</div>
        </div>
        <div class="milestone-card reveal" style="transition-delay:560ms;border-left-color:#5CB85C">
          <div class="milestone-cat-label" style="color:#5CB85C"><span class="milestone-cat-icon">&#x1F331;</span> Farm / Off-Grid</div>
          <div class="milestone-name">Farm setup start</div>
          <div class="milestone-date">TBD</div>
        </div>
      </div>

    </section>

    <!-- Focus -->
    <section class="tab-panel" id="panel-focus">
      <div class="focus-wrap">

        <select class="focus-select" id="focus-project-select">
          <option value="ofm">OFM Agency</option>
          <option value="digital">Digital Products</option>
          <option value="lagoon">Lagoon Company</option>
          <option value="crete">Hilltop Villa - Oaxaca</option>
          <option value="farm">Farm / Off-Grid</option>
          <option value="app">App Development</option>
        </select>

        <div id="focus-content"></div>

      </div>
    </section>

    <!-- Memory -->
    <section class="tab-panel" id="panel-memory">
      <div class="mem-wrap">

        <!-- Search bar -->
        <div class="mem-search-wrap">
          <svg class="mem-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" class="mem-search" id="mem-search-input" placeholder="Search memory...">
        </div>

        <!-- Section 1: Key People (open by default) -->
        <div class="mem-section open reveal" data-mem-section style="transition-delay:0ms">
          <div class="mem-section-header" onclick="this.parentElement.classList.toggle('open')">
            <span class="mem-section-title">Key People</span>
            <svg class="mem-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
          <div class="mem-section-body">
            <div class="mem-section-inner">
              <div class="mem-people-grid">

                <div class="mem-person mem-card" data-mem-text="bianca fiancee ofm agency argentinian partner">
                  <div class="mem-person-name">Bianca</div>
                  <div class="mem-person-role">Fianc&eacute;e &amp; OFM Partner</div>
                  <div class="mem-person-detail">Argentinian, US citizen. Pregnant - due ~August 15, 2026. Transitioning to permanent Mexican residency. Co-runs OFM Agency.</div>
                </div>

                <div class="mem-person mem-card" data-mem-text="shiloh son child costa rica silvia">
                  <div class="mem-person-name">Shiloh</div>
                  <div class="mem-person-role">Son</div>
                  <div class="mem-person-detail">Born 2020, Hammersmith Hospital, London. Mother is Silvia. Currently based in Costa Rica.</div>
                </div>

                <div class="mem-person mem-card" data-mem-text="zona twin brother family">
                  <div class="mem-person-name">Zona</div>
                  <div class="mem-person-role">Twin Brother</div>
                  <div class="mem-person-detail">Grew up together in Port Harcourt, moved to the UK together as kids. Both attended Wellington School. UK-based.</div>
                </div>

                <div class="mem-person mem-card" data-mem-text="dubi eldest brother lagoon company co-founder co-owner nigerian tulum imaya nori">
                  <div class="mem-person-name">Dubi</div>
                  <div class="mem-person-role">Eldest Brother &amp; Lagoon Co-Owner</div>
                  <div class="mem-person-detail">Eldest brother. Co-owner of Lagoon Company with Beno and his wife Linea. Based in Tulum. Kids: Imaya and Nori.</div>
                </div>

                <div class="mem-person mem-card" data-mem-text="linea lagoon company co-owner dubi wife tulum">
                  <div class="mem-person-name">Linea</div>
                  <div class="mem-person-role">Lagoon Co-Owner</div>
                  <div class="mem-person-detail">Dubi's wife. Co-owner of Lagoon Company with Dubi and Beno.</div>
                </div>

                <div class="mem-person mem-card" data-mem-text="silvia baby mama shiloh mother costa rica">
                  <div class="mem-person-name">Silvia</div>
                  <div class="mem-person-role">Shiloh's Mother</div>
                  <div class="mem-person-detail">Based in Costa Rica.</div>
                </div>

                <div class="mem-person mem-card" data-mem-text="kevin scout ofm agency models">
                  <div class="mem-person-name">Kevin</div>
                  <div class="mem-person-role">OFM Scout</div>
                  <div class="mem-person-detail">Deal done: model 30% gross, agency 70% gross. Kevin takes 30% of agency's 70% - his scouted models only. Beno/Bianca keep full cut on everything else.</div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- Section 2: Business Quick Facts (collapsed) -->
        <div class="mem-section reveal" data-mem-section style="transition-delay:80ms">
          <div class="mem-section-header" onclick="this.parentElement.classList.toggle('open')">
            <span class="mem-section-title">Business Quick Facts</span>
            <svg class="mem-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
          <div class="mem-section-body">
            <div class="mem-section-inner">
              <div class="mem-facts">

                <div class="mem-fact mem-card" data-mem-text="lagoon company atv rentals can-am tours tulum dubi">
                  <span class="mem-fact-label">Lagoon Company</span>
                  <span class="mem-fact-value">ATV, UTV &amp; yacht rental business in Tulum. Operating since 2021. Co-owned by Beno, Dubi (eldest brother), and Linea (Dubi's wife). Primary revenue source. Also runs yacht tours on Nopalitos lagoon - only operator in Tulum.</span>
                </div>

                <div class="mem-fact mem-card" data-mem-text="ofm agency onlyfans management bianca fanvue">
                  <span class="mem-fact-label">OFM Agency</span>
                  <span class="mem-fact-value">#1 priority. OnlyFans management agency. Co-run with Bianca. Building workflows for real and AI models on Fanvue. TikTok → IG → OF funnel. 5 chatters on standby. Kevin deal closed: scouts and manages his models, takes 30% of agency's 70% on his scouted models only. Other models: agency keeps full cut.</span>
                </div>

                <div class="mem-fact mem-card" data-mem-text="bloomingflora horticulture equipment cancelled failed">
                  <span class="mem-fact-label">Bloomingflora</span>
                  <span class="mem-fact-value">Indoor horticulture equipment company. Cancelled. Generated close to $500k revenue in one year before shutting down.</span>
                </div>

                <div class="mem-fact mem-card" data-mem-text="sirewall rammed earth construction building sustainable">
                  <span class="mem-fact-label">Sirewall</span>
                  <span class="mem-fact-value">Rammed-earth construction system. Being evaluated for the Hilltop Villa build in Oaxaca. Known for thermal mass and sustainability.</span>
                </div>

                <div class="mem-fact mem-card" data-mem-text="location tulum oaxaca puerto escondido mexico move">
                  <span class="mem-fact-label">Location</span>
                  <span class="mem-fact-value">Currently in Tulum. Moving to Puerto Escondido / Oaxaca area May 2026. Ocean-view land acquired for Hilltop Villa + separate farm plot.</span>
                </div>

                <div class="mem-fact mem-card" data-mem-text="nationality nigerian beno entrepreneur">
                  <span class="mem-fact-label">B&#x0113;no</span>
                  <span class="mem-fact-value">Nigerian. Entrepreneur &amp; CMO. DISC type: DI (Dominant/Influencing). Driven by ROI, power, and fear of mediocrity. Christian faith as grounding element.</span>
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- Section 3: Key Decisions (collapsed) -->
        <div class="mem-section reveal" data-mem-section style="transition-delay:160ms">
          <div class="mem-section-header" onclick="this.parentElement.classList.toggle('open')">
            <span class="mem-section-title">Key Decisions</span>
            <svg class="mem-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
          <div class="mem-section-body">
            <div class="mem-section-inner">
              <div class="mem-decisions">

                <div class="mem-decision mem-card" data-mem-text="puerto escondido move relocation oaxaca mexico tulum">
                  <div class="mem-decision-title">Moving to Puerto Escondido</div>
                  <div class="mem-decision-text">Relocating from Tulum to Puerto Escondido, Oaxaca in May 2026. Proximity to land for Hilltop Villa and farm projects. Personal vehicle fleet moving too.</div>
                </div>

                <div class="mem-decision mem-card" data-mem-text="oaxaca land property hilltop villa farm build">
                  <div class="mem-decision-title">Acquired land in Oaxaca</div>
                  <div class="mem-decision-text">Purchased ocean-view land for the Hilltop Villa project and a separate plot for the off-grid farm. Both in the greater Oaxaca coast area.</div>
                </div>

                <div class="mem-decision mem-card" data-mem-text="fear mediocrity ambition drive excellence">
                  <div class="mem-decision-title">Fear of mediocrity as a driver</div>
                  <div class="mem-decision-text">Core personal value: the fear of living a mediocre life is a primary motivator. Prefers bold moves and calculated risks over comfortable stagnation.</div>
                </div>

                <div class="mem-decision mem-card" data-mem-text="christian faith religion values belief">
                  <div class="mem-decision-title">Christian faith</div>
                  <div class="mem-decision-text">Faith is a grounding element. Influences long-term decisions, ethical framework, and perspective on purpose and stewardship.</div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- Section 4: Contacts (collapsed) -->
        <div class="mem-section reveal" data-mem-section style="transition-delay:240ms">
          <div class="mem-section-header" onclick="this.parentElement.classList.toggle('open')">
            <span class="mem-section-title">Contacts</span>
            <svg class="mem-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
          <div class="mem-section-body">
            <div class="mem-section-inner">
              <div class="mem-contacts-grid">

                <div class="mem-contact-empty mem-card" data-mem-text="">
                  <div class="mem-contact-plus">+</div>
                  <div class="mem-contact-label">Add contact</div>
                </div>

                <div class="mem-contact-empty mem-card" data-mem-text="">
                  <div class="mem-contact-plus">+</div>
                  <div class="mem-contact-label">Add contact</div>
                </div>

                <div class="mem-contact-empty mem-card" data-mem-text="">
                  <div class="mem-contact-plus">+</div>
                  <div class="mem-contact-label">Add contact</div>
                </div>

                <div class="mem-contact-empty mem-card" data-mem-text="">
                  <div class="mem-contact-plus">+</div>
                  <div class="mem-contact-label">Add contact</div>
                </div>

              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

  </main>

  <!-- ======== JAVASCRIPT ======== -->
  <script>
    /* ---- Kanban: Data Model ---- */
    var KANBAN_COLUMNS = ['todo', 'inprogress', 'review', 'backlog', 'recurring', 'completed'];
    var KANBAN_COLUMN_LABELS = {
      todo: 'To Do', inprogress: 'In Progress', review: 'Review',
      backlog: 'Backlog', recurring: 'Recurring', completed: 'Completed'
    };
    var KANBAN_PROJECTS = ['OFM Agency', 'Digital Products', 'Lagoon Company', 'Hilltop Villa', 'Farm / Off-Grid', 'App Development', 'OpenClaw'];
    var KANBAN_AGENTS = [
      { name: 'Piia', color: '#7C9EF5' },
      { name: 'Kat',  color: '#B07CE8' },
      { name: 'Rex',  color: '#5CB85C' },
      { name: 'Zara', color: '#E8A87C' },
      { name: 'Mara', color: '#E87CA8' },
      { name: 'Nile', color: '#7CD4E8' },
      { name: 'Nova', color: '#F5A623' }
    ];

    /* ---- Agent Avatar Helpers ---- */
    function agentColor(name) {
      for (var i = 0; i < KANBAN_AGENTS.length; i++) {
        if (KANBAN_AGENTS[i].name === name) return KANBAN_AGENTS[i].color;
      }
      return '#555555';
    }
    function agentAvatar(name, sizeClass) {
      var initials = name.substring(0, 2);
      var color = agentColor(name);
      var cls = 'agent-avatar' + (sizeClass ? ' ' + sizeClass : '');
      return '<div class="' + cls + '" style="background:' + color + '">' + initials + '</div>';
    }
    var KANBAN_PRIORITIES = ['Urgent', 'High', 'Medium', 'Low'];
    var kanbanNextId = 100;
    function kanbanId() { return 'kb-' + (kanbanNextId++); }

    var kanbanTasks = [
      { id: kanbanId(), title: 'Kevin deal closed - 30% of agency cut', description: 'Done. Kevin scouts and manages his own models only. Model: 30% gross. Agency: 70% gross. Kevin takes 30% of the agency 70% - his scouted models only. Beno/Bianca keep full 70% on all other models.', project: 'OFM Agency', priority: 'Low', agent: 'Beno', status: 'completed', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Create Fanvue AI model account', description: 'Set up the AI model account on Fanvue - full creation and setup flow. Can walk through it together.', project: 'OFM Agency', priority: 'Urgent', agent: 'Beno', status: 'todo', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-02-27', startDate: '2026-02-24' },
      { id: kanbanId(), title: 'Extract chatter workflows from Nate Aston OFM course', description: 'Beno reviewed the course. Piia to extract key chatter workflows, AI model creation systems, and ops frameworks into a structured briefing doc for implementation.', project: 'OFM Agency', priority: 'High', agent: 'Piia', status: 'todo', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-03-03', startDate: '2026-02-26' },
      { id: kanbanId(), title: 'Set up ComfyUI on vast.ai GPU', description: 'Installed and running on vast.ai. Beno working through tutorials. Base model + NSFW generation workflows in progress.', project: 'OFM Agency', priority: 'High', agent: 'Beno', status: 'done', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-02-22', startDate: '2026-02-21' },
      { id: kanbanId(), title: 'Eco-yacht Facebook ad', description: 'Ad is live. Need to locate FB account login to monitor performance.', project: 'Lagoon Company', priority: 'Medium', agent: 'Beno', status: 'inprogress', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-02-25', startDate: '2026-02-23' },
      { id: kanbanId(), title: 'Puerto Escondido fleet strategy', description: 'Called contact - recommendation: target La Punta (affluent tourist zone). Either partner with someone there or operate directly. Premium vehicles (Can-Am, Polaris) are well-suited.', project: 'Lagoon Company', priority: 'Medium', agent: 'Beno', status: 'completed', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Set up Discord bot', description: 'Log into discord.com/developers/applications with balsas.clawsbx account. Create app named Piia, generate bot token, enable Message Content Intent, invite to server. Send token to Piia.', project: 'OpenClaw', priority: 'Medium', agent: 'Beno', status: 'todo', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-03-10', startDate: '2026-03-07' },
      { id: kanbanId(), title: 'Set up WhatsApp bridge (Baileys)', description: 'Bridge live at port 3000. LaunchAgent auto-restarts on boot. Auth saved. Send endpoint: POST http://localhost:3000/send. Read endpoints: /chats /messages/:jid /labels.', project: 'OpenClaw', priority: 'High', agent: 'Beno', status: 'done', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-02-25', startDate: '2026-02-22' },
      { id: kanbanId(), title: 'Condominio fine dispute - send letter', description: 'Letter drafted and ready. Two penalty charges ($1,800 + $1,824) disputed. Key argument: no formal written warning before either fine. Bianca sends to Mariana Rubio when ready.', project: 'OpenClaw', priority: 'High', agent: 'Beno', status: 'review', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-02-24', startDate: '2026-02-22' },
      { id: kanbanId(), title: 'OpenClaw skills stack setup', description: '14+ custom skills built and live: voice-caller, model-usage, ga4, standup-bot, thread-distill, receipt-snap, social-mine, dm-copilot, model-router, onboard-wizard, context-rescue, session-recap, skill-scanner, fact-vault, qwen3-tts. All in workspace/skills/.', project: 'OpenClaw', priority: 'Medium', agent: 'Piia', status: 'done', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Fix morning-brief & skill-scout delivery', description: 'Root cause found and fixed - both crons now have correct Telegram channel + chat ID in delivery config.', project: 'OpenClaw', priority: 'High', agent: 'Piia', status: 'completed', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Deploy Mission Control to GitHub Pages', description: 'Repo: github.com/balsas37/mission-control. Live at balsas37.github.io/mission-control. Auto-deploys via bin/deploy-mission-control.sh on every update.', project: 'OpenClaw', priority: 'High', agent: 'Piia', status: 'completed', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Build voice-journal skill', description: 'Send a Telegram voice note - Piia transcribes and structures it into a journal entry in today\'s daily note. Feeds nightly dream cycle. Green-lit by Beno.', project: 'OpenClaw', priority: 'Medium', agent: 'Zara', status: 'todo', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-03-20', startDate: '2026-03-13' },
      { id: kanbanId(), title: 'Off-Grid Power Independence - product brief', description: 'Brief: research/power-independence-brief.md (2,482 lines). Full product stack built: 24 worksheets, 5,832 lines. Bonus stack complete. Sales page written.', project: 'Digital Products', priority: 'Urgent', agent: 'Nova', status: 'completed', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Select course hosting platform', description: 'Options: GoHighLevel (GHL), Skool, Teachable, Thinkific. Beno leaning toward GoHighLevel. Decide once product brief is finalized.', project: 'Digital Products', priority: 'High', agent: 'Beno', status: 'completed', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-02-23', startDate: '2026-02-22' },
      { id: kanbanId(), title: 'Build product stack - worksheets + bonus stack', description: '6 pillars, 24 worksheets, 5 reference tables, 6 Quick Win cards, Battery Mastery Guide, Equipment Shopping List, Emergency Protocols, DFY intake form.', project: 'Digital Products', priority: 'High', agent: 'Nova', status: 'done', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-03-01', startDate: '2026-02-22' },
      { id: kanbanId(), title: 'Build sales page + Facebook ad campaign', description: 'Sales page and 4 funnel pages written (sales, OTO1, OTO2, thank-you). FB ad campaign blocked until Stripe is connected in Systeme.io and FB Ads login is found.', project: 'Digital Products', priority: 'High', agent: 'Rex', status: 'inprogress', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-03-10', startDate: '2026-03-03' },
      { id: kanbanId(), title: 'Children Learning Reading - product 2', description: 'Course login saved. Phonics/reading methods for kids. Beno qualifies (parent of Shiloh + baby coming). Queue after off-grid product is live.', project: 'Digital Products', priority: 'Low', agent: 'Nova', status: 'backlog', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Brat Busters parenting - product 3', description: 'Course login saved. 3 courses: Behaviour Board (16 lessons), Bootcamp 3-12 (83 lessons), Toddler Potty Party (6 lessons). Queue after product 1 is live.', project: 'Digital Products', priority: 'Low', agent: 'Nova', status: 'backlog', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Create Systeme.io account', description: 'Go to systeme.io - free plan, no credit card. Create account, verify email, connect Stripe. This is the platform for Power Independence Academy launch.', project: 'Digital Products', priority: 'Urgent', agent: 'Beno', status: 'completed', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-02-23', startDate: '2026-02-22' },
      { id: kanbanId(), title: 'Build Power Independence Academy funnel on Systeme.io', description: 'Map and build: (1) $27 checkout page, (2) $47 OTO1 - Calculator + Equipment Guide + Emergency Protocols, (3) $97 OTO2 - Done-For-You System Design, (4) $17/mo membership upsell, (5) Thank you page + delivery. Email sequence: 5-email welcome flow.', project: 'Digital Products', priority: 'Urgent', agent: 'Nova', status: 'todo', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-03-07', startDate: '2026-02-28' },
      { id: kanbanId(), title: 'Build DFY System Design intake form + delivery workflow', description: 'Workflow: product/dfy-fulfillment-workflow.md. System spec template: product/dfy-system-spec-template.md. 72hr SLA, Google Form intake, PDF delivery. Piia handles PVWatts calc + spec completion.', project: 'Digital Products', priority: 'High', agent: 'Zara', status: 'done', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-03-12', startDate: '2026-03-07' },
      { id: kanbanId(), title: 'Apply Jared Codling copywriting style to sales page', description: 'Beno was recommended a copywriting course by Jared Codling - name TBD. Once Beno shares it, run a refinement pass on Mara sales copy using that framework. Core structure stays, polish layer changes.', project: 'Digital Products', priority: 'Medium', agent: 'Mara', status: 'backlog', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Connect Mission Control to live data source', description: 'Aitable Earnings Report (87 bookings) → data/lagoon.json → MC Analytics tab. Live metrics: monthly revenue, net income, bookings, top vehicle, all-time totals. Daily sync cron 6 AM Cancun.', project: 'OpenClaw', priority: 'Low', agent: 'Zara', status: 'done', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Add Piia to Lagoon Company WhatsApp', description: 'Bridge live, QR scanned, auth saved. LaunchAgent auto-restarts. Endpoints: /send /chats /messages/:jid /labels. Next: booking automation workflows.', project: 'Lagoon Company', priority: 'High', agent: 'Beno', status: 'done', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-02-27', startDate: '2026-02-25' },
      { id: kanbanId(), title: 'Get Aitable.ai API token', description: 'API token in config/aitable.env. Earnings Report datasheet ID: dsttxcVs6TgtMQQf69. 87 bookings synced.', project: 'Lagoon Company', priority: 'High', agent: 'Beno', status: 'done', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-02-24', startDate: '2026-02-23' },
      { id: kanbanId(), title: 'Build Aitable.ai booking schema + MC analytics integration', description: 'DONE 2026-02-27 — Live data fetch from Aitable Earnings Report. Analytics tab shows real monthly revenue, booking count, net income, top vehicle, all-time stats. Recent bookings table with live records. Daily sync cron at 6 AM Cancun via bin/sync-mc-data.sh.', project: 'Lagoon Company', priority: 'High', agent: 'Piia', status: 'done', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-03-15', startDate: '2026-03-08' },
      { id: kanbanId(), title: 'Locate Lagoon Company Facebook Ads account login', description: 'Eco-yacht ad is live but account login needs to be found. Needed to monitor performance and manage future campaigns.', project: 'Lagoon Company', priority: 'Medium', agent: 'Beno', status: 'todo', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-02-25', startDate: '2026-02-24' },
      { id: kanbanId(), title: 'Connect Stripe to Systeme.io', description: 'Systeme.io → Settings → Payment → Connect Stripe. Unblocks the entire Digital Products funnel (checkout pages, OTOs, email sequences) and Rex FB ad campaign launch.', project: 'Digital Products', priority: 'Urgent', agent: 'Beno', status: 'todo', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-03-01', startDate: '2026-02-28' },
      { id: kanbanId(), title: 'Finish ComfyUI tutorials + design content pipeline', description: 'Working through 8-9 ComfyUI workflow tutorials on vast.ai. After completion: design OFM content pipeline (model → generate → review → post workflow).', project: 'OFM Agency', priority: 'High', agent: 'Beno', status: 'inprogress', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-03-07', startDate: '2026-02-27' },
      { id: kanbanId(), title: 'Post GitHub issue reports - context overflow bug', description: 'Two reports ready: (1) github.com/router-for-me/CLIProxyAPI — gzip decompression failure corrupts error response, blocks OpenClaw compaction. (2) github.com/openclaw/openclaw — retry doom loop when compaction cannot fire. Text drafted, needs gh auth or manual post.', project: 'OpenClaw', priority: 'Low', agent: 'Beno', status: 'todo', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Build WhatsApp booking automation workflows', description: 'WhatsApp bridge is live. Build automation: (1) incoming booking inquiry detection, (2) auto-reply with pricing/availability, (3) booking confirmation flow, (4) day-before reminder. Use Piia as the brain via bridge.', project: 'Lagoon Company', priority: 'Medium', agent: 'Nova', status: 'todo', createdAt: Date.now(), movedAt: Date.now(), dueDate: '2026-03-14', startDate: '2026-03-07' },
      { id: kanbanId(), title: 'Build voice-caller skill', description: 'Wraps OpenClaw native voice-call plugin (Twilio/Telnyx/Plivo). Supports notify mode (one-way TTS call) and conversation mode (interactive IVR navigation). Requires one-time plugin install + VoIP provider config.', project: 'OpenClaw', priority: 'Medium', agent: 'Piia', status: 'done', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Build model-usage skill + MC analytics', description: '/usage command shows Anthropic + Kimi token usage with progress bars and reset timers. Kimi actual spend tracked. Syncs to MC analytics 4x daily via cron. Anthropic section links to claude.ai/settings for real plan bars (not accessible via API).', project: 'OpenClaw', priority: 'Medium', agent: 'Piia', status: 'done', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Build GA4 skill', description: 'Queries GA4 Data API via service account. Reports: overview, top pages, traffic sources, realtime. No browser OAuth needed. Requires GCP service account key + GA4 Viewer access.', project: 'OpenClaw', priority: 'Low', agent: 'Piia', status: 'done', createdAt: Date.now(), movedAt: Date.now() },
      { id: kanbanId(), title: 'Mission Control mobile + UI fixes (Feb 28)', description: 'Calendar event chips now wrap text on mobile. Inbox KB view toggle matches Cards/Table toggle style. Mobile: metric pills centered, KB toggle pinned right. Active pill states consistent across all toggles.', project: 'OpenClaw', priority: 'Medium', agent: 'Piia', status: 'done', createdAt: Date.now(), movedAt: Date.now() }
    ];
    var kanbanViewMode = 'kanban';

    /* ---- Tab Switching ---- */
    const tabs = document.querySelectorAll('.sidebar-nav-item');
    const panels = document.querySelectorAll('.tab-panel');

    var isAnimating = false;
    var revealObserver;

    function switchTab(tabId) {
      if (isAnimating) return;
      var currentPanel = document.querySelector('.tab-panel.active');
      var newTab = document.querySelector('.sidebar-nav-item[data-tab="' + tabId + '"]');
      var newPanel = document.getElementById('panel-' + tabId);
      if (!newTab || !newPanel || currentPanel === newPanel) return;

      isAnimating = true;
      tabs.forEach(function(t) { t.classList.remove('active'); });
      newTab.classList.add('active');
      try { localStorage.setItem('mc-active-tab', tabId); } catch(e) {}

      // On mobile, close sidebar after nav
      if (window.innerWidth <= 768 && !document.body.classList.contains('sidebar-collapsed')) {
        document.body.classList.add('sidebar-collapsed');
      }

      if (currentPanel) {
        currentPanel.classList.add('tab-exit');
        setTimeout(function() {
          currentPanel.classList.remove('active', 'tab-exit');
          newPanel.classList.add('active', 'tab-enter');
          // Re-observe reveal elements in new panel
          if (revealObserver) {
            newPanel.querySelectorAll('.reveal:not(.revealed)').forEach(function(el) {
              revealObserver.observe(el);
            });
          }
          setTimeout(function() {
            newPanel.classList.remove('tab-enter');
            isAnimating = false;
            // If switching to calendar, re-render with any loaded lagoon data
            if (tabId === 'calendar') {
              if (lagoonData) injectLagoonCalendarEvents(lagoonData);
              calRender();
            }
          }, 180);
        }, 180);
      } else {
        newPanel.classList.add('active');
        isAnimating = false;
      }
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        switchTab(tab.dataset.tab);
      });
    });

    /* ---- Restore last active tab from localStorage ---- */
    (function() {
      try {
        var saved = localStorage.getItem('mc-active-tab');
        if (saved && saved !== 'office' && document.getElementById('panel-' + saved)) {
          // Bypass animation for initial load
          var initPanel = document.querySelector('.tab-panel.active');
          var initTab = document.querySelector('.sidebar-nav-item[data-tab="' + saved + '"]');
          var initNewPanel = document.getElementById('panel-' + saved);
          if (initTab && initNewPanel && initPanel !== initNewPanel) {
            tabs.forEach(function(t) { t.classList.remove('active'); });
            if (initPanel) initPanel.classList.remove('active');
            initTab.classList.add('active');
            initNewPanel.classList.add('active');
          }
        }
      } catch(e) {}
    })();

    /* ---- Theme Toggle ---- */
    (function() {
      var html = document.documentElement;
      var saved = localStorage.getItem('mc-theme') || 'dark';
      html.setAttribute('data-theme', saved);
      var moonIcon = document.getElementById('theme-icon-moon');
      var sunIcon  = document.getElementById('theme-icon-sun');
      function syncIcons(theme) {
        if (theme === 'light') {
          moonIcon.style.display = 'none';
          sunIcon.style.display  = 'block';
        } else {
          moonIcon.style.display = 'block';
          sunIcon.style.display  = 'none';
        }
      }
      syncIcons(saved);
      document.getElementById('theme-toggle').addEventListener('click', function() {
        var current = html.getAttribute('data-theme');
        var next = current === 'light' ? 'dark' : 'light';
        html.setAttribute('data-theme', next);
        localStorage.setItem('mc-theme', next);
        syncIcons(next);
      });
    })();

    /* ---- Keyboard Shortcuts (1-8) ---- */
    const tabIds = ['office', 'inbox', 'projects', 'team', 'calendar', 'analytics', 'focus', 'memory'];

    document.addEventListener('keydown', (e) => {
      const tag = document.activeElement.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT' || document.activeElement.isContentEditable) return;

      const num = parseInt(e.key);
      if (num >= 1 && num <= 8) {
        e.preventDefault();
        switchTab(tabIds[num - 1]);
      }
      if (e.key === '[') {
        e.preventDefault();
        toggleSidebar();
      }
    });

    /* ---- Sidebar Toggle ---- */
    var sidebarToggleBtn = document.getElementById('sidebar-toggle');
    var sidebarBackdrop = document.getElementById('sidebar-backdrop');
    var SIDEBAR_STORAGE_KEY = 'mc-sidebar-collapsed';

    function toggleSidebar() {
      document.body.classList.toggle('sidebar-collapsed');
      try { localStorage.setItem(SIDEBAR_STORAGE_KEY, document.body.classList.contains('sidebar-collapsed') ? '1' : '0'); } catch(e) {}
    }

    (function initSidebar() {
      var isMobile = window.innerWidth <= 768;
      var stored = null;
      try { stored = localStorage.getItem(SIDEBAR_STORAGE_KEY); } catch(e) {}
      if (isMobile) {
        document.body.classList.add('sidebar-collapsed');
      } else if (stored === '1') {
        document.body.classList.add('sidebar-collapsed');
      }
    })();

    sidebarToggleBtn.addEventListener('click', toggleSidebar);

    sidebarBackdrop.addEventListener('click', function() {
      document.body.classList.add('sidebar-collapsed');
      try { localStorage.setItem(SIDEBAR_STORAGE_KEY, '1'); } catch(e) {}
    });

    var lastWasMobile = window.innerWidth <= 768;
    window.addEventListener('resize', function() {
      var isMobile = window.innerWidth <= 768;
      if (isMobile && !lastWasMobile) {
        document.body.classList.add('sidebar-collapsed');
      } else if (!isMobile && lastWasMobile) {
        var stored = null;
        try { stored = localStorage.getItem(SIDEBAR_STORAGE_KEY); } catch(e) {}
        if (stored === '1') {
          document.body.classList.add('sidebar-collapsed');
        } else {
          document.body.classList.remove('sidebar-collapsed');
        }
      }
      lastWasMobile = isMobile;
    });

    /* ---- Live Clock ---- */
    const clockTime = document.getElementById('clock-time');
    const clockDate = document.getElementById('clock-date');

    function updateClock() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      clockTime.textContent = `${h}:${m}:${s}`;

      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      clockDate.textContent = `${days[now.getDay()]} ${months[now.getMonth()]} ${now.getDate()}`;
    }

    updateClock();
    setInterval(updateClock, 1000);

    /* ---- Piia Terminal Typewriter ---- */
    const piiaLines = [
      'session: main',
      'model: claude-sonnet-4-6',
      'memory: loaded \u2713',
      'user: Beno',
      'projects: 5 active',
      'status: ready \u203A'
    ];

    function typewriterEffect(elementId, lines, charDelay) {
      charDelay = charDelay || 40;
      const el = document.getElementById(elementId);
      if (!el) return;
      el.textContent = '';
      let lineIdx = 0, charIdx = 0;

      function typeNext() {
        if (lineIdx >= lines.length) {
          const cursor = document.createElement('span');
          cursor.className = 'terminal-cursor';
          el.appendChild(cursor);
          return;
        }

        const line = lines[lineIdx];
        if (charIdx === 0 && lineIdx > 0) {
          el.appendChild(document.createElement('br'));
        }

        if (charIdx < line.length) {
          el.appendChild(document.createTextNode(line[charIdx]));
          charIdx++;
          setTimeout(typeNext, charDelay);
        } else {
          lineIdx++;
          charIdx = 0;
          setTimeout(typeNext, charDelay * 3);
        }
      }

      setTimeout(typeNext, 500);
    }

    typewriterEffect('piia-terminal', piiaLines, 40);

    /* ---- Kanban: Helpers ---- */
    function escapeHtml(str) {
      var div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }
    function priorityToPill(p) {
      return { Urgent: 'pill-urgent', High: 'pill-high', Medium: 'pill-medium', Low: 'pill-low' }[p] || 'pill-backlog';
    }
    function agentEmoji(name) {
      return agentAvatar(name, 'agent-avatar-sm');
    }
    function isThisWeek(ts) {
      var now = new Date();
      var start = new Date(now);
      start.setDate(now.getDate() - now.getDay());
      start.setHours(0, 0, 0, 0);
      return ts >= start.getTime();
    }

    /* ---- Kanban: Metrics ---- */
    function updateKanbanMetrics() {
      var total = kanbanTasks.length, inProg = 0, completed = 0, moved = 0;
      for (var i = 0; i < kanbanTasks.length; i++) {
        if (kanbanTasks[i].status === 'inprogress') inProg++;
        if (kanbanTasks[i].status === 'completed') completed++;
        if (isThisWeek(kanbanTasks[i].movedAt)) moved++;
      }
      var pct = total > 0 ? Math.round((completed / total) * 100) : 0;
      var el;
      el = document.getElementById('kb-metric-week'); if (el) el.textContent = moved;
      el = document.getElementById('kb-metric-progress'); if (el) el.textContent = inProg;
      el = document.getElementById('kb-metric-total'); if (el) el.textContent = total;
      el = document.getElementById('kb-metric-pct'); if (el) el.textContent = pct + '%';
      var badge = document.getElementById('inbox-badge');
      if (badge) {
        var remaining = total - completed;
        badge.textContent = remaining;
        badge.style.display = remaining > 0 ? '' : 'none';
        badge.classList.remove('pop');
        void badge.offsetWidth;
        badge.classList.add('pop');
      }
    }

    /* ---- Inbox pill abbreviations (list + board only) ---- */
    function abbrevProject(name) {
      return name === 'Lagoon Company' ? 'Lagoon Co.' : name;
    }

    /* ---- Kanban: Render Card ---- */
    function renderKanbanCard(task) {
      var pill = priorityToPill(task.priority);
      var em = agentEmoji(task.agent);
      return '<div class="kb-card" draggable="true" data-task-id="' + task.id + '" data-status="' + task.status + '" data-priority="' + task.priority + '">'
        + '<div class="kb-card-title">' + escapeHtml(task.title) + '</div>'
        + '<div class="kb-card-desc">' + escapeHtml(task.description) + '</div>'
        + '<div class="kb-card-footer">'
        + '<span class="kb-card-project" data-task-id="' + task.id + '">' + escapeHtml(abbrevProject(task.project)) + '</span>'
        + '<span class="pill ' + pill + '">' + task.priority + '</span>'
        + '<span class="kb-card-agent">' + em + ' ' + escapeHtml(task.agent) + '</span>'
        + '</div></div>';
    }

    /* ---- Kanban: Render Form ---- */
    function renderKanbanForm(col) {
      var po = '', pr = '', ao = '';
      KANBAN_PROJECTS.forEach(function(p) { po += '<option value="' + p + '">' + p + '</option>'; });
      KANBAN_PRIORITIES.forEach(function(p) { pr += '<option value="' + p + '"' + (p === 'Medium' ? ' selected' : '') + '>' + p + '</option>'; });
      KANBAN_AGENTS.forEach(function(a) { ao += '<option value="' + a.name + '">' + a.name.substring(0,2) + ' ' + a.name + '</option>'; });
      return '<div class="kb-form" data-form-column="' + col + '">'
        + '<input class="kb-form-input" type="text" placeholder="Task title..." data-field="title" autocomplete="off">'
        + '<textarea class="kb-form-textarea" placeholder="Short description..." data-field="description"></textarea>'
        + '<select class="kb-form-select" data-field="project">' + po + '</select>'
        + '<select class="kb-form-select" data-field="priority">' + pr + '</select>'
        + '<select class="kb-form-select" data-field="agent">' + ao + '</select>'
        + '<div class="kb-form-actions">'
        + '<button class="kb-form-cancel" data-action="cancel">Cancel</button>'
        + '<button class="kb-form-save" data-action="save">Save</button>'
        + '</div></div>';
    }

    /* ---- Kanban: Drag & Drop ---- */
    var kanbanDraggedId = null;
    function attachKanbanDragHandlers() {
      var board = document.getElementById('kb-board');
      if (!board) return;
      board.querySelectorAll('.kb-card').forEach(function(card) {
        card.addEventListener('dragstart', function(e) {
          kanbanDraggedId = card.dataset.taskId;
          card.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', card.dataset.taskId);
        });
        card.addEventListener('dragend', function() {
          card.classList.remove('dragging');
          kanbanDraggedId = null;
          board.querySelectorAll('.kb-card-list.drag-over').forEach(function(z) { z.classList.remove('drag-over'); });
        });
      });
      board.querySelectorAll('.kb-card-list').forEach(function(zone) {
        zone.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          zone.classList.add('drag-over');
        });
        zone.addEventListener('dragleave', function(e) {
          if (!zone.contains(e.relatedTarget)) zone.classList.remove('drag-over');
        });
        zone.addEventListener('drop', function(e) {
          e.preventDefault();
          zone.classList.remove('drag-over');
          var taskId = e.dataTransfer.getData('text/plain');
          var targetCol = zone.dataset.column;
          if (!taskId || !targetCol) return;
          for (var i = 0; i < kanbanTasks.length; i++) {
            if (kanbanTasks[i].id === taskId && kanbanTasks[i].status !== targetCol) {
              kanbanTasks[i].status = targetCol;
              kanbanTasks[i].movedAt = Date.now();
              break;
            }
          }
          renderKanbanBoard();
          var dropped = document.querySelector('.kb-card[data-task-id="' + taskId + '"]');
          if (dropped) {
            dropped.classList.add('just-dropped');
            setTimeout(function() { dropped.classList.remove('just-dropped'); }, 250);
          }
        });
      });
    }

    /* ---- Kanban: New Task Form ---- */
    var kanbanOpenForm = null;
    function openKanbanForm(col) {
      closeKanbanForm();
      kanbanOpenForm = col;
      var cardList = document.querySelector('.kb-card-list[data-column="' + col + '"]');
      if (!cardList) return;
      cardList.insertAdjacentHTML('afterbegin', renderKanbanForm(col));
      var input = cardList.querySelector('.kb-form-input[data-field="title"]');
      if (input) input.focus();
      var form = cardList.querySelector('.kb-form');
      form.querySelector('[data-action="save"]').addEventListener('click', function() { saveKanbanForm(form); });
      form.querySelector('[data-action="cancel"]').addEventListener('click', function() { closeKanbanForm(); });
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); saveKanbanForm(form); }
        if (e.key === 'Escape') closeKanbanForm();
      });
    }
    function saveKanbanForm(formEl) {
      var title = formEl.querySelector('[data-field="title"]').value.trim();
      if (!title) { formEl.querySelector('[data-field="title"]').style.borderColor = 'var(--pill-urgent-text)'; return; }
      kanbanTasks.push({
        id: kanbanId(),
        title: title,
        description: formEl.querySelector('[data-field="description"]').value.trim(),
        project: formEl.querySelector('[data-field="project"]').value,
        priority: formEl.querySelector('[data-field="priority"]').value,
        agent: formEl.querySelector('[data-field="agent"]').value,
        status: formEl.dataset.formColumn,
        createdAt: Date.now(),
        movedAt: Date.now()
      });
      kanbanOpenForm = null;
      renderKanbanBoard();
    }
    function closeKanbanForm() {
      kanbanOpenForm = null;
      var existing = document.querySelector('.kb-form');
      if (existing) existing.remove();
    }

    /* ---- Task Detail Modal ---- */
    function openTaskModal(taskId) {
      var task = null;
      for (var i = 0; i < kanbanTasks.length; i++) { if (kanbanTasks[i].id === taskId) { task = kanbanTasks[i]; break; } }
      if (!task) return;
      var mn = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      var statusColors = { todo:'#6b7280', inprogress:'#6BA8DA', review:'#A86DBF', backlog:'#C49A35', recurring:'#5AB8B0', completed:'#6BBF6B' };
      var statusLabels = { todo:'To Do', inprogress:'In Progress', review:'Review', backlog:'Backlog', recurring:'Recurring', completed:'Completed' };
      var sc = statusColors[task.status] || '#6b7280';
      var aColor = agentColor(task.agent);
      var dateHtml = '';
      if (task.startDate || task.dueDate) {
        dateHtml = '<div class="task-modal-dates">';
        if (task.startDate) { var sd = new Date(task.startDate + 'T12:00:00'); dateHtml += '<div class="task-modal-date-chip"><span>Start</span>' + mn[sd.getMonth()] + ' ' + sd.getDate() + ', 2026</div>'; }
        if (task.dueDate)   { var dd = new Date(task.dueDate   + 'T12:00:00'); dateHtml += '<div class="task-modal-date-chip"><span>Due</span>'   + mn[dd.getMonth()] + ' ' + dd.getDate()   + ', 2026</div>'; }
        dateHtml += '</div>';
      }
      var html = '<div class="task-modal-backdrop" id="kb-task-modal-backdrop">'
        + '<div class="task-modal" id="kb-task-modal" role="dialog" aria-modal="true">'
        + '<div class="task-modal-header">'
        + '<div class="task-modal-status-bar" style="background:' + sc + '"></div>'
        + '<div class="task-modal-title">' + escapeHtml(task.title) + '</div>'
        + '<button class="task-modal-close" id="kb-task-modal-close" aria-label="Close">&times;</button>'
        + '</div>'
        + '<div class="task-modal-meta">'
        + '<div class="task-modal-meta-item"><span class="task-modal-meta-label">Status&nbsp;</span><span style="color:' + sc + '">' + (statusLabels[task.status] || task.status) + '</span></div>'
        + '<div class="task-modal-meta-item"><span class="task-modal-meta-label">Project&nbsp;</span>' + escapeHtml(task.project) + '</div>'
        + '<div class="task-modal-meta-item"><span class="task-modal-meta-label">Agent&nbsp;</span><span style="color:' + aColor + '">' + escapeHtml(task.agent) + '</span></div>'
        + '<div class="task-modal-meta-item"><span class="task-modal-meta-label">Priority&nbsp;</span>' + escapeHtml(task.priority) + '</div>'
        + '</div>'
        + '<div class="task-modal-body">'
        + '<div class="task-modal-desc-label">Description</div>'
        + '<div class="task-modal-desc">' + escapeHtml(task.description || 'No description.') + '</div>'
        + dateHtml
        + '</div>'
        + '</div></div>';
      document.body.insertAdjacentHTML('beforeend', html);
      var backdrop = document.getElementById('kb-task-modal-backdrop');
      document.getElementById('kb-task-modal-close').addEventListener('click', closeTaskModal);
      backdrop.addEventListener('click', function(e) { if (e.target === backdrop) closeTaskModal(); });
      function escClose(e) { if (e.key === 'Escape') { closeTaskModal(); document.removeEventListener('keydown', escClose); } }
      document.addEventListener('keydown', escClose);
    }
    function closeTaskModal() {
      var el = document.getElementById('kb-task-modal-backdrop');
      if (el) el.remove();
    }

    /* ---- Kanban: Project Dropdown ---- */
    function openProjectDropdown(el) {
      closeProjectDropdown();
      var taskId = el.dataset.taskId;
      var current = el.textContent.trim();
      var html = '<div class="kb-card-project-dropdown" id="kb-project-dropdown">';
      KANBAN_PROJECTS.forEach(function(p) {
        html += '<div class="kb-card-project-dropdown-item' + (p === current ? ' selected' : '') + '" data-project="' + p + '">' + p + '</div>';
      });
      html += '</div>';
      el.style.position = 'relative';
      el.insertAdjacentHTML('beforeend', html);
      var dd = document.getElementById('kb-project-dropdown');
      dd.querySelectorAll('.kb-card-project-dropdown-item').forEach(function(item) {
        item.addEventListener('click', function(e) {
          e.stopPropagation();
          for (var i = 0; i < kanbanTasks.length; i++) {
            if (kanbanTasks[i].id === taskId) { kanbanTasks[i].project = item.dataset.project; break; }
          }
          closeProjectDropdown();
          renderKanbanBoard();
        });
      });
      setTimeout(function() { document.addEventListener('click', closeProjectDropdownOutside); }, 0);
    }
    function closeProjectDropdown() {
      var dd = document.getElementById('kb-project-dropdown');
      if (dd) dd.remove();
      document.removeEventListener('click', closeProjectDropdownOutside);
    }
    function closeProjectDropdownOutside(e) {
      var dd = document.getElementById('kb-project-dropdown');
      if (dd && !dd.contains(e.target)) closeProjectDropdown();
    }

    var STATUS_COLOURS = {
      todo:       '#6b7280',
      inprogress: '#60a5fa',
      review:     '#a78bfa',
      backlog:    '#f59e0b',
      recurring:  '#2dd4bf',
      completed:  '#4ade80'
    };

    /* ---- Kanban: Render Board ---- */
    function renderKanbanBoard() {
      var board = document.getElementById('kb-board');
      if (!board) return;
      var filter = 'all';
      try {
        var activeFilterEl = document.querySelector('.inbox-filter.active');
        if (activeFilterEl) filter = activeFilterEl.dataset.filter;
      } catch(e) {}
      var html = '';
      KANBAN_COLUMNS.forEach(function(colKey) {
        var allColTasks = kanbanTasks.filter(function(t) { return t.status === colKey; });
        var colTasks = allColTasks.filter(function(t) {
          var isMine = t.agent === 'Beno';
          if (filter === 'mine')  return isMine;
          if (filter === 'agent') return !isMine;
          if (filter === 'done')  return colKey === 'completed';
          if (filter === 'active') return colKey !== 'completed';
          return true;
        });
        if (filter === 'done' && colKey !== 'completed') return;
        // Default sort: soonest due date first, undated tasks at bottom
        colTasks.sort(function(a, b) {
          var da = a.dueDate ? new Date(a.dueDate) : null;
          var db = b.dueDate ? new Date(b.dueDate) : null;
          if (da && db) return da - db;
          if (da) return -1;
          if (db) return 1;
          return 0;
        });
        var dotColour = STATUS_COLOURS[colKey] || '#6b7280';
        var countStr = (colTasks.length !== allColTasks.length) ? (colTasks.length + '/' + allColTasks.length) : String(colTasks.length);
        html += '<div class="kb-column" data-column="' + colKey + '">';
        html += '<div class="kb-col-header">';
        html += '<span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:' + dotColour + ';flex-shrink:0;margin-right:6px;"></span>';
        html += '<span class="kb-col-title" style="color:' + dotColour + '">' + KANBAN_COLUMN_LABELS[colKey] + '</span>';
        html += '<span class="kb-col-count">' + countStr + '</span>';
        html += '<button class="kb-col-add" data-add-column="' + colKey + '" title="Add task">+</button>';
        html += '</div>';
        html += '<div class="kb-card-list" data-column="' + colKey + '">';
        colTasks.forEach(function(task) { html += renderKanbanCard(task); });
        html += '</div></div>';
      });
      board.innerHTML = html;
      attachKanbanDragHandlers();
      board.querySelectorAll('.kb-col-add').forEach(function(btn) {
        btn.addEventListener('click', function() { openKanbanForm(btn.dataset.addColumn); });
      });
      board.querySelectorAll('.kb-card-project').forEach(function(el) {
        el.addEventListener('click', function(e) { e.stopPropagation(); openProjectDropdown(el); });
      });
      // Click card to open detail modal
      board.querySelectorAll('.kb-card').forEach(function(card) {
        card.addEventListener('click', function(e) {
          if (e.target.closest('.kb-card-project')) return;
          openTaskModal(card.dataset.taskId);
        });
      });
      updateKanbanMetrics();
    }

    /* ---- Kanban: View Toggle ---- */
    document.querySelectorAll('.kb-view-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.kb-view-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        kanbanViewMode = btn.dataset.view;
        try { localStorage.setItem('mc-inbox-view', kanbanViewMode); } catch(e) {}
        var boardEl = document.getElementById('kb-board');
        var listEl = document.getElementById('kb-list-view');
        var metricsEl = document.getElementById('kb-metrics');
        var filtersEl = document.getElementById('kb-filters');
        if (kanbanViewMode === 'kanban') {
          boardEl.style.display = '';
          metricsEl.style.display = '';
          listEl.classList.add('kb-list-hidden');
          if (filtersEl) filtersEl.style.display = '';
          renderKanbanBoard();
        } else {
          boardEl.style.display = 'none';
          /* metricsEl stays visible in list view */
          listEl.classList.remove('kb-list-hidden');
          if (filtersEl) filtersEl.style.display = '';
          renderListView();
        }
      });
    });

    /* ---- Kanban: List View ---- */
    var STATUS_OPTIONS = [
      { value: 'todo',       label: 'To Do' },
      { value: 'inprogress', label: 'In Progress' },
      { value: 'review',     label: 'Review' },
      { value: 'backlog',    label: 'Backlog' },
      { value: 'recurring',  label: 'Recurring' },
      { value: 'completed',  label: 'Done' }
    ];

    function renderListView() {
      var mineCol = document.querySelector('#kb-list-view .inbox-col[data-col="mine"]');
      var agentCol = document.querySelector('#kb-list-view .inbox-col[data-col="agent"]');
      if (!mineCol || !agentCol) return;
      mineCol.querySelectorAll('.inbox-task').forEach(function(el) { el.remove(); });
      agentCol.querySelectorAll('.inbox-task').forEach(function(el) { el.remove(); });

      var activeFilter = (document.querySelector('.inbox-filter.active') || {}).dataset || {};
      var filter = activeFilter.filter || 'all';

      kanbanTasks.forEach(function(task) {
        var pill = priorityToPill(task.priority);
        var sClass = 'status-' + task.status;
        var done = task.status === 'completed' ? ' done' : '';
        var em = agentEmoji(task.agent);
        var isMine = task.agent === 'Beno';
        var colType = isMine ? 'mine' : 'agent';

        // Build status select options
        var selectOpts = STATUS_OPTIONS.map(function(opt) {
          return '<option value="' + opt.value + '"' + (task.status === opt.value ? ' selected' : '') + '>' + opt.label + '</option>';
        }).join('');

        var html = '<div class="inbox-task ' + sClass + done + '" data-task-id="' + task.id + '" data-col-type="' + colType + '">'
          + '<div class="inbox-task-title">' + escapeHtml(task.title) + '</div>'
          + '<div class="inbox-task-desc">' + escapeHtml(task.description) + '</div>'
          + '<div class="inbox-task-meta">'
          + '<span class="inbox-task-project">' + escapeHtml(abbrevProject(task.project)) + '</span>'
          + '<span class="inbox-task-assignee">' + em + ' ' + escapeHtml(task.agent) + '</span>'
          + '<span class="pill ' + pill + '">' + task.priority + '</span>'
          + '<select class="task-status-select" data-task-id="' + task.id + '" title="Change status">' + selectOpts + '</select>'
          + '</div></div>';

        if (isMine) mineCol.insertAdjacentHTML('beforeend', html);
        else agentCol.insertAdjacentHTML('beforeend', html);
      });

      // Attach status change listeners
      document.querySelectorAll('#kb-list-view .task-status-select').forEach(function(sel) {
        sel.addEventListener('change', function(e) {
          e.stopPropagation();
          var taskId = sel.dataset.taskId;
          var newStatus = sel.value;
          for (var i = 0; i < kanbanTasks.length; i++) {
            if (kanbanTasks[i].id === taskId) {
              kanbanTasks[i].status = newStatus;
              kanbanTasks[i].movedAt = Date.now();
              break;
            }
          }
          saveKanbanState();
          renderListView();
          updateKanbanMetrics();
        });
        sel.addEventListener('click', function(e) { e.stopPropagation(); });
      });

      // Apply current filter (use saved if available)
      try {
        var savedFilter = localStorage.getItem('mc-inbox-filter');
        if (savedFilter) filter = savedFilter;
      } catch(e) {}
      applyListFilter(filter);

      // Re-attach filter buttons
      document.querySelectorAll('.inbox-filter').forEach(function(btn) {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.inbox-filter').forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          try { localStorage.setItem('mc-inbox-filter', btn.dataset.filter); } catch(e) {}
          applyListFilter(btn.dataset.filter);
          if (kanbanViewMode === 'kanban') renderKanbanBoard();
        });
      });
    }

    function applyListFilter(filter) {
      var listEl = document.getElementById('kb-list-view');
      if (listEl) {
        listEl.classList.toggle('filter-done', filter === 'done');
      }
      document.querySelectorAll('#kb-list-view .inbox-task').forEach(function(task) {
        var isDone = task.classList.contains('done') || task.querySelector('.task-status-select')?.value === 'completed';
        var colType = task.dataset.colType;
        var show = filter === 'all'
          || (filter === 'active' && !isDone)
          || (filter === 'mine' && colType === 'mine' && !isDone)
          || (filter === 'agent' && colType === 'agent' && !isDone)
          || (filter === 'done' && isDone);
        task.style.display = show ? '' : 'none';
      });
    }

    /* ---- Kanban: Persistence ---- */
    function saveKanbanState() {
      try {
        var overrides = kanbanTasks.map(function(t) { return { id: t.id, status: t.status, movedAt: t.movedAt, dueDate: t.dueDate || null, startDate: t.startDate || null }; });
        localStorage.setItem('mc-kanban-state', JSON.stringify(overrides));
      } catch(e) {}
    }
    function loadKanbanState() {
      try {
        var saved = JSON.parse(localStorage.getItem('mc-kanban-state') || '[]');
        var map = {};
        saved.forEach(function(s) { map[s.id] = s; });
        kanbanTasks.forEach(function(t) {
          if (map[t.id]) {
            t.status = map[t.id].status;
            t.movedAt = map[t.id].movedAt;
            if (map[t.id].dueDate) t.dueDate = map[t.id].dueDate;
            if (map[t.id].startDate) t.startDate = map[t.id].startDate;
          }
        });
      } catch(e) {}
    }
    loadKanbanState();

    /* ---- Kanban: Init ---- */
    renderKanbanBoard();
    // Show filters on kanban (default view)
    (function() {
      var filtersEl = document.getElementById('kb-filters');
      if (filtersEl) filtersEl.style.display = '';
      // Restore saved filter
      try {
        var savedFilter = localStorage.getItem('mc-inbox-filter');
        if (savedFilter) {
          var btn = document.querySelector('.inbox-filter[data-filter="' + savedFilter + '"]');
          if (btn) { document.querySelectorAll('.inbox-filter').forEach(function(b) { b.classList.remove('active'); }); btn.classList.add('active'); renderKanbanBoard(); }
        }
      } catch(e) {}
    })();
    // Restore inbox view mode
    (function() {
      try {
        var savedInboxView = localStorage.getItem('mc-inbox-view');
        if (savedInboxView) {
          var targetBtn = document.querySelector('[data-view="' + savedInboxView + '"]');
          if (targetBtn && targetBtn.closest('#panel-inbox')) { targetBtn.click(); }
        }
      } catch(e) {}
    })();

    /* ---- Analytics: Date Range Toggle ---- */
    document.querySelectorAll('.analytics-filter').forEach(function(btn) {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.analytics-filter').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
      });
    });

    /* ---- Analytics: Airtable-style Tables ---- */
    var analyticsData = {
      ofm: [
        { metric: 'Monthly Revenue', value: '$3,200', rawValue: 3200, change: '+12%', dir: 'positive', sparkline: [8,12,10,14,16,18,15,20], status: 'green', progress: 64 },
        { metric: 'Active Creators', value: '2', rawValue: 2, change: '+100%', dir: 'positive', sparkline: [4,4,6,6,8,8,10,16], status: 'green', progress: null },
        { metric: 'Total Fans', value: '847', rawValue: 847, change: '+23%', dir: 'positive', sparkline: [6,8,10,12,14,16,18,24], status: 'green', progress: null },
        { metric: 'Avg Revenue/Creator', value: '$1,600', rawValue: 1600, change: '+8%', dir: 'positive', sparkline: [12,14,10,16,14,18,16,20], status: 'green', progress: null },
        { metric: 'Messages Sent', value: '1,240', rawValue: 1240, change: '+34%', dir: 'positive', sparkline: [8,10,14,12,18,16,22,24], status: 'green', progress: null },
        { metric: 'Conversion Rate', value: '4.2%', rawValue: 4.2, change: '-0.3%', dir: 'negative', sparkline: [18,16,20,14,16,12,14,12], status: 'amber', progress: null }
      ],
      lagoon: [
        { metric: 'Monthly Revenue', value: '$8,400', rawValue: 8400, change: '+5%', dir: 'positive', sparkline: [16,18,14,20,18,22,20,24], status: 'green', progress: null },
        { metric: 'Rentals This Month', value: '67', rawValue: 67, change: '+12%', dir: 'positive', sparkline: [10,12,14,16,18,20,18,24], status: 'green', progress: null },
        { metric: 'Fleet Utilization', value: '78%', rawValue: 78, change: '+3%', dir: 'positive', sparkline: [14,16,18,16,20,18,22,24], status: 'green', progress: null },
        { metric: 'Most Rented', value: 'Can-Am Maverick X3', rawValue: 0, change: '--', dir: 'neutral', sparkline: null, status: 'green', progress: null },
        { metric: 'Google Ads ROAS', value: '3.4x', rawValue: 3.4, change: '+0.6x', dir: 'positive', sparkline: [8,10,12,14,16,18,20,24], status: 'green', progress: null },
        { metric: 'Instagram Followers', value: '4,200', rawValue: 4200, change: '+340', dir: 'positive', sparkline: [10,12,14,16,18,20,22,24], status: 'green', progress: null }
      ]
    };

    function renderSparklineSVG(points) {
      if (!points || !points.length) return '';
      var mx = Math.max.apply(null, points), w = 80, h = 24, p = 2;
      var coords = points.map(function(v, i) {
        return (p + (i/(points.length-1))*(w-p*2)).toFixed(1) + ',' + (h-p-((v/mx)*(h-p*2))).toFixed(1);
      });
      return '<div class="analytics-sparkline-cell"><svg viewBox="0 0 '+w+' '+h+'"><polyline points="'+coords.join(' ')+'"/></svg></div>';
    }

    function renderAnalyticsTable(key) {
      var data = analyticsData[key], tbody = document.getElementById(key + '-analytics-body');
      if (!data || !tbody) return;
      var html = '';
      data.forEach(function(row) {
        var arrow = row.dir === 'positive' ? '&#x25B2;' : (row.dir === 'negative' ? '&#x25BC;' : '');
        var prog = row.progress !== null ? '<div class="analytics-inline-progress"><div class="analytics-inline-progress-fill" style="width:'+row.progress+'%"></div></div>' : '';
        html += '<tr class="analytics-row">';
        html += '<td class="analytics-td">' + row.metric + '</td>';
        html += '<td class="analytics-td analytics-td-value">' + row.value + prog + '</td>';
        html += '<td class="analytics-td"><span class="analytics-td-change ' + row.dir + '">' + arrow + ' ' + row.change + '</span></td>';
        html += '<td class="analytics-td">' + renderSparklineSVG(row.sparkline) + '</td>';
        html += '<td class="analytics-td" style="color:var(--text-3);font-size:12px;">' + (row.prev || (row.status ? '<span class="analytics-status-dot ' + row.status + '"></span>' : '')) + '</td>';
        html += '</tr>';
      });
      tbody.innerHTML = html;
    }

    document.querySelectorAll('.analytics-section-header').forEach(function(h) {
      h.addEventListener('click', function() {
        h.classList.toggle('collapsed');
        var wrap = document.getElementById(h.dataset.collapse);
        if (wrap) wrap.style.display = h.classList.contains('collapsed') ? 'none' : '';
      });
    });

    document.querySelectorAll('.analytics-table .analytics-th[data-sort]').forEach(function(th) {
      th.addEventListener('click', function() {
        var table = th.closest('.analytics-table'), tbody = table.querySelector('tbody');
        var rows = Array.from(tbody.querySelectorAll('.analytics-row'));
        var ci = Array.from(th.parentNode.children).indexOf(th), asc = !th.classList.contains('sorted-asc');
        table.querySelectorAll('.analytics-th').forEach(function(x) { x.classList.remove('sorted','sorted-asc','sorted-desc'); });
        th.classList.add('sorted', asc ? 'sorted-asc' : 'sorted-desc');
        rows.sort(function(a, b) {
          var at = a.children[ci].textContent.trim(), bt = b.children[ci].textContent.trim();
          var an = parseFloat(at.replace(/[^0-9.\-]/g,'')), bn = parseFloat(bt.replace(/[^0-9.\-]/g,''));
          if (!isNaN(an) && !isNaN(bn)) return asc ? an-bn : bn-an;
          return asc ? at.localeCompare(bt) : bt.localeCompare(at);
        });
        rows.forEach(function(r) { tbody.appendChild(r); });
      });
    });

    renderAnalyticsTable('ofm');
    renderAnalyticsTable('lagoon');

    /* ---- Aitable Live Data: Lagoon Company ---- */
    var lagoonData = null; // cached JSON
    var lagoonRange = 'month'; // active date range

    function renderLagoonRange(range) {
      if (!lagoonData || !lagoonData.ranges) return;
      var rows = lagoonData.ranges[range];
      if (rows && rows.length) {
        analyticsData.lagoon = rows;
        renderAnalyticsTable('lagoon');
      }
    }

    function renderBookingTable(tbodyId, bookings, cols) {
      var tbody = document.getElementById(tbodyId);
      if (!tbody) return;
      if (!bookings || !bookings.length) { tbody.innerHTML = '<tr><td colspan="' + cols + '" class="analytics-td" style="color:var(--text-3);text-align:center">None</td></tr>'; return; }
      var html = '';
      bookings.forEach(function(b) {
        html += '<tr class="analytics-row">';
        if (cols === 7 && tbodyId === 'lagoon-active-body') {
          html += '<td class="analytics-td">' + (b.name||'—') + '</td>';
          html += '<td class="analytics-td">' + (b.vehicle||'—') + '</td>';
          html += '<td class="analytics-td">' + (b.location||'—') + '</td>';
          html += '<td class="analytics-td" style="white-space:nowrap">' + b.start + ' → ' + b.end + '</td>';
          html += '<td class="analytics-td">' + (b.days||'—') + '</td>';
          html += '<td class="analytics-td analytics-td-value">$' + (b.gross||0).toLocaleString() + '</td>';
          html += '<td class="analytics-td">' + (b.source||'—') + '</td>';
        } else {
          html += '<td class="analytics-td">' + (b.name||'—') + '</td>';
          html += '<td class="analytics-td">' + (b.vehicle||'—') + '</td>';
          html += '<td class="analytics-td">' + (b.location||'—') + '</td>';
          html += '<td class="analytics-td">' + (b.start||'—') + '</td>';
          html += '<td class="analytics-td">' + (b.end||'—') + '</td>';
          html += '<td class="analytics-td">' + (b.days||'—') + '</td>';
          html += '<td class="analytics-td analytics-td-value">$' + (b.gross||0).toLocaleString() + '</td>';
        }
        html += '</tr>';
      });
      tbody.innerHTML = html;
    }

    (function fetchLagoonLiveData() {
      var badge = document.getElementById('lagoon-data-badge');
      fetch('data/lagoon.json?_=' + Date.now())
        .then(function(r) { return r.ok ? r.json() : Promise.reject(r.status); })
        .then(function(d) {
          lagoonData = d;
          // Render initial range
          renderLagoonRange(lagoonRange);
          if (badge) badge.textContent = '✓ live · Aitable';

          // Wire up date range filter buttons for Lagoon
          document.querySelectorAll('.analytics-filter').forEach(function(btn) {
            btn.addEventListener('click', function() {
              document.querySelectorAll('.analytics-filter').forEach(function(b) { b.classList.remove('active'); });
              btn.classList.add('active');
              lagoonRange = btn.dataset.range || 'month';
              renderLagoonRange(lagoonRange);
            });
          });

          // Active bookings
          var activeWrap = document.getElementById('lagoon-active-wrap');
          var upcomingWrap = document.getElementById('lagoon-upcoming-wrap');
          var emptyState = document.getElementById('lagoon-bookings-empty');
          var syncTime = document.getElementById('lagoon-sync-time');

          var hasActive = d.active_bookings && d.active_bookings.length > 0;
          var hasUpcoming = d.upcoming_bookings && d.upcoming_bookings.length > 0;

          if (hasActive) {
            renderBookingTable('lagoon-active-body', d.active_bookings, 7);
            if (activeWrap) activeWrap.style.display = '';
          }
          if (hasUpcoming) {
            renderBookingTable('lagoon-upcoming-body', d.upcoming_bookings, 7);
            if (upcomingWrap) upcomingWrap.style.display = '';
          }
          if (!hasActive && !hasUpcoming && emptyState) emptyState.style.display = '';

          // Inject Lagoon bookings into the calendar
          injectLagoonCalendarEvents(d);

          if (syncTime && d.generated) {
            var gen = new Date(d.generated);
            syncTime.textContent = 'Synced ' + gen.toLocaleDateString('en-US', {month:'short', day:'numeric'}) + ' · ' + gen.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
          }
        })
        .catch(function(err) {
          if (badge) badge.textContent = '⚠ estimates only';
          console.warn('[MC] Lagoon data fetch failed:', err);
        });
    })();

    /* ---- Model Usage Bars ---- */
    (function fetchUsageData() {
      function fmtM(n) {
        if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
        if (n >= 1e3) return (n/1e3).toFixed(0) + 'k';
        return n ? String(n) : '0';
      }
      function barHTML(pct, cls) {
        var w = Math.min(100, Math.max(0, pct));
        var color = pct >= 80 ? '#EF4444' : pct >= 60 ? '#F59E0B' : '';
        var style = color ? ' style="background:' + color + '"' : '';
        return '<div class="usage-bar-track"><div class="usage-bar-fill ' + cls + '"' + style + ' style="width:' + w + '%;' + (color ? 'background:' + color : '') + '"></div></div>';
      }
      // Live countdown from UTC reset timestamp
      function liveCountdown(resetUtc) {
        if (!resetUtc) return '';
        var reset = new Date(resetUtc).getTime();
        var diff = Math.max(0, reset - Date.now());
        if (diff === 0) return 'Resetting now';
        var h = Math.floor(diff / 3600000);
        var m = Math.floor((diff % 3600000) / 60000);
        var s = Math.floor((diff % 60000) / 1000);
        if (h > 48) {
          var d = Math.floor(h / 24); h = h % 24;
          return 'Resets in ' + d + 'd ' + h + 'h';
        }
        return h > 0 ? 'Resets in ' + h + 'h ' + m + 'm' : 'Resets in ' + m + 'm ' + s + 's';
      }
      // Store usage data globally for live ticker
      var _usageData = null;

      function renderUsage() {
        var d = _usageData; if (!d) return;
        var el = document.getElementById('usage-bars');
        var syncEl = document.getElementById('usage-sync-time');
        if (!el) return;

        var gen = new Date(d.generated);
        if (syncEl) syncEl.textContent = 'Synced ' + gen.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit'});

        var al = d.anthropic_live || {}; var k = d.kimi || {};
        var sess = al.session || {}; var wall = al.weekly_all || {}; var wson = al.weekly_sonnet || {};
        var extra = al.extra_usage || {};

        var kTodayPct = k.today_tokens > 0 ? Math.min(100, Math.round((k.today_tokens / 500000) * 100)) : 0;
        var kWeekPct  = k.week_tokens  > 0 ? Math.min(100, Math.round((k.week_tokens  / 2000000) * 100)) : 0;
        var kimiCostWeek = parseFloat(k.week_cost_usd||0).toFixed(3);
        var kimiCostDay  = parseFloat(k.today_cost_usd||0).toFixed(3);

        el.innerHTML =
          '<div class="usage-provider">' +
            '<div class="usage-provider-header">' +
              '<span class="usage-provider-name">Anthropic · Claude Max</span>' +
              '<span class="usage-provider-plan">$200/mo flat</span>' +
            '</div>' +
            '<div class="usage-row">' +
              '<div class="usage-row-label"><span class="usage-row-label-left">Session</span>' +
              '<span class="usage-row-label-right usage-countdown" data-reset="' + (sess.reset_utc||'') + '">' + (sess.pct||0) + '% · ' + liveCountdown(sess.reset_utc) + '</span></div>' +
              barHTML(sess.pct||0, 'anthropic') +
            '</div>' +
            '<div class="usage-row">' +
              '<div class="usage-row-label"><span class="usage-row-label-left">Weekly · All</span>' +
              '<span class="usage-row-label-right usage-countdown" data-reset="' + (wall.reset_utc||'') + '">' + (wall.pct||0) + '% · ' + liveCountdown(wall.reset_utc) + '</span></div>' +
              barHTML(wall.pct||0, 'anthropic') +
            '</div>' +
            '<div class="usage-row">' +
              '<div class="usage-row-label"><span class="usage-row-label-left">Weekly · Sonnet</span>' +
              '<span class="usage-row-label-right usage-countdown" data-reset="' + (wson.reset_utc||'') + '">' + (wson.pct||0) + '% · ' + liveCountdown(wson.reset_utc) + '</span></div>' +
              barHTML(wson.pct||0, 'anthropic') +
            '</div>' +
            (extra.balance_usd !== undefined ? '<div style="font-size:11px;color:var(--text-3);margin-top:6px;">Extra: $' + (extra.spent_usd||0).toFixed(2) + ' spent · $' + extra.balance_usd.toFixed(2) + ' balance</div>' : '') +
          '</div>' +
          '<div class="usage-divider"></div>' +
          '<div class="usage-provider">' +
            '<div class="usage-provider-header">' +
              '<span class="usage-provider-name">Moonshot · Kimi K2.5</span>' +
              '<span class="usage-provider-plan">pay-per-token</span>' +
              (parseFloat(kimiCostWeek) > 0 ? '<span class="usage-cost-badge">$' + kimiCostWeek + ' this week</span>' : '') +
            '</div>' +
            '<div class="usage-row">' +
              '<div class="usage-row-label"><span class="usage-row-label-left">Today</span>' +
              '<span class="usage-row-label-right">' + fmtM(k.today_tokens||0) + ' · $' + kimiCostDay + '</span></div>' +
              barHTML(kTodayPct, 'kimi') +
            '</div>' +
            '<div class="usage-row">' +
              '<div class="usage-row-label"><span class="usage-row-label-left">This Week</span>' +
              '<span class="usage-row-label-right">' + fmtM(k.week_tokens||0) + ' · $' + kimiCostWeek + '</span></div>' +
              barHTML(kWeekPct, 'kimi') +
            '</div>' +
          '</div>';
      }

      // Tick every second — update all countdowns live
      setInterval(function() {
        document.querySelectorAll('.usage-countdown').forEach(function(el) {
          var reset = el.dataset.reset;
          if (!reset) return;
          var pct = el.textContent.split('%')[0];
          el.textContent = pct + '% · ' + liveCountdown(reset);
        });
      }, 1000);

      fetch('data/usage.json?_=' + Date.now())
        .then(function(r) { return r.ok ? r.json() : Promise.reject(r.status); })
        .then(function(d) { _usageData = d; renderUsage(); })
        .catch(function() {
          var el = document.getElementById('usage-bars');
          if (el) el.innerHTML = '<div style="color:var(--text-3);font-size:13px;">Usage data unavailable</div>';
        });
    })();

    /* ---- Usage Sync Button ---- */
    var SYNC_API = 'http://firstborn.local:8765';
    function triggerUsageSync() {
      var btn = document.getElementById('usage-sync-btn');
      var syncEl = document.getElementById('usage-sync-time');
      if (btn) { btn.disabled = true; btn.textContent = '⟳ Syncing…'; }
      if (syncEl) syncEl.textContent = 'Syncing…';
      fetch(SYNC_API + '/sync', { signal: AbortSignal.timeout(5000) })
        .then(function() {
          // Poll usage.json every 3s until scraped_at changes
          var prev = _usageData && _usageData.anthropic_live ? _usageData.anthropic_live.scraped_at : null;
          var attempts = 0;
          var poll = setInterval(function() {
            attempts++;
            fetch('data/usage.json?_=' + Date.now())
              .then(function(r) { return r.ok ? r.json() : Promise.reject(); })
              .then(function(d) {
                var newAt = d.anthropic_live ? d.anthropic_live.scraped_at : null;
                if (newAt !== prev || attempts > 20) {
                  clearInterval(poll);
                  _usageData = d; renderUsage();
                  if (btn) { btn.disabled = false; btn.textContent = '⟳ Sync'; }
                }
              }).catch(function() { if (attempts > 20) clearInterval(poll); });
          }, 3000);
        })
        .catch(function() {
          if (syncEl) syncEl.textContent = 'API offline — ensure sync-api-server is running on VM';
          if (btn) { btn.disabled = false; btn.textContent = '⟳ Sync'; }
        });
    }

    /* ---- View Toggle: Team & Projects ---- */
    function initViewToggle(toggleId, cardViewId, tableViewId, storageKey) {
      var toggle = document.getElementById(toggleId);
      if (!toggle) return;
      // Restore saved view
      var savedView = storageKey ? (function(){ try { return localStorage.getItem(storageKey); } catch(e) { return null; } })() : null;
      if (savedView) {
        var cv = document.getElementById(cardViewId), tv = document.getElementById(tableViewId);
        toggle.querySelectorAll('.view-toggle-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.view === savedView); });
        if (savedView === 'table') { if (cv) cv.style.display = 'none'; if (tv) tv.style.display = ''; }
        else { if (cv) cv.style.display = ''; if (tv) tv.style.display = 'none'; }
      }
      toggle.querySelectorAll('.view-toggle-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          toggle.querySelectorAll('.view-toggle-btn').forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          var cv = document.getElementById(cardViewId), tv = document.getElementById(tableViewId);
          if (btn.dataset.view === 'table') {
            if (cv) cv.style.display = 'none';
            if (tv) tv.style.display = '';
          } else {
            if (cv) cv.style.display = '';
            if (tv) tv.style.display = 'none';
          }
          if (storageKey) { try { localStorage.setItem(storageKey, btn.dataset.view); } catch(e) {} }
        });
      });
    }
    initViewToggle('team-view-toggle', 'team-card-view', 'team-table-view', 'mc-team-view');
    initViewToggle('projects-view-toggle', 'projects-card-view', 'projects-table-view', 'mc-projects-view');

    /* ---- Calendar: State & Data ---- */
    var CAL_COLORS = [
      { name: 'Blue', value: '#6BA8DA' }, { name: 'Purple', value: '#A86DBF' },
      { name: 'Green', value: '#6BBF6B' }, { name: 'Amber', value: '#DAB255' },
      { name: 'Red', value: '#D9534F' }, { name: 'Cyan', value: '#5BC0DE' }
    ];
    var calNextId = 1;
    function calEventId() { return 'cal-' + (calNextId++); }
    var calEvents = [];
    var calViewMode = 'month';
    var calViewYear = new Date().getFullYear();
    var calViewMonth = new Date().getMonth();
    var calViewWeekStart = (function() {
      var d = new Date(); var day = d.getDay();
      var diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.getFullYear(), d.getMonth(), diff);
    })();
    var calMilestones = [
      { name: 'Digital Products sprint start', date: '2026-02-22', color: '#F5A623' },
      { name: 'Power Independence - funnel live', date: '2026-03-01', color: '#F5A623' },
      { name: 'Power Independence - first sale target', date: '2026-03-15', color: '#6BBF6B' },
      { name: 'OFM - first creator live', date: '2026-03-01', color: '#6BA8DA' },
      { name: 'Move to Puerto Escondido', date: '2026-05-01', color: '#5BC0DE' },
      { name: 'Baby due - Bianca', date: '2026-08-15', color: '#A86DBF' },
      { name: 'Lagoon high season', date: '2026-12-01', color: '#DAB255' }
    ];

    function calDateKey(y, m, d) { return y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0'); }
    function calEventsForDate(dk) { return calEvents.filter(function(e) { return e.date === dk; }); }
    function calMilestonesForDate(dk) { return calMilestones.filter(function(m) { return m.date === dk; }); }

    function calUpdateTitle() {
      var el = document.getElementById('cal-title'); if (!el) return;
      var mn = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      if (calViewMode === 'month') { el.textContent = mn[calViewMonth] + ' ' + calViewYear; }
      else {
        var end = new Date(calViewWeekStart); end.setDate(end.getDate() + 6);
        if (calViewWeekStart.getMonth() === end.getMonth())
          el.textContent = mn[calViewWeekStart.getMonth()] + ' ' + calViewWeekStart.getDate() + '\u2013' + end.getDate() + ', ' + calViewWeekStart.getFullYear();
        else
          el.textContent = mn[calViewWeekStart.getMonth()].substr(0,3) + ' ' + calViewWeekStart.getDate() + ' \u2013 ' + mn[end.getMonth()].substr(0,3) + ' ' + end.getDate() + ', ' + end.getFullYear();
      }
    }

    function renderMonthView() {
      var container = document.getElementById('cal-container'); if (!container) return;
      var now = new Date(), todayY = now.getFullYear(), todayM = now.getMonth(), todayD = now.getDate();
      var firstDay = new Date(calViewYear, calViewMonth, 1).getDay();
      var startOffset = (firstDay === 0) ? 6 : firstDay - 1;
      var daysInMonth = new Date(calViewYear, calViewMonth + 1, 0).getDate();

      // Build week rows: arrays of 7 slots — {day, dk} or null for empty
      var rows = [], row = [];
      for (var i = 0; i < startOffset; i++) row.push(null);
      for (var d = 1; d <= daysInMonth; d++) {
        row.push({ day: d, dk: calDateKey(calViewYear, calViewMonth, d) });
        if (row.length === 7) { rows.push(row); row = []; }
      }
      if (row.length > 0) { while (row.length < 7) row.push(null); rows.push(row); }

      // Lagoon bookings with ISO dates
      var lagoonBookings = lagoonData ?
        (lagoonData.active_bookings || []).concat(lagoonData.upcoming_bookings || [])
          .filter(function(b) { return b.start_iso && b.end_iso; }) : [];

      var html = '<div class="cal-month-wrap">';
      // Day headers
      html += '<div class="cal-month-headers">';
      ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(function(h) { html += '<div class="cal-header">' + h + '</div>'; });
      html += '</div>';

      rows.forEach(function(weekRow) {
        html += '<div class="cal-week-row">';
        html += '<div class="cal-week-cells">';
        weekRow.forEach(function(cell) {
          if (!cell) { html += '<div class="cal-day empty"></div>'; return; }
          var isToday = (calViewYear === todayY && calViewMonth === todayM && cell.day === todayD);
          var events = calEventsForDate(cell.dk).filter(function(e) { return e.type !== 'lagoon'; });
          var milestones = calMilestonesForDate(cell.dk);
          html += '<div class="cal-day' + (isToday ? ' today' : '') + '" data-date="' + cell.dk + '">';
          html += '<div class="cal-day-num">' + cell.day + '</div>';
          if (milestones.length) html += '<div class="cal-milestone-marker" style="background:' + milestones[0].color + '" title="' + escapeHtml(milestones[0].name) + '"></div>';
          for (var e = 0; e < Math.min(events.length, 2); e++) {
            var ev = events[e];
            html += '<div class="cal-event-chip" style="background:' + ev.color + '22;color:' + ev.color + ';border-left:2px solid ' + ev.color + ';" data-event-id="' + ev.id + '">' + escapeHtml(ev.title) + '</div>';
          }
          if (events.length > 2) html += '<div class="cal-day-overflow">+' + (events.length - 2) + ' more</div>';
          // Lagoon booking chip — inside each day cell, bottom-anchored
          if (showLagoonBookings) {
            var cellDate = new Date(cell.dk + 'T12:00:00Z');
            lagoonBookings.forEach(function(b) {
              var bStart = new Date(b.start_iso + 'T12:00:00Z');
              var bEnd   = new Date(b.end_iso   + 'T12:00:00Z');
              if (cellDate >= bStart && cellDate <= bEnd) {
                var label = (b.name || 'Booking') + (b.vehicle ? ' \u00B7 ' + b.vehicle : '');
                html += '<div class="cal-lagoon-day-chip"' +
                  ' data-booking-name="' + escapeHtml(b.name||'') + '"' +
                  ' data-booking-vehicle="' + escapeHtml(b.vehicle||'') + '"' +
                  ' data-booking-location="' + escapeHtml(b.location||'') + '"' +
                  ' data-booking-start="' + escapeHtml(b.start||'') + '"' +
                  ' data-booking-end="' + escapeHtml(b.end||'') + '"' +
                  ' data-booking-days="' + (b.days||0) + '"' +
                  ' data-booking-gross="' + (b.gross||0) + '">' +
                  escapeHtml(label) + '</div>';
              }
            });
          }
          html += '</div>'; // cal-day
        });
        html += '</div>'; // cal-week-cells
        html += '</div>'; // cal-week-row
      });

      html += '</div>'; // cal-month-wrap
      container.innerHTML = html;
      calAttachHandlers();
      // Lagoon chip click → detail popup
      container.querySelectorAll('.cal-lagoon-day-chip').forEach(function(chip) {
        chip.addEventListener('click', function(e) {
          e.stopPropagation();
          openBookingPopup(chip.dataset, e.clientX, e.clientY);
        });
      });
    }

    function renderWeekView() {
      var container = document.getElementById('cal-container'); if (!container) return;
      var now = new Date(), todayKey = calDateKey(now.getFullYear(), now.getMonth(), now.getDate());
      var dayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

      // Build 7-day array
      var weekDays = [];
      for (var i = 0; i < 7; i++) {
        var date = new Date(calViewWeekStart); date.setDate(date.getDate() + i);
        weekDays.push({ date: date, dk: calDateKey(date.getFullYear(), date.getMonth(), date.getDate()) });
      }

      // Lagoon bookings
      var lagoonBookings = lagoonData ?
        (lagoonData.active_bookings || []).concat(lagoonData.upcoming_bookings || [])
          .filter(function(b) { return b.start_iso && b.end_iso; }) : [];

      var html = '<div class="cal-week-wrap"><div class="cal-week-grid">';
      weekDays.forEach(function(wd, i) {
        var isToday = (wd.dk === todayKey);
        var events = calEventsForDate(wd.dk).filter(function(e) { return e.type !== 'lagoon'; });
        var milestones = calMilestonesForDate(wd.dk);
        html += '<div class="cal-week-col' + (isToday ? ' today' : '') + '" data-date="' + wd.dk + '">';
        html += '<div class="cal-week-col-header"><div class="cal-week-day-name">' + dayNames[i] + '</div><div class="cal-week-day-num">' + wd.date.getDate() + '</div></div>';
        milestones.forEach(function(m) { html += '<div class="cal-week-event" style="border-left-color:' + m.color + ';background:' + m.color + '11;">&#x25C6; ' + escapeHtml(m.name) + '</div>'; });
        events.forEach(function(ev) {
          html += '<div class="cal-week-event" style="border-left-color:' + ev.color + ';" data-event-id="' + ev.id + '">' + escapeHtml(ev.title);
          if (ev.time) html += '<div class="cal-week-event-time">' + ev.time + '</div>';
          html += '</div>';
        });
        // Lagoon booking chip — inside each day column
        if (showLagoonBookings) {
          var cellDate = new Date(wd.dk + 'T12:00:00Z');
          lagoonBookings.forEach(function(b) {
            var bStart = new Date(b.start_iso + 'T12:00:00Z');
            var bEnd   = new Date(b.end_iso   + 'T12:00:00Z');
            if (cellDate >= bStart && cellDate <= bEnd) {
              var label = (b.name || 'Booking') + (b.vehicle ? ' \u00B7 ' + b.vehicle : '');
              html += '<div class="cal-week-event cal-lagoon-week-chip"' +
                ' data-booking-name="' + escapeHtml(b.name||'') + '"' +
                ' data-booking-vehicle="' + escapeHtml(b.vehicle||'') + '"' +
                ' data-booking-location="' + escapeHtml(b.location||'') + '"' +
                ' data-booking-start="' + escapeHtml(b.start||'') + '"' +
                ' data-booking-end="' + escapeHtml(b.end||'') + '"' +
                ' data-booking-days="' + (b.days||0) + '"' +
                ' data-booking-gross="' + (b.gross||0) + '">' +
                escapeHtml(label) + '</div>';
            }
          });
        }
        html += '</div>'; // cal-week-col
      });
      html += '</div></div>'; // cal-week-grid + cal-week-wrap
      container.innerHTML = html;
      calAttachHandlers();
      // Lagoon chip popup
      container.querySelectorAll('.cal-lagoon-week-chip').forEach(function(chip) {
        chip.addEventListener('click', function(e) {
          e.stopPropagation();
          openBookingPopup(chip.dataset, e.clientX, e.clientY);
        });
      });
    }

    /* ---- Lagoon → Calendar injection ---- */
    function injectLagoonCalendarEvents(data) {
      // Remove any old per-day lagoon chip events (legacy approach)
      calEvents = calEvents.filter(function(e) { return e.type !== 'lagoon'; });
      // Booking spans are now rendered directly by renderMonthView / renderWeekView
      // using lagoonData — no per-day event injection needed
      var panel = document.getElementById('panel-calendar');
      if (panel && panel.style.display !== 'none' && !panel.classList.contains('hidden')) calRender();
    }

    /* ---- Booking detail popup ---- */
    var calBookingPopup = null;
    function openBookingPopup(ds, x, y) {
      closeBookingPopup();
      var popup = document.createElement('div');
      popup.className = 'cal-booking-popup';
      var rows = '';
      if (ds.bookingVehicle) rows += '<div class="cal-booking-popup-row"><span>&#x1F3CD;</span><span>' + escapeHtml(ds.bookingVehicle) + '</span></div>';
      if (ds.bookingLocation) rows += '<div class="cal-booking-popup-row"><span>&#x1F4CD;</span><span>' + escapeHtml(ds.bookingLocation) + '</span></div>';
      if (ds.bookingStart && ds.bookingEnd) rows += '<div class="cal-booking-popup-row"><span>&#x1F4C5;</span><span>' + escapeHtml(ds.bookingStart) + ' &rarr; ' + escapeHtml(ds.bookingEnd) + '</span></div>';
      if (ds.bookingDays) rows += '<div class="cal-booking-popup-row"><span>&#x23F1;</span><span>' + ds.bookingDays + ' days</span></div>';
      if (ds.bookingGross) rows += '<div class="cal-booking-popup-row"><span>&#x1F4B0;</span><span>$' + Number(ds.bookingGross).toLocaleString() + ' MXN</span></div>';
      popup.innerHTML = '<div class="cal-booking-popup-title">' + escapeHtml(ds.bookingName || 'Booking') + '</div>' + rows + '<button class="cal-booking-popup-close">&#x2715;</button>';
      popup.style.left = Math.min(x + 10, window.innerWidth - 280) + 'px';
      popup.style.top  = Math.min(y + 10, window.innerHeight - 200) + 'px';
      document.body.appendChild(popup);
      calBookingPopup = popup;
      popup.querySelector('.cal-booking-popup-close').addEventListener('click', closeBookingPopup);
      setTimeout(function() { document.addEventListener('click', closeBookingPopupOutside, { once: true }); }, 50);
    }
    function closeBookingPopup() {
      if (calBookingPopup) { calBookingPopup.remove(); calBookingPopup = null; }
    }
    function closeBookingPopupOutside(e) {
      if (calBookingPopup && !calBookingPopup.contains(e.target)) closeBookingPopup();
    }

    function calRender() { calUpdateTitle(); if (calViewMode === 'timeline') { renderTimelineView(); return; } if (calViewMode === 'month') renderMonthView(); else renderWeekView(); }

    function calNavigate(dir) {
      if (calViewMode === 'month') {
        calViewMonth += dir;
        if (calViewMonth > 11) { calViewMonth = 0; calViewYear++; }
        if (calViewMonth < 0) { calViewMonth = 11; calViewYear--; }
      } else { calViewWeekStart.setDate(calViewWeekStart.getDate() + (dir * 7)); }
      calRender();
    }

    function calGoToToday() {
      var now = new Date(); calViewYear = now.getFullYear(); calViewMonth = now.getMonth();
      var day = now.getDay(), diff = now.getDate() - day + (day === 0 ? -6 : 1);
      calViewWeekStart = new Date(now.getFullYear(), now.getMonth(), diff); calRender();
    }

    function calSwitchView(mode) {
      if (calViewMode === mode) return; calViewMode = mode;
      try { localStorage.setItem('mc-cal-view', mode); } catch(e) {}
      document.querySelectorAll('.cal-view-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.view === mode); });
      if (mode === 'timeline') {
        document.getElementById('cal-container').style.display = 'none';
        document.getElementById('cal-timeline').style.display = 'block';
        document.querySelector('.cal-nav-arrows').style.visibility = 'hidden';
        renderTimelineView();
        return;
      }
      document.getElementById('cal-container').style.display = '';
      document.getElementById('cal-timeline').style.display = 'none';
      document.querySelector('.cal-nav-arrows').style.visibility = '';
      if (mode === 'week') {
        // Always jump to current week when entering week view
        var now = new Date(), wd = now.getDay();
        var off = wd === 0 ? -6 : 1 - wd; // Monday offset
        calViewWeekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() + off);
      } else {
        // Sync month to Wednesday of the displayed week (avoids month-boundary stepback bug)
        var mid = new Date(calViewWeekStart);
        mid.setDate(mid.getDate() + 3);
        calViewYear = mid.getFullYear();
        calViewMonth = mid.getMonth();
      }
      calRender();
    }

    /* ---- Timeline: Drag to Reschedule ---- */
    var tlDragState = { active: false, taskId: null, dot: null, axis: null, preview: null, pendingDate: null };
    var tlZoomDays = 253; // default: Feb 22 - Oct 31
    var tlViewCenter = new Date(2026, 4, 1).getTime(); // center: May 1 2026
    var tlListenersAdded = false;
    var tlOutsideClickAdded = false;
    var tlJustDragged = false; // prevents synthetic click opening picker after touch drag
    var showLagoonBookings = (function() {
      try { var v = localStorage.getItem('mc-cal-lagoon'); return v === null ? true : v !== 'false'; } catch(e) { return true; }
    })();

    function tlOnDragMove(clientX, clientY) {
      if (!tlDragState.active || !tlDragState.dot || !tlDragState.axis) return;
      var mn = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      // Use the ACTUAL visible range (not hardcoded dates) so drag maps correctly
      var halfMs = (tlZoomDays / 2) * 86400000;
      var sd = new Date(tlViewCenter - halfMs);
      var ed = new Date(tlViewCenter + halfMs);
      var totalMs = ed - sd;
      var rect = tlDragState.axis.getBoundingClientRect();
      if (!rect.width) return; // axis not visible — bail
      var pct = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
      var d = new Date(sd.getTime() + pct * totalMs);
      d.setHours(12, 0, 0, 0);
      tlDragState.pendingDate = d.toISOString().slice(0, 10);
      var isBarHandle = tlDragState.dot.classList.contains('tl-bar-handle');
      if (isBarHandle) {
        var bar = tlDragState.dot.closest('.tl-task-bar');
        if (bar) {
          var barLeftPct = parseFloat(bar.style.left) || 0;
          var newRightPct = Math.max(0, Math.min(100, (d - sd) / totalMs * 100));
          bar.style.width = Math.max(2, newRightPct - barLeftPct).toFixed(2) + '%';
          var barLabel = bar.querySelector('.tl-bar-label');
          if (barLabel) {
            var task = kanbanTasks.filter(function(t) { return t.id === tlDragState.taskId; })[0];
            var prefix = (task && task.startDate) ? (mn[new Date(task.startDate + 'T12:00:00').getMonth()] + ' ' + new Date(task.startDate + 'T12:00:00').getDate() + ' - ') : '';
            barLabel.textContent = prefix + mn[d.getMonth()] + ' ' + d.getDate();
          }
        }
      } else {
        tlDragState.dot.style.left = ((d - sd) / totalMs * 100).toFixed(2) + '%';
        var label = tlDragState.dot.querySelector('.tl-date-label');
        if (label) label.textContent = mn[d.getMonth()] + ' ' + d.getDate();
      }
      if (tlDragState.preview) {
        tlDragState.preview.style.left = (clientX + 14) + 'px';
        tlDragState.preview.style.top  = (clientY - 34) + 'px';
        tlDragState.preview.textContent = mn[d.getMonth()] + ' ' + d.getDate() + ', 2026';
        tlDragState.preview.style.display = 'block';
      }
    }

    function tlOnDragEnd() {
      if (!tlDragState.active) return;
      var saved = false;
      // Resolve taskId from state or directly from the element's data attribute
      var resolvedTaskId = tlDragState.taskId ||
        (tlDragState.dot && (tlDragState.dot.dataset.taskId ||
          (tlDragState.dot.closest && tlDragState.dot.closest('[data-task-id]') && tlDragState.dot.closest('[data-task-id]').dataset.taskId)));
      if (tlDragState.pendingDate && resolvedTaskId) {
        for (var i = 0; i < kanbanTasks.length; i++) {
          if (kanbanTasks[i].id === resolvedTaskId) {
            kanbanTasks[i].dueDate = tlDragState.pendingDate;
            saved = true;
            break;
          }
        }
        if (saved) saveKanbanState();
      }
      if (tlDragState.dot) tlDragState.dot.classList.remove('tl-dragging');
      if (tlDragState.preview) tlDragState.preview.style.display = 'none';
      tlDragState.active = false; tlDragState.taskId = null; tlDragState.dot = null;
      tlDragState.axis = null; tlDragState.pendingDate = null;
      // Block the synthetic click that mobile fires after touchend
      tlJustDragged = true;
      setTimeout(function() { tlJustDragged = false; }, 400);
      renderTimelineView();
    }

    function renderTimelineView() {
      var container = document.getElementById('cal-timeline');
      var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      var now = new Date();
      var halfMs   = (tlZoomDays / 2) * 86400000;
      var startDate = new Date(tlViewCenter - halfMs);
      var endDate   = new Date(tlViewCenter + halfMs);
      var totalMs  = endDate - startDate;

      function pct(date) {
        return Math.max(0, Math.min(100, (date - startDate) / totalMs * 100));
      }
      function fmtDate(d) {
        return months[d.getMonth()] + ' ' + d.getDate();
      }

      var projColors = {
        'OFM Agency':          '#B07CE8',
        'Lagoon Company':      '#5BC0DE',
        'Digital Products':    '#F5A623',
        'OpenClaw':            '#6BA8DA',
        'Hilltop Villa - Oaxaca': '#D4A843',
        'Farm / Off-Grid':     '#5CB85C',
        'App Dev':             '#888888'
      };

      var milestones = [
        { name: 'Funnel live',     date: new Date(2026, 2,  1), color: '#F5A623' },
        { name: 'First sale',      date: new Date(2026, 2, 15), color: '#F5A623' },
        { name: 'OFM creator',     date: new Date(2026, 2,  1), color: '#B07CE8' },
        { name: 'Move to PE',      date: new Date(2026, 4,  1), color: '#5BC0DE' },
        { name: 'Baby due',        date: new Date(2026, 7, 15), color: '#9B59B6' }
      ];

      // Build month grid lines
      function makeGridlines() {
        var h = '';
        var m = new Date(2026, 1, 1);
        while (m <= endDate) {
          var p = pct(m);
          if (p >= 0 && p <= 100) {
            h += '<div class="tl-gridline" style="left:' + p.toFixed(2) + '%"></div>';
          }
          m = new Date(m.getFullYear(), m.getMonth() + 1, 1);
        }
        // Today line
        if (now >= startDate && now <= endDate) {
          h += '<div class="tl-today-line" style="left:' + pct(now).toFixed(2) + '%"></div>';
        }
        return h;
      }

      var html = '<div class="tl-wrap"><div class="tl-inner">';

      // Header row: month labels
      html += '<div class="tl-header-row">';
      html += '<div class="tl-row-label" style="font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:.06em;display:flex;align-items:center;padding-right:6px">Task</div>';
      html += '<div class="tl-axis" style="position:relative;height:28px">';
      html += makeGridlines();
      var m2 = new Date(2026, 1, 1);
      while (m2 <= endDate) {
        var p2 = pct(m2);
        if (p2 >= 0 && p2 <= 100) {
          html += '<span class="tl-month-label" style="left:' + p2.toFixed(2) + '%">' + months[m2.getMonth()] + '</span>';
        }
        m2 = new Date(m2.getFullYear(), m2.getMonth() + 1, 1);
      }
      html += '</div></div>';

      // Milestones: one row per milestone (Asana-style, no label overlap)
      html += '<div class="tl-section-label"><span>Milestones</span></div>';
      milestones.forEach(function(ms) {
        var p = pct(ms.date);
        html += '<div class="tl-row tl-ms-row">';
        html += '<div class="tl-row-label" style="color:' + ms.color + ';font-size:11px"><span style="margin-right:5px">&#x25C6;</span>' + ms.name + '<span style="color:var(--text-3);font-size:10px;margin-left:6px">' + fmtDate(ms.date) + '</span></div>';
        html += '<div class="tl-axis" style="position:relative;height:36px">';
        html += makeGridlines();
        html += '<div class="tl-diamond" style="left:' + p.toFixed(2) + '%;background:' + ms.color + ';top:50%" title="' + ms.name + ' - ' + fmtDate(ms.date) + ' 2026"></div>';
        html += '</div></div>';
      });

      // Scheduled tasks (bars if startDate, dots if only dueDate)
      var scheduled = kanbanTasks.filter(function(t) { return t.dueDate && t.status !== 'completed'; });
      var unscheduled = kanbanTasks.filter(function(t) { return !t.dueDate && t.status !== 'completed' && t.status !== 'backlog'; });

      if (scheduled.length > 0) {
        html += '<div class="tl-section-label"><span>Scheduled</span></div>';
        scheduled.sort(function(a, b) { return new Date(a.startDate||a.dueDate) - new Date(b.startDate||b.dueDate); });
        scheduled.forEach(function(task) {
          var d = new Date(task.dueDate + 'T12:00:00');
          var color = projColors[task.project] || '#888';
          var isPast = d < now;
          var hasBar = !!task.startDate;
          html += '<div class="tl-row">';
          html += '<div class="tl-row-label" title="' + task.title + '"><span class="tl-proj-dot" style="background:' + color + '"></span>' + task.title + '</div>';
          html += '<div class="tl-axis" style="position:relative;height:36px">';
          html += makeGridlines();
          if (hasBar) {
            var s = new Date(task.startDate + 'T12:00:00');
            var leftPct = pct(s);
            var rightPct = pct(d);
            var widthPct = Math.max(2, rightPct - leftPct);
            html += '<div class="tl-task-bar" data-task-id="' + task.id + '" style="left:' + leftPct.toFixed(2) + '%;width:' + widthPct.toFixed(2) + '%;background:' + color + (isPast ? ';opacity:0.4' : '') + '" title="' + fmtDate(s) + ' - ' + fmtDate(d) + '">';
            html += '<span class="tl-bar-label">' + fmtDate(s) + ' - ' + fmtDate(d) + '</span>';
            html += '<div class="tl-bar-handle" data-handle="end" data-task-id="' + task.id + '" title="Drag to change due date"></div>';
            html += '</div>';
          } else {
            var p = pct(d);
            html += '<div class="tl-task-dot" data-task-id="' + task.id + '" style="left:' + p.toFixed(2) + '%;background:' + color + (isPast ? ';opacity:0.4' : '') + '" title="' + fmtDate(d) + '">';
            html += '<span class="tl-date-label">' + fmtDate(d) + '</span>';
            html += '</div>';
          }
          html += '</div></div>';
        });
      }

      if (unscheduled.length > 0) {
        html += '<div class="tl-section-label"><span>Unscheduled</span></div>';
        unscheduled.forEach(function(task) {
          var color = projColors[task.project] || '#888';
          html += '<div class="tl-row tl-unscheduled">';
          html += '<div class="tl-row-label" title="' + task.title + '"><span class="tl-proj-dot" style="background:' + color + '"></span>' + task.title + '</div>';
          html += '<div class="tl-unsched-axis tl-axis" style="height:36px;display:flex;align-items:center;padding-left:8px">';
          html += '<button class="tl-add-date-btn" data-task-id="' + task.id + '">+ Set date</button>';
          html += '</div></div>';
        });
      }

      html += '</div></div>'; // tl-inner + tl-wrap

      // Date picker popup (start + due date)
      html += '<div id="tl-date-popup" style="display:none">';
      html += '<div class="tl-popup-title">Set dates</div>';
      html += '<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px">';
      html += '<label style="font-size:11px;color:var(--text-3)">Start</label>';
      html += '<input type="date" id="tl-start-input" style="background:var(--bg-hover);border:1px solid var(--border);color:var(--text-1);border-radius:6px;padding:6px 10px;font-size:13px;font-family:inherit">';
      html += '<label style="font-size:11px;color:var(--text-3);margin-top:4px">Due</label>';
      html += '<input type="date" id="tl-date-input">';
      html += '</div>';
      html += '<div class="tl-popup-btns">';
      html += '<button class="tl-popup-save" id="tl-date-save">Save</button>';
      html += '<button class="tl-popup-clear" id="tl-date-clear">Clear</button>';
      html += '<button class="tl-popup-cancel" id="tl-date-cancel">&#x2715;</button>';
      html += '</div></div>';

      container.innerHTML = html;

      // Bind: dots + add-date buttons open picker
      var activeTlTaskId = null;
      function openTlPicker(taskId, x, y) {
        activeTlTaskId = taskId;
        var task = null;
        for (var i = 0; i < kanbanTasks.length; i++) { if (kanbanTasks[i].id === taskId) { task = kanbanTasks[i]; break; } }
        var popup = document.getElementById('tl-date-popup');
        var dueInput = document.getElementById('tl-date-input');
        var startInput = document.getElementById('tl-start-input');
        dueInput.value = (task && task.dueDate) ? task.dueDate : '';
        startInput.value = (task && task.startDate) ? task.startDate : '';
        var pw = 220, ph = 180;
        var left = Math.min(x + 10, window.innerWidth - pw - 16);
        var top  = Math.min(y + 10, window.innerHeight - ph - 16);
        popup.style.left = left + 'px';
        popup.style.top  = top  + 'px';
        popup.style.display = 'block';
        setTimeout(function() { dueInput.focus(); }, 50);
      }
      container.querySelectorAll('.tl-task-dot, .tl-task-bar, .tl-add-date-btn').forEach(function(el) {
        el.addEventListener('click', function(e) {
          if (tlJustDragged) return; // swallow synthetic click fired after touch drag
          e.stopPropagation();
          openTlPicker(el.dataset.taskId, e.clientX, e.clientY);
        });
      });
      document.getElementById('tl-date-save').addEventListener('click', function() {
        var dueVal = document.getElementById('tl-date-input').value;
        var startVal = document.getElementById('tl-start-input').value;
        if (activeTlTaskId && dueVal) {
          for (var i = 0; i < kanbanTasks.length; i++) {
            if (kanbanTasks[i].id === activeTlTaskId) {
              kanbanTasks[i].dueDate = dueVal;
              kanbanTasks[i].startDate = startVal || null;
              break;
            }
          }
          saveKanbanState();
          document.getElementById('tl-date-popup').style.display = 'none';
          renderTimelineView();
        }
      });
      document.getElementById('tl-date-clear').addEventListener('click', function() {
        if (activeTlTaskId) {
          for (var i = 0; i < kanbanTasks.length; i++) {
            if (kanbanTasks[i].id === activeTlTaskId) {
              kanbanTasks[i].dueDate = null;
              kanbanTasks[i].startDate = null;
              break;
            }
          }
          saveKanbanState();
          document.getElementById('tl-date-popup').style.display = 'none';
          renderTimelineView();
        }
      });
      document.getElementById('tl-date-cancel').addEventListener('click', function() {
        document.getElementById('tl-date-popup').style.display = 'none';
      });

      // Outside click closes popup (add listener once)
      if (!tlOutsideClickAdded) {
        tlOutsideClickAdded = true;
        document.addEventListener('click', function(e) {
          var popup = document.getElementById('tl-date-popup');
          if (popup && popup.style.display !== 'none' && !popup.contains(e.target)) {
            popup.style.display = 'none';
          }
        }, true);
      }

      // Drag to reschedule: create preview element once
      if (!tlDragState.preview) {
        var tlPreview = document.createElement('div');
        tlPreview.className = 'tl-drag-preview';
        document.body.appendChild(tlPreview);
        tlDragState.preview = tlPreview;
      }

      // Bind mousedown/touchstart on task dots and bar handles
      container.querySelectorAll('.tl-task-dot, .tl-bar-handle').forEach(function(dot) {
        var taskId = dot.dataset.taskId || (dot.closest('[data-task-id]') && dot.closest('[data-task-id]').dataset.taskId);
        dot.addEventListener('mousedown', function(e) {
          if (e.button !== 0) return;
          e.preventDefault(); e.stopPropagation();
          tlDragState.active = true;
          tlDragState.taskId = taskId;
          tlDragState.dot = dot;
          tlDragState.axis = dot.closest('.tl-axis');
          dot.classList.add('tl-dragging');
        });
        dot.addEventListener('touchstart', function(e) {
          e.preventDefault();
          // Find axis — try closest first, then walk up further
          var foundAxis = dot.closest('.tl-axis');
          if (!foundAxis) {
            var el = dot.parentElement;
            while (el && el !== document.body) {
              if (el.classList && el.classList.contains('tl-axis')) { foundAxis = el; break; }
              el = el.parentElement;
            }
          }
          if (!foundAxis) return; // can't drag without axis reference
          tlDragState.active = true;
          tlDragState.taskId = taskId;
          tlDragState.dot = dot;
          tlDragState.axis = foundAxis;
          dot.classList.add('tl-dragging');
        }, { passive: false });
      });

      // Document-level drag listeners (add once)
      if (!tlListenersAdded) {
        tlListenersAdded = true;
        document.addEventListener('mousemove', function(e) { if (tlDragState.active) tlOnDragMove(e.clientX, e.clientY); });
        document.addEventListener('mouseup',   function()  { if (tlDragState.active) tlOnDragEnd(); });
        document.addEventListener('touchmove', function(e) {
          if (tlDragState.active) {
            if (e.touches.length > 1) { tlDragState.active = false; return; } // pinch started — abort drag
            e.preventDefault();
            tlOnDragMove(e.touches[0].clientX, e.touches[0].clientY);
          }
        }, { passive: false });
        document.addEventListener('touchend',  function()  { if (tlDragState.active) tlOnDragEnd(); });

        // Pinch-to-zoom on timeline (mirrors mouse scroll wheel zoom)
        var tlPinchState = { active: false, startDist: 0, startZoom: 0, startCenter: 0, startX: 0, axisWidth: 0 };
        document.getElementById('cal-timeline').addEventListener('touchstart', function(e) {
          if (calViewMode !== 'timeline' || e.touches.length !== 2) return;
          e.preventDefault();
          var t0 = e.touches[0], t1 = e.touches[1];
          var dx = t0.clientX - t1.clientX, dy = t0.clientY - t1.clientY;
          tlPinchState.active = true;
          tlPinchState.startDist = Math.sqrt(dx*dx + dy*dy);
          tlPinchState.startZoom = tlZoomDays;
          // Anchor pinch center to timeline axis position
          var midX = (t0.clientX + t1.clientX) / 2;
          var axis = e.target.closest('.tl-axis') || document.querySelector('#cal-timeline .tl-axis');
          if (axis) {
            var rect = axis.getBoundingClientRect();
            tlPinchState.axisWidth = rect.width;
            tlPinchState.startX = midX - rect.left;
            var halfMs = tlZoomDays / 2 * 86400000;
            var sd = tlViewCenter - halfMs;
            tlPinchState.startCenter = sd + (tlPinchState.startX / rect.width) * (tlZoomDays * 86400000);
          }
        }, { passive: false });
        document.getElementById('cal-timeline').addEventListener('touchmove', function(e) {
          if (!tlPinchState.active || e.touches.length !== 2) return;
          e.preventDefault();
          var t0 = e.touches[0], t1 = e.touches[1];
          var dx = t0.clientX - t1.clientX, dy = t0.clientY - t1.clientY;
          var dist = Math.sqrt(dx*dx + dy*dy);
          var ratio = tlPinchState.startDist / dist; // spread fingers = ratio < 1 = zoom in
          tlZoomDays = Math.max(14, Math.min(500, tlPinchState.startZoom * ratio));
          // Re-anchor center so pinch midpoint stays fixed
          if (tlPinchState.axisWidth) {
            var midPct = tlPinchState.startX / tlPinchState.axisWidth;
            tlViewCenter = tlPinchState.startCenter - midPct * tlZoomDays * 86400000 + tlZoomDays / 2 * 86400000;
          }
          renderTimelineView();
        }, { passive: false });
        document.getElementById('cal-timeline').addEventListener('touchend', function(e) {
          if (e.touches.length < 2) tlPinchState.active = false;
        });
        // Timeline scroll-wheel zoom (cursor-anchored, like a video editor)
        // FIX: axis check BEFORE e.preventDefault so label column scrolls page normally
        // Pan state must be declared before wheel listener so wheel can check it
        var tlPanState = { active: false, startX: 0, startCenter: 0, axisWidth: 0, zoomDays: 0 };

        document.getElementById('cal-timeline').addEventListener('wheel', function(e) {
          if (calViewMode !== 'timeline') return;
          // CRITICAL: block zoom during active pan drag (trackpad fires both simultaneously)
          if (tlPanState.active) { e.preventDefault(); return; }
          var axis = e.target.closest('.tl-axis');
          if (!axis) return; // not over axis - let page scroll normally
          e.preventDefault();
          var rect = axis.getBoundingClientRect();
          if (!rect.width) return;
          var mouseXPct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
          var curTotalMs = tlZoomDays * 86400000;
          var curStart = tlViewCenter - curTotalMs / 2;
          var mouseDate = curStart + mouseXPct * curTotalMs;
          var factor = e.deltaY > 0 ? 1.3 : 0.77;
          tlZoomDays = Math.max(14, Math.min(500, tlZoomDays * factor));
          var newTotalMs = tlZoomDays * 86400000;
          tlViewCenter = mouseDate - mouseXPct * newTotalMs + newTotalMs / 2;
          // Sanity clamp
          if (!isFinite(tlViewCenter) || isNaN(tlViewCenter)) tlViewCenter = new Date(2026,4,1).getTime();
          renderTimelineView();
        }, { passive: false });

        // Timeline click-drag pan
        // FIX: also cache tlZoomDays at mousedown so accidental wheel events mid-drag
        // don't change the zoom level and corrupt pan distance calculation
        document.getElementById('cal-timeline').addEventListener('mousedown', function(e) {
          if (calViewMode !== 'timeline') return;
          var axis = e.target.closest('.tl-axis');
          if (!axis) return;
          if (e.target.classList.contains('tl-dot') || e.target.classList.contains('tl-bar') || e.target.classList.contains('tl-bar-handle') || e.target.classList.contains('tl-diamond')) return;
          var w = axis.getBoundingClientRect().width;
          if (!w || w <= 0) return;
          tlPanState.active = true;
          tlPanState.startX = e.clientX;
          tlPanState.startCenter = tlViewCenter;
          tlPanState.axisWidth = w;
          tlPanState.zoomDays = tlZoomDays; // snapshot zoom at drag start
          e.preventDefault();
          document.body.style.cursor = 'grabbing';
        });
        document.addEventListener('mousemove', function(e) {
          if (!tlPanState.active || !tlPanState.axisWidth) return;
          var deltaX = e.clientX - tlPanState.startX;
          // Use snapshotted zoomDays (not live tlZoomDays) so mid-drag wheel events don't corrupt
          tlViewCenter = tlPanState.startCenter - (deltaX / tlPanState.axisWidth) * (tlPanState.zoomDays * 86400000);
          if (!isFinite(tlViewCenter) || isNaN(tlViewCenter)) { tlPanState.active = false; return; }
          renderTimelineView();
        });
        document.addEventListener('mouseup', function() {
          if (tlPanState.active) { tlPanState.active = false; document.body.style.cursor = ''; }
        });

      }
    }

    function calOpenModal(dk) {
      document.getElementById('cal-event-date').value = dk;
      document.getElementById('cal-event-title').value = '';
      document.getElementById('cal-event-time').value = '';
      document.getElementById('cal-event-color').value = CAL_COLORS[0].value;
      var picker = document.getElementById('cal-color-picker'); picker.innerHTML = '';
      CAL_COLORS.forEach(function(c, i) {
        var s = document.createElement('div'); s.className = 'cal-color-swatch' + (i === 0 ? ' selected' : '');
        s.style.background = c.value; s.dataset.color = c.value;
        s.addEventListener('click', function() {
          picker.querySelectorAll('.cal-color-swatch').forEach(function(x) { x.classList.remove('selected'); });
          s.classList.add('selected'); document.getElementById('cal-event-color').value = c.value;
        });
        picker.appendChild(s);
      });
      document.getElementById('cal-modal-backdrop').style.display = 'flex';
      setTimeout(function() { document.getElementById('cal-event-title').focus(); }, 100);
    }

    function calCloseModal() { document.getElementById('cal-modal-backdrop').style.display = 'none'; }

    function calSaveEvent() {
      var title = document.getElementById('cal-event-title').value.trim();
      if (!title) { document.getElementById('cal-event-title').style.borderColor = 'var(--pill-urgent-text)'; return; }
      calEvents.push({ id: calEventId(), title: title, date: document.getElementById('cal-event-date').value,
        time: document.getElementById('cal-event-time').value || '', color: document.getElementById('cal-event-color').value });
      calCloseModal(); calRender();
    }

    function calDeleteEvent(id) { calEvents = calEvents.filter(function(e) { return e.id !== id; }); calRender(); }

    function calAttachHandlers() {
      document.querySelectorAll('.cal-day:not(.empty), .cal-week-col').forEach(function(cell) {
        cell.addEventListener('click', function(e) {
          if (e.target.closest('.cal-event-chip') || e.target.closest('.cal-week-event')) return;
          if (cell.dataset.date) calOpenModal(cell.dataset.date);
        });
      });
      document.querySelectorAll('.cal-event-chip, .cal-week-event[data-event-id]').forEach(function(chip) {
        chip.addEventListener('click', function(e) {
          e.stopPropagation();
          if (chip.dataset.eventId && confirm('Delete this event?')) calDeleteEvent(chip.dataset.eventId);
        });
      });
    }

    /* Calendar Init */
    (function() {
      // Lagoon bookings toggle
      var lagoonToggleBtn = document.getElementById('cal-lagoon-toggle');
      if (lagoonToggleBtn) {
        lagoonToggleBtn.classList.toggle('on', showLagoonBookings);
        lagoonToggleBtn.addEventListener('click', function() {
          showLagoonBookings = !showLagoonBookings;
          lagoonToggleBtn.classList.toggle('on', showLagoonBookings);
          try { localStorage.setItem('mc-cal-lagoon', showLagoonBookings); } catch(e) {}
          calRender();
        });
      }

      document.getElementById('cal-prev').addEventListener('click', function() { calNavigate(-1); });
      document.getElementById('cal-next').addEventListener('click', function() { calNavigate(1); });
      document.getElementById('cal-today').addEventListener('click', calGoToToday);
      document.querySelectorAll('.cal-view-btn').forEach(function(b) { b.addEventListener('click', function() { calSwitchView(b.dataset.view); }); });
      // Restore saved calendar view
      try {
        var savedCalView = localStorage.getItem('mc-cal-view');
        if (savedCalView && savedCalView !== 'month') { calSwitchView(savedCalView); }
      } catch(e) {}
      document.getElementById('cal-modal-close').addEventListener('click', calCloseModal);
      document.getElementById('cal-modal-cancel').addEventListener('click', calCloseModal);
      document.getElementById('cal-modal-save').addEventListener('click', calSaveEvent);
      document.getElementById('cal-modal-backdrop').addEventListener('click', function(e) { if (e.target === this) calCloseModal(); });
      document.getElementById('cal-event-title').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); calSaveEvent(); }
        if (e.key === 'Escape') calCloseModal();
      });
      calRender();
    })();

    /* ---- Focus: Project Deep-Work View ---- */
    var focusProjects = {
      ofm: {
        name: 'OFM Agency', priority: 'P1', pill: 'pill-active', pillLabel: 'Active',
        agents: ['Kat', 'Rex'],
        callout: 'Get first creator live on Fanvue with ComfyUI AI model content flowing',
        tasks: [
          'Create Fanvue AI model account (Beno)',
          'Set up ComfyUI on vast.ai GPU - today (Beno)',
          'Review OFM course - extract key workflows (Kat)',
          'Build fan messaging SOP',
          'Draft creator onboarding flow',
          'Set up 5 Filipino chatters with scripts',
          'Build content calendar template',
          'Create pricing tier + revenue split doc'
        ],
        context: 'OFM Agency co-run with Bianca. Platform: Fanvue. Kevin deal closed: he scouts and manages his own models, takes 30% of agency 70% on his models only - Beno/Bianca keep full cut on all others. 5 Filipino chatters on standby. AI models via ComfyUI + vast.ai GPU.',
        milestones: [
          { label: 'Kevin deal closed', dot: 'var(--pill-done-text)', pill: 'pill-done', pillLabel: 'Done' },
          { label: 'ComfyUI live', dot: 'var(--accent)', pill: 'pill-active', pillLabel: 'Today' },
          { label: 'First creator signed', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'Mar 2026' },
          { label: 'First $1k month', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'Upcoming' }
        ]
      },
      digital: {
        name: 'Digital Products', priority: 'P2', pill: 'pill-progress', pillLabel: 'Sprint',
        agents: ['Nova', 'Mara', 'Rex'],
        callout: 'Launch Power Independence Academy on Systeme.io - first sale by Mar 15',
        tasks: [
          'Create Systeme.io account (Beno - free plan)',
          'Apply to affiliate programs: Amazon Associates, Renogy, EcoFlow, Berkey',
          'Build full funnel on Systeme.io (Nova)',
          'Write sales page copy using 5 hooks (Mara)',
          'Build DFY System Design intake form + delivery workflow (Zara)',
          'Set up Facebook ad campaign - Appendix D targeting (Rex)',
          'Set up Instagram faceless page - homesteading niche (Rex)',
          'Build 5-email welcome sequence'
        ],
        context: 'Product 1: Power Independence Academy - 6-Pillar System for Off-Grid Energy Freedom. Funnel: $27 core / $47 calculator + equipment guide + emergency protocols / $97 done-for-you system design / $17 month membership. Platform: Systeme.io free plan. Affiliate layer on all product recommendations.',
        milestones: [
          { label: 'Product brief done', dot: 'var(--pill-done-text)', pill: 'pill-done', pillLabel: 'Done' },
          { label: 'Product stack done (24 worksheets)', dot: 'var(--pill-done-text)', pill: 'pill-done', pillLabel: 'Done' },
          { label: 'Bonus stack done', dot: 'var(--pill-done-text)', pill: 'pill-done', pillLabel: 'Done' },
          { label: 'Funnel live on Systeme.io', dot: 'var(--accent)', pill: 'pill-active', pillLabel: 'Active' },
          { label: 'First sale', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'Mar 2026' },
          { label: 'Ads profitable', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'Upcoming' }
        ]
      },
      lagoon: {
        name: 'Lagoon Company', priority: 'P3', pill: 'pill-active', pillLabel: 'Active',
        agents: ['Rex'],
        callout: 'Activate Piia on company WhatsApp + set up Aitable booking tracking',
        tasks: [
          'Add Piia to Lagoon Company WhatsApp (Beno)',
          'Share Aitable.ai API token (Beno)',
          'Build Aitable booking schema + MC analytics integration (Piia)',
          'Find Facebook Ads account login (Beno)',
          'Monitor yacht ad performance',
          'Google Ads optimisation',
          'Instagram growth - content calendar',
          'Fleet maintenance schedule'
        ],
        context: 'ATV, UTV, scooter, motorcycle, eco-yacht rental company in Tulum. Co-owned: Beno + Dubi + Linea. Primary revenue source since 2021. Booking flow: pre-booking WhatsApp → 10% deposit (Zelle/Wise) → balance day-of → label completed. Eco-yacht on Nopalitos lagoon - only operator in Tulum.',
        milestones: [
          { label: 'Eco-yacht ad live', dot: 'var(--pill-done-text)', pill: 'pill-done', pillLabel: 'Done' },
          { label: 'Piia on company WhatsApp', dot: 'var(--accent)', pill: 'pill-active', pillLabel: 'Active' },
          { label: 'Aitable booking tracking live', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'Upcoming' },
          { label: 'High season prep', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'Dec 2026' }
        ]
      },
      crete: {
        name: 'Hilltop Villa - Oaxaca', priority: 'P4', pill: 'pill-waiting', pillLabel: 'Planning',
        agents: ['Nile'],
        callout: 'Complete site survey and get construction cost estimate',
        tasks: [
          'Schedule site survey with local engineer',
          'Get permit requirements list for Oaxaca coast',
          'Draft floor plan concept',
          'Estimate water + solar needs for the build',
          'Contact local architect',
          'Research Sirewall rammed-earth build costs'
        ],
        context: 'Ocean-view land purchased on Oaxaca coast (Palmarito area, near Casa Wabi). Rammed-earth construction via Sirewall method - Beno completed Sirewall training. Planning phase - need site survey and cost data before committing build budget.',
        milestones: [
          { label: 'Land secured', dot: 'var(--pill-done-text)', pill: 'pill-done', pillLabel: 'Done' },
          { label: 'Sirewall training done', dot: 'var(--pill-done-text)', pill: 'pill-done', pillLabel: 'Done' },
          { label: 'Site survey', dot: 'var(--accent)', pill: 'pill-active', pillLabel: 'Active' },
          { label: 'Cost estimate', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'Upcoming' },
          { label: 'Permit filing', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'Upcoming' }
        ]
      },
      farm: {
        name: 'Farm / Off-Grid', priority: 'P5', pill: 'pill-waiting', pillLabel: 'Planning',
        agents: ['Nile'],
        callout: 'Finalize solar + battery system design and poultry housing plan',
        tasks: [
          'Calculate daily power consumption for farm',
          'Design LiFePO4 battery bank + solar array',
          'Get solar panel + battery quotes',
          'Plan Cornish Cross poultry housing layout',
          'Design rainwater collection system',
          'Source local feed suppliers in Oaxaca',
          'Map irrigation zones'
        ],
        context: 'Ranch land acquired in Oaxaca. Off-grid farm with Cornish Cross poultry, solar + LiFePO4 battery system, rainwater collection. Moving to Puerto Escondido area May 2026 - farm development follows.',
        milestones: [
          { label: 'Land acquired', dot: 'var(--pill-done-text)', pill: 'pill-done', pillLabel: 'Done' },
          { label: 'Solar + battery design', dot: 'var(--accent)', pill: 'pill-active', pillLabel: 'Active' },
          { label: 'Poultry setup', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'Upcoming' },
          { label: 'Water system', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'Upcoming' }
        ]
      },
      app: {
        name: 'App Development', priority: 'P6', pill: 'pill-backlog', pillLabel: 'Idea',
        agents: ['Zara'],
        callout: 'Validate market demand before writing a single line of code',
        tasks: [
          'Draft farmer interview questionnaire',
          'Identify 20 target farmers in Puerto Escondido area',
          'Conduct field interviews post-move (May 2026+)',
          'Analyse interview data',
          'Define MVP feature list',
          'Choose tech stack',
          'Sketch wireframes'
        ],
        context: 'Direct-to-customer app connecting farmers in Puerto Escondido with local buyers. Early idea stage - validation first. Moving to the area May 2026 makes field research possible. No building until demand is proven.',
        milestones: [
          { label: 'Concept defined', dot: 'var(--pill-done-text)', pill: 'pill-done', pillLabel: 'Done' },
          { label: 'Market validation', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'May 2026+' },
          { label: 'MVP scope defined', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'Upcoming' },
          { label: 'Build starts', dot: 'var(--text-3)', pill: 'pill-backlog', pillLabel: 'Upcoming' }
        ]
      }
    };

    function renderFocusProject(key) {
      var p = focusProjects[key];
      var container = document.getElementById('focus-content');
      if (!p || !container) return;
      var html = '';

      html += '<div class="focus-header">';
      html += '<span class="project-priority">' + p.priority + '</span>';
      html += '<span class="focus-title">' + p.name + '</span>';
      html += '<span class="pill ' + p.pill + '">' + p.pillLabel + '</span>';
      html += '</div>';

      html += '<div class="focus-agents">';
      p.agents.forEach(function(a) { html += '<span class="agent-chip">' + agentAvatar(a, 'agent-avatar-sm') + ' ' + a + '</span>'; });
      html += '</div>';

      html += '<div class="focus-priority">' + p.callout + '</div>';

      html += '<ul class="focus-tasks">';
      p.tasks.forEach(function(t, i) {
        var id = 'focus-' + key + '-' + i;
        html += '<label class="focus-task"><input type="checkbox" class="focus-check" id="' + id + '"><span class="focus-checkmark"></span><span class="focus-task-text">' + t + '</span></label>';
      });
      html += '</ul>';

      html += '<div class="focus-context">' + p.context + '</div>';

      html += '<div class="focus-milestones">';
      p.milestones.forEach(function(m) {
        html += '<div class="focus-milestone"><span class="focus-ms-dot" style="background:' + m.dot + '"></span><span class="focus-ms-label">' + m.label + '</span><span class="pill ' + m.pill + '">' + m.pillLabel + '</span></div>';
      });
      html += '</div>';

      container.innerHTML = html;
    }

    var focusSelect = document.getElementById('focus-project-select');
    if (focusSelect) {
      focusSelect.addEventListener('change', function() {
        renderFocusProject(focusSelect.value);
        try { localStorage.setItem('mc-focus-project', focusSelect.value); } catch(e) {}
      });
      var savedFocus = null;
      try { savedFocus = localStorage.getItem('mc-focus-project'); } catch(e) {}
      var initFocus = (savedFocus && focusSelect.querySelector('option[value="' + savedFocus + '"]')) ? savedFocus : 'ofm';
      focusSelect.value = initFocus;
      renderFocusProject(initFocus);
    }

    // ── Memory tab: search filter ──
    var memSearchInput = document.getElementById('mem-search-input');
    if (memSearchInput) {
      memSearchInput.addEventListener('input', function() {
        var query = memSearchInput.value.toLowerCase().trim();
        var cards = document.querySelectorAll('.mem-card');
        cards.forEach(function(card) {
          if (!query) {
            card.classList.remove('mem-card-dim');
            return;
          }
          var text = (card.getAttribute('data-mem-text') || '') + ' ' + card.textContent;
          if (text.toLowerCase().indexOf(query) !== -1) {
            card.classList.remove('mem-card-dim');
          } else {
            card.classList.add('mem-card-dim');
          }
        });
      });
    }

    /* ---- IntersectionObserver: Scroll Reveal ---- */
    revealObserver = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          entry.target.classList.add('revealed');
          revealObserver.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });

    // Observe all reveal elements in the initially active panel
    document.querySelectorAll('.tab-panel.active .reveal').forEach(function(el) {
      revealObserver.observe(el);
    });

    // Also observe any reveal elements not inside a tab-panel (top-level)
    document.querySelectorAll('.reveal:not(.tab-panel .reveal)').forEach(function(el) {
      revealObserver.observe(el);
    });

    /* ---- Keyboard Shortcut Tooltip ---- */
    var hint = document.getElementById('shortcut-hint');
    if (hint) {
      setTimeout(function() { hint.classList.add('visible'); }, 500);
      setTimeout(function() { hint.classList.remove('visible'); }, 3500);
    }
  </script>
</body>
</html>
